<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michelle Gelman">
<meta name="dcterms.date" content="2025-05-15">

<title>Fine-Tuning Kodis Analysis – Weekly ConvoKit Updates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Weekly ConvoKit Updates</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Current</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../src/fine-tuning_final.html"> 
<span class="menu-text">Fine-Tuning Kodis</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#fine-tuning-configuration" id="toc-fine-tuning-configuration" class="nav-link active" data-scroll-target="#fine-tuning-configuration">Fine-Tuning Configuration:</a>
  <ul class="collapse">
  <li><a href="#data-splits" id="toc-data-splits" class="nav-link" data-scroll-target="#data-splits"><strong>1. Data &amp; Splits</strong></a></li>
  <li><a href="#model-configuration" id="toc-model-configuration" class="nav-link" data-scroll-target="#model-configuration"><strong>2. Model Configuration</strong></a></li>
  <li><a href="#forecaster-training-configuration" id="toc-forecaster-training-configuration" class="nav-link" data-scroll-target="#forecaster-training-configuration"><strong>3. Forecaster Training Configuration</strong></a></li>
  <li><a href="#evaluation-aggregation" id="toc-evaluation-aggregation" class="nav-link" data-scroll-target="#evaluation-aggregation"><strong>5. Evaluation &amp; Aggregation</strong></a></li>
  </ul></li>
  <li><a href="#current-interpretation" id="toc-current-interpretation" class="nav-link" data-scroll-target="#current-interpretation">Current Interpretation:</a>
  <ul class="collapse">
  <li><a href="#improvement-considerations" id="toc-improvement-considerations" class="nav-link" data-scroll-target="#improvement-considerations">Improvement Considerations:</a></li>
  <li><a href="#design-decisions" id="toc-design-decisions" class="nav-link" data-scroll-target="#design-decisions">Design Decisions:</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">TODO:</a></li>
  </ul></li>
  <li><a href="#comparison-of-metrics-for-all-model-variants-using-best-threshhold" id="toc-comparison-of-metrics-for-all-model-variants-using-best-threshhold" class="nav-link" data-scroll-target="#comparison-of-metrics-for-all-model-variants-using-best-threshhold">Comparison of Metrics for all Model variants using Best Threshhold</a></li>
  <li><a href="#differences-in-distributed-probabilities" id="toc-differences-in-distributed-probabilities" class="nav-link" data-scroll-target="#differences-in-distributed-probabilities">Differences in Distributed Probabilities</a>
  <ul class="collapse">
  <li><a href="#model-sensitivity-of-probability-forecast-to-downsampling" id="toc-model-sensitivity-of-probability-forecast-to-downsampling" class="nav-link" data-scroll-target="#model-sensitivity-of-probability-forecast-to-downsampling">Model Sensitivity of Probability Forecast to Downsampling</a></li>
  <li><a href="#model-sensitivity-of-probability-forecast-to-utterance-variability" id="toc-model-sensitivity-of-probability-forecast-to-utterance-variability" class="nav-link" data-scroll-target="#model-sensitivity-of-probability-forecast-to-utterance-variability">Model Sensitivity of Probability Forecast to Utterance Variability</a></li>
  </ul></li>
  <li><a href="#misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" id="toc-misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" class="nav-link" data-scroll-target="#misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling">Misclassified Texts Analysis: No Last Utterance No Submit with Downsampling</a>
  <ul class="collapse">
  <li><a href="#example-misclassified-conversation" id="toc-example-misclassified-conversation" class="nav-link" data-scroll-target="#example-misclassified-conversation">Example Misclassified Conversation</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Utterance Level)</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Conversation Level)</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Derailment for No Last No Submit Agreement Downsampled Model (Utterance Level)</a></li>
  </ul></li>
  <li><a href="#predicition-evolution-overtime" id="toc-predicition-evolution-overtime" class="nav-link" data-scroll-target="#predicition-evolution-overtime">Predicition Evolution Overtime</a>
  <ul class="collapse">
  <li><a href="#ground-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  </ul></li>
  <li><a href="#frustration-correlation" id="toc-frustration-correlation" class="nav-link" data-scroll-target="#frustration-correlation">Frustration Correlation</a>
  <ul class="collapse">
  <li><a href="#no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last Downsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  <li><a href="#no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last No SubmitDownsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  <li><a href="#ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">Ground Wiki: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  </ul></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions">Utility Functions</a>
  <ul class="collapse">
  <li><a href="#convokit-transformers" id="toc-convokit-transformers" class="nav-link" data-scroll-target="#convokit-transformers">ConvoKit Transformers</a></li>
  <li><a href="#metric-and-plotting-functions" id="toc-metric-and-plotting-functions" class="nav-link" data-scroll-target="#metric-and-plotting-functions">Metric and Plotting Functions</a></li>
  <li><a href="#conversation-utilities" id="toc-conversation-utilities" class="nav-link" data-scroll-target="#conversation-utilities">Conversation Utilities</a></li>
  <li><a href="#fighting-words" id="toc-fighting-words" class="nav-link" data-scroll-target="#fighting-words">Fighting Words</a></li>
  <li><a href="#fighting-words-by-conversation" id="toc-fighting-words-by-conversation" class="nav-link" data-scroll-target="#fighting-words-by-conversation">Fighting Words By conversation</a></li>
  <li><a href="#forecasting-trends" id="toc-forecasting-trends" class="nav-link" data-scroll-target="#forecasting-trends">Forecasting Trends</a></li>
  <li><a href="#wiki-ground-functions" id="toc-wiki-ground-functions" class="nav-link" data-scroll-target="#wiki-ground-functions">Wiki Ground Functions</a></li>
  <li><a href="#frustration-correlation-1" id="toc-frustration-correlation-1" class="nav-link" data-scroll-target="#frustration-correlation-1">Frustration Correlation</a></li>
  <li><a href="#loading-artifacts-utilities" id="toc-loading-artifacts-utilities" class="nav-link" data-scroll-target="#loading-artifacts-utilities">Loading Artifacts Utilities</a></li>
  <li><a href="#load-artifacts" id="toc-load-artifacts" class="nav-link" data-scroll-target="#load-artifacts">Load Artifacts</a></li>
  <li><a href="#utterance-variants" id="toc-utterance-variants" class="nav-link" data-scroll-target="#utterance-variants">Utterance Variants</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fine-Tuning Kodis Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michelle Gelman </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="cell-1" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint <span class="im">as</span> pp</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> entropy</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    roc_curve,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    roc_auc_score,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    average_precision_score,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> modules.DataPreprocesser <span class="im">import</span> DataPreprocesser</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> modules <span class="im">import</span> CorpusUtils <span class="im">as</span> corp</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Convokit Imports</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.CRAFTModel <span class="im">import</span> CRAFTModel</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.forecaster <span class="im">import</span> Forecaster</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> download, Corpus</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> Corpus, Speaker, Utterance, Conversation</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.convokitConfig <span class="im">import</span> ConvoKitConfig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-2" class="cell" data-execution_count="203">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>downpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_ground_downsampled"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>defaultpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_run/corpus_kodis_ground_default"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>weights_path <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/weighted_run/corpus_kodis_ground_weighted_loss"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>corpus_down <span class="op">=</span> Corpus(filename<span class="op">=</span>downpath)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>corpus_default <span class="op">=</span> Corpus(filename<span class="op">=</span>defaultpath)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>corpus_weighted <span class="op">=</span> Corpus(filename<span class="op">=</span>weights_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="fine-tuning-configuration" class="level1">
<h1>Fine-Tuning Configuration:</h1>
<ul>
<li><a href="">Forecaster Model</a></li>
</ul>
<section id="data-splits" class="level3">
<h3 class="anchored" data-anchor-id="data-splits"><strong>1. Data &amp; Splits</strong></h3>
<ul>
<li>Corpus: 2,107 buyer–seller disputes. No AI.</li>
<li>Train/Val/Test: 60/20/20 split (≈ 1,264 / 421 / 421 conversations).
<ul>
<li>random-seed: 42 (for reproducibility)</li>
</ul></li>
</ul>
</section>
<section id="model-configuration" class="level3">
<h3 class="anchored" data-anchor-id="model-configuration"><strong>2. Model Configuration</strong></h3>
<section id="total-models-fine-tuned-9-3x3-fine-tuned-model-configurations-paired-as-imbalance-variant-x-context-selection" class="level4">
<h4 class="anchored" data-anchor-id="total-models-fine-tuned-9-3x3-fine-tuned-model-configurations-paired-as-imbalance-variant-x-context-selection"><strong>Total models fine-tuned:</strong> 9 (3x3) fine-tuned model configurations, paired as (imbalance variant x context-selection)</h4>
</section>
<section id="baseline-fine-tuned-pre-trained-wiki-fine-tuned-model" class="level4">
<h4 class="anchored" data-anchor-id="baseline-fine-tuned-pre-trained-wiki-fine-tuned-model"><strong>Baseline fine-tuned:</strong> Pre-trained wiki fine-tuned model</h4>
<ul>
<li>Base model parameters: pre-wiki trained CRAFT model</li>
<li>vocabulary size (tokenization): <a href="https://colab.research.google.com/drive/1GvICZN0VwZQSWw3pJaEVY-EQGoO-L5lH?utm_source=chatgpt.com">50004: it was built using a fixed vocab size of 50k plus 4 spots for special tokens PAD, SOS, EOS, and UNK</a></li>
<li>Conversation-selection Training Logic: last context-tuple (entire conversation history up to last utterance) for all conversations</li>
</ul>
<p><strong>DEFAULT_CONFIG from CRAFT backend</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Parameter</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dropout</td>
<td>0.1</td>
</tr>
<tr class="even">
<td>batch_size</td>
<td>64</td>
</tr>
<tr class="odd">
<td>clip</td>
<td>50.0</td>
</tr>
<tr class="even">
<td>learning_rate</td>
<td>1e-5</td>
</tr>
<tr class="odd">
<td>print_every</td>
<td>10</td>
</tr>
<tr class="even">
<td>finetune_epochs</td>
<td>30</td>
</tr>
<tr class="odd">
<td>validation_size</td>
<td>0.2</td>
</tr>
</tbody>
</table>
</section>
<section id="training-set-preprocessing-variants" class="level4">
<h4 class="anchored" data-anchor-id="training-set-preprocessing-variants"><strong>2.1. Training Set Preprocessing Variants</strong></h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 81%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Variant</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Ground</strong></td>
<td>All utterances up to (and including) the final one marked as derailment</td>
</tr>
<tr class="even">
<td><strong>No‑Last</strong></td>
<td>All utterances except the final comment (i.e.&nbsp;drop the last utterance)</td>
</tr>
<tr class="odd">
<td><strong>No‑Last‑No‑Submit</strong></td>
<td>As <strong>No‑Last</strong>, plus remove any “Submitted agreement” system messages from the remaining text</td>
</tr>
</tbody>
</table>
</section>
<section id="class-imbalance-variants-variants" class="level4">
<h4 class="anchored" data-anchor-id="class-imbalance-variants-variants"><strong>2.2. Class Imbalance Variants Variants</strong></h4>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 51%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Regime</th>
<th>Loss</th>
<th>Sampling</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Default</strong></td>
<td>Standard binary cross‐entropy (BCE)</td>
<td>Original class imbalance (~371 derail vs.&nbsp;1,734 clean)</td>
</tr>
<tr class="even">
<td><strong>Weighted</strong></td>
<td>BCE with class‐weighted loss (higher weight on the minority “derail” class)</td>
<td>Original class imbalance (~371 derail vs.&nbsp;1,734 clean)</td>
</tr>
<tr class="odd">
<td><strong>Downsampled</strong></td>
<td>BCE, but training set downsampled to a 1:1 class ratio</td>
<td>371 / 371 train examples</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="forecaster-training-configuration" class="level3">
<h3 class="anchored" data-anchor-id="forecaster-training-configuration"><strong>3. Forecaster Training Configuration</strong></h3>
<section id="number-of-runs-9-total.-1-for-each-variant-with-same-traintestsplit-seed-42" class="level4">
<h4 class="anchored" data-anchor-id="number-of-runs-9-total.-1-for-each-variant-with-same-traintestsplit-seed-42"><strong>Number of Runs</strong>: 9 total. 1 for each variant with same train/test/split seed (42)</h4>
<ul>
<li><strong>Forecaster:</strong> uses CRAFT Backend, writes conversation.meta[“prediction”] (0/1) and meta[“pred_score”] (probability) for all utterances in training set variants</li>
<li><strong>Default threshold:</strong> 0.54 for binary decision in any utterance to classifiy conversation as impasse (1)</li>
<li><strong>Optimized threshold</strong>: per‐variant “best” threshold chosen via Youden’s J (maximize TPR – FPR) on the test set from conversation-level AUC/PR Curves across variants</li>
</ul>
</section>
</section>
<section id="evaluation-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-aggregation"><strong>5. Evaluation &amp; Aggregation</strong></h3>
<section id="evaluation-test-set-421-convsersations.-uses-original-ground-variant." class="level4">
<h4 class="anchored" data-anchor-id="evaluation-test-set-421-convsersations.-uses-original-ground-variant."><strong>Evaluation:</strong> Test Set (421 Convsersations). Uses Original Ground Variant.</h4>
</section>
<section id="initial-analysis" class="level4">
<h4 class="anchored" data-anchor-id="initial-analysis"><strong>5.1. Initial Analysis</strong></h4>
<ul>
<li>Accuracy, Precision, Recall (TPR), FPR, F1</li>
<li>AUC / PR curves (using max pred_score from each conversation)</li>
<li>Horizon plots: aggregate utterance‐position forecast scores to visualize how early derailment is detected.</li>
</ul>
</section>
<section id="secondary-analysis" class="level4">
<h4 class="anchored" data-anchor-id="secondary-analysis"><strong>5.2. Secondary Analysis</strong></h4>
<ul>
<li><strong>Best‐Threshold Performance</strong>(accuracy, TPR, FPR, F1, J index, threshold)</li>
<li><strong>Probability Evolution Trends Over Conversational Contexts:</strong> Overlay variants (Default / Weighted / Downsampled / Wiki) for each context.</li>
<li><strong>Self‑report Avg. Frustration CVorrelation with Max Prediction:</strong> Pearson r and linear regression (R²) Between each convo’s max_pred_score (highest utterance probability) and its avg_frustration_score.</li>
<li><strong>Probability Score Distribution:</strong> Explore sensitivity of probability scores across utterances for models, controlling for imbalance or training set variants</li>
<li><strong>Fighing Words:</strong> Comparing <a href="https://www.cambridge.org/core/journals/political-analysis/article/fightin-words-lexical-feature-selection-and-evaluation-for-identifying-the-content-of-political-conflict/81B3703230D21620B81EB6E2266C7A66">Fighting words</a> between Misclassified True Derailed Conversations class and Correctly Classified Successful Conversations class
<ul>
<li>Comparing n-gram log-odds ratio versus frequency of word on per utterance and per conversation basis</li>
<li>Using vocabulary generated stricly from all classes (not entire corpus). Default prior (occ. of n-gram) set to .1 as default</li>
<li>Y-axis: Prevalance of word within the Class. negative = class2, positive = class1</li>
<li>X- axis: Occurence of n-gram within associated class.</li>
<li>Z-score: tells you how many “standard deviations” away from zero the log‑odds difference is. Comparing “class 1 vs.&nbsp;class 2” directly</li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="current-interpretation" class="level1">
<h1>Current Interpretation:</h1>
<ul>
<li>Want to know how to better analyze mispredictions
<ul>
<li>Fighting Words unclear still. Tried training vocabulary both on entire corpus and on just chosesn TP/FP/TN/FP Subsets. Vary n-gram (length of phrases). Unsure aout whether or not to include stopping_words or use priors from entire corpus</li>
</ul></li>
<li>Ground wiki picked up high best decision threshold (.88), while most others around .55-.75</li>
<li>No submit no last variants most similar to ground_wiki in terms of confusion matrix and metrics(theshold as well, .75)</li>
<li>Weighted variants overfitting I think. All Impasse mispredicted as success.</li>
<li>No last no submit closest to ground wiki model. Also has similar utterance aggregtaed prediction score trends across impasse and success dialogues</li>
<li>The few downsampling training runs had high accuracy variablitiy (27% to 80%) meaning fine-tuning is not entirely reproducible despite controlling for same training/test/split</li>
<li>AUC/PR curved looked good (better than baseline for all model)</li>
<li>caviaates to having high prediction threshold? ## Goals:</li>
<li>Define conference target and paper goals to guide interpretation and futher testing</li>
<li>Define characteristics of derailment for dispute-type dialogue</li>
<li>What does the model pick up in a dispute to forecast derailment when predicting probability over-time</li>
</ul>
<section id="improvement-considerations" class="level2">
<h2 class="anchored" data-anchor-id="improvement-considerations">Improvement Considerations:</h2>
<ul>
<li>Including Learning‑rate scheduling or early stopping to stop training early when it converges to prevent overfitting/underfitting</li>
<li>full-end to end training with testing model_config parameters to improve metrics</li>
</ul>
</section>
<section id="design-decisions" class="level2">
<h2 class="anchored" data-anchor-id="design-decisions">Design Decisions:</h2>
<ul>
<li>Do we include submit agreements or no? Lose out on potential dispute dynamics with chains of submit agreements</li>
<li>test on ground kodis conversations?</li>
<li>Revalant Analysis considerations?</li>
<li>sentiment granularity: comparing utterance level predicitons with conversational-leel self-report scores</li>
<li>predicting SVI (self, fairness, outcome, relationships). Predict Frustration?</li>
</ul>
</section>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO:</h2>
<ul>
<li>Go over CARC tutortial + set up GPU</li>
<li>Predict SVI (relationships, frustration, outcome, impasse)</li>
</ul>
</section>
</section>
<section id="comparison-of-metrics-for-all-model-variants-using-best-threshhold" class="level1">
<h1>Comparison of Metrics for all Model variants using Best Threshhold</h1>
<div id="cell-6" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ground_thresholds, ground_metrics, ground_corpora <span class="op">=</span> compare_craft_models(corpora_info_ground)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>no_last_thresholds, no_last_metrics, no_last_corpora <span class="op">=</span> compare_craft_models(corpora_info_no_last)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>no_subm_thresholds, no_subm_metrics, no_subm_corpora <span class="op">=</span> compare_craft_models(corpora_info_no_subm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-7" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>allmetrics <span class="op">=</span> {}</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>allmetrics.update(ground_metrics)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>allmetrics.update(no_last_metrics)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>allmetrics.update(no_subm_metrics)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>allcorpora <span class="op">=</span> {}</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>allcorpora.update(ground_corpora)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>allcorpora.update(no_last_corpora)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>allcorpora.update(no_subm_corpora)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>compare_best_model_metrics(allmetrics, ground_corpora)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion(ground_thresholds, ground_metrics, ground_corpora)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion(no_last_thresholds, ground_metrics,  no_last_corpora)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion( no_subm_thresholds, no_subm_metrics, no_subm_corpora)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Conversation‑level Best Threshold Test Set Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
<th data-quarto-table-cell-role="th">Best Threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DEFAULT</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.541032</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.575249</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED</td>
<td>0.850711</td>
<td>0.556818</td>
<td>0.671233</td>
<td>0.111748</td>
<td>0.608696</td>
<td>0.580783</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.749409</td>
<td>0.374046</td>
<td>0.671233</td>
<td>0.234286</td>
<td>0.480392</td>
<td>0.885502</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DEFAULT</td>
<td>0.535545</td>
<td>0.226667</td>
<td>0.698630</td>
<td>0.498567</td>
<td>0.342282</td>
<td>0.555385</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.576696</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED</td>
<td>0.431280</td>
<td>0.218855</td>
<td>0.890411</td>
<td>0.664756</td>
<td>0.351351</td>
<td>0.559719</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT</td>
<td>0.696682</td>
<td>0.337278</td>
<td>0.780822</td>
<td>0.320917</td>
<td>0.471074</td>
<td>0.521406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED</td>
<td>0.739336</td>
<td>0.366906</td>
<td>0.698630</td>
<td>0.252149</td>
<td>0.481132</td>
<td>0.497068</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED</td>
<td>0.765403</td>
<td>0.404412</td>
<td>0.753425</td>
<td>0.232092</td>
<td>0.526316</td>
<td>0.757998</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
</div>
</section>
<section id="differences-in-distributed-probabilities" class="level1">
<h1>Differences in Distributed Probabilities</h1>
<div id="cell-9" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>all_corpora_by_downsampling_comp <span class="op">=</span> [corpora_info_ground, corpora_info_no_last, corpora_info_no_subm]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>all_corpora_by_utterance_comp <span class="op">=</span> [corpora_info_no_sampling, corpora_info_downsampled, corpora_info_weighted]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="model-sensitivity-of-probability-forecast-to-downsampling" class="level3">
<h3 class="anchored" data-anchor-id="model-sensitivity-of-probability-forecast-to-downsampling">Model Sensitivity of Probability Forecast to Downsampling</h3>
<div id="cell-11" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>compare_best_model_convo_histograms(all_corpora_by_downsampling_comp, title_key<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-sensitivity-of-probability-forecast-to-utterance-variability" class="level3">
<h3 class="anchored" data-anchor-id="model-sensitivity-of-probability-forecast-to-utterance-variability">Model Sensitivity of Probability Forecast to Utterance Variability</h3>
<div id="cell-13" class="cell" data-execution_count="206">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>compare_best_model_convo_histograms(all_corpora_by_utterance_comp, title_key<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" class="level1">
<h1>Misclassified Texts Analysis: No Last Utterance No Submit with Downsampling</h1>
<div id="cell-15" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred <span class="op">=</span> no_last_downsampled_mispred.filter_conversations_by(selector<span class="op">=</span> convo_selector)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_mispred, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred<span class="op">=</span> no_last_downsampled_mispred.filter_conversations_by(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"best_forecast"</span>) <span class="op">!=</span> convo.meta.get(<span class="st">"label"</span>))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true <span class="op">=</span> no_last_downsampled_true.filter_conversations_by(selector<span class="op">=</span> convo_selector)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_true, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true<span class="op">=</span> no_last_downsampled_true.filter_conversations_by(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"best_forecast"</span>) <span class="op">==</span> convo.meta.get(<span class="st">"label"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="example-misclassified-conversation" class="level3">
<h3 class="anchored" data-anchor-id="example-misclassified-conversation">Example Misclassified Conversation</h3>
<div id="cell-17" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>print_conversation(no_last_downsampled_mispred, <span class="st">"utt0_con67"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buyer_67: You know the site was advertising a Kobe Bryant jersey so that's what I should be still entitled to receive.
Seller_67: Hello, I'm sorry but I think there was misunderstanding. The jersey that I was selling wasn't for any particular player.
Buyer_67: You had originally stated that it was a Bryant jersey, no one would have bought it for the second rate player that is on the jersey you set me.
Seller_67: I never stated that, nor have I ever talked to you. You simply purchased the jersey and I sent it to you. I am willing to work with you if you're that unhappy, but you have to understand where I am coming from too.
Buyer_67: The advertising stated that I know I wasn't talking to you directly are you willing to refund me for the purchase?
Seller_67: No, I can't refund you. You purchased the jersey under the listing that never stated any particular name. Are you able to review the listing again?
Buyer_67: You've conveniently altered the listing so that it indicates no specific player, the original listing, did in fact state it was for a Kobe Bryant jersey.
Seller_67: That's not possible for me to alter the listing. The listing is the same as the one you purchased. I can see how you could have misread or thought it was a specific player. So, If you apologize I will apologize as well.
Buyer_67: I'll accept the retraction of your bad review, I don't need the unwarranted hit to my rep.
Seller_67: Okay, I will also apologize for the misunderstanding with the listing and next time I will provide a clear detail in the listings for future customers.
Buyer_67: Thank you that's fine
Seller_67: Will you please also retract the bad review that you wrote me?
Buyer_67: I will, this one time, but if you try that kind of deal again I'm going to screen print the original screen it and let the site know what you're up to.
Seller_67: It was never my intention to deceive anyone. I apologize for the misunderstanding and wish you a good rest of your week.
Buyer_67: Submitted agreement: Buyer gets no refund, buyer retracted their review, seller kept their review, buyer did apologize, and seller didn't apologize.
Seller_67: Reject Deal
Seller_67: Submitted agreement: Buyer gets no refund, buyer retracted their review, seller retracted their review, buyer did apologize, and seller didn't apologize.
Buyer_67: Accept Deal</code></pre>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Utterance Level)</h3>
<div id="cell-19" class="cell" data-execution_count="182">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display(no_last_downsampled.get_utterances_dataframe()[["text", "meta.pred_score"]])</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_fr <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_fr, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>f_model, z_df_utt<span class="op">=</span> analyze_mispredicted_fighting_words(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"false_pos_true_neg"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>display(z_df_utt.head(<span class="dv">10</span>)) </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>display(z_df_utt.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 3157 valid corpus components. class2_func returned 1369 valid corpus components.
Vocab size is 684
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">deal</td>
<td>-6.718907</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">yes</td>
<td>-6.428303</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">thank</td>
<td>-6.114948</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">broken</td>
<td>-5.905448</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bad review</td>
<td>-5.232216</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">retract bad review</td>
<td>-4.881626</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">retract bad</td>
<td>-4.874775</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ok</td>
<td>-4.812029</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">accept deal</td>
<td>-4.678088</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bad</td>
<td>-4.660040</td>
<td>True Success</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">listing</td>
<td>3.131796</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">specific</td>
<td>3.138968</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant jersey</td>
<td>4.292191</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant jersey</td>
<td>4.718836</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">website</td>
<td>5.338543</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">player</td>
<td>5.492360</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant</td>
<td>5.771620</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kobe</td>
<td>6.207311</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bryant</td>
<td>6.473314</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">jersey</td>
<td>9.604167</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Conversation Level)</h3>
<div id="cell-21" class="cell" data-execution_count="181">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>f_model, z_df_conv <span class="op">=</span> analyze_mispredicted_fighting_words_by_conversation(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"false_pos_true_neg"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.head(<span class="dv">10</span>)) </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 232 valid corpus components. class2_func returned 117 valid corpus components.
Vocab size is 1999
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">yes</td>
<td>-6.535231</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">broken</td>
<td>-5.965318</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">much</td>
<td>-5.362650</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ok</td>
<td>-4.909162</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">okay</td>
<td>-4.537755</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the buyer</td>
<td>-4.356455</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bad review of</td>
<td>-4.352271</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">retract</td>
<td>-4.268908</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">so much</td>
<td>-4.220469</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">review of</td>
<td>-4.212235</td>
<td>True Success</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">that you</td>
<td>3.516404</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the website</td>
<td>3.684440</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant jersey</td>
<td>4.182163</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant jersey</td>
<td>4.554592</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">website</td>
<td>5.241377</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">player</td>
<td>5.401609</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant</td>
<td>5.695863</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kobe</td>
<td>6.078845</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">the jersey</td>
<td>6.101230</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant</td>
<td>6.393911</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Derailment for No Last No Submit Agreement Downsampled Model (Utterance Level)</h3>
<div id="076430c6" class="cell" data-execution_count="184">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>f_model, z_df_conv <span class="op">=</span> analyze_mispredicted_fighting_words_by_conversation(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"true_pos_false_pos"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.head(<span class="dv">10</span>)) </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 65 valid corpus components. class2_func returned 232 valid corpus components.
Vocab size is 2013
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">thank</td>
<td>-5.749773</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">thank you</td>
<td>-5.718247</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">apologize</td>
<td>-5.336655</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">thank you for</td>
<td>-3.687553</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">apologize for</td>
<td>-3.622634</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">for the</td>
<td>-3.569466</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">retract the</td>
<td>-3.504892</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">you for</td>
<td>-3.339534</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">us</td>
<td>-3.280998</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the bad</td>
<td>-3.234680</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">dishonest</td>
<td>4.315086</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sales are final</td>
<td>4.431480</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sales are</td>
<td>4.605759</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">lying</td>
<td>4.759982</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">all</td>
<td>5.001141</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">you are</td>
<td>5.133342</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sales</td>
<td>5.317728</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">walk</td>
<td>5.562037</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">walk away</td>
<td>5.562037</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">away</td>
<td>9.649999</td>
<td>True Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="predicition-evolution-overtime" class="level1">
<h1>Predicition Evolution Overtime</h1>
<section id="ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="9d3e92e2" class="cell" data-execution_count="148">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Default"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Downsampled"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Weighted"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-14-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="163604a2" class="cell" data-execution_count="149">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Default"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Downsampled"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Weighted"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-15-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-15-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="a1b7d3c8" class="cell" data-execution_count="150">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Default"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Downsampled"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Weighted"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-16-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="frustration-correlation" class="level1">
<h1>Frustration Correlation</h1>
<section id="no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last Downsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="764e34f9" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.7579975724220276</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(no_last_downsampled_fr)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_downsampled_fr)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_downsampled_fr)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#display(no_last_downsampled_fr.get_conversations_dataframe())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e2e0eb51" class="cell" data-execution_count="171">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(no_last_downsampled_fr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 358</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last No SubmitDownsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="8b579aec" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>no_last_submit_downsampled <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_submit_downsampled'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_submit_downsampled, threshold<span class="op">=</span><span class="fl">0.7579975724220276</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(no_last_submit_downsampled)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_submit_downsampled)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># display(no_last_submit_downsampled.get_conversations_dataframe())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="20b09d2b" class="cell" data-execution_count="176">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(no_last_submit_downsampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 358</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-20-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">Ground Wiki: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="8889af06" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>wiki_corp <span class="op">=</span> corpus_kodis_ground_orig</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(wiki_corp, threshold<span class="op">=</span><span class="fl">0.7579975724220276</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(wiki_corp)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(wiki_corp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="87a98666" class="cell" data-execution_count="179">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(wiki_corp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 359</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="utility-functions" class="level1">
<h1>Utility Functions</h1>
<section id="convokit-transformers" class="level3">
<h3 class="anchored" data-anchor-id="convokit-transformers">ConvoKit Transformers</h3>
</section>
<section id="metric-and-plotting-functions" class="level3">
<h3 class="anchored" data-anchor-id="metric-and-plotting-functions">Metric and Plotting Functions</h3>
<div id="cell-44" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Callable</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    roc_curve, roc_auc_score,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve, average_precision_score,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_best_threshold(y_true, y_score):</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the threshold that maximizes Youden's J = TPR − FPR.</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresh <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    youden <span class="op">=</span> tpr <span class="op">-</span> fpr</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    idx    <span class="op">=</span> np.argmax(youden)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresh[idx], tpr[idx], fpr[idx], youden[idx]</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_best_threshold(corpus, threshold, prob_key<span class="op">=</span> <span class="st">"pred_score"</span>, best_pred_key<span class="op">=</span> <span class="st">"best_prediction"</span>,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    best_label_key<span class="op">=</span> <span class="st">"best_forecast"</span>, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        any_pos <span class="op">=</span> <span class="va">False</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances():</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key, <span class="fl">0.0</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>            pred  <span class="op">=</span> <span class="bu">int</span>(score <span class="op">&gt;=</span> threshold)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>            utt.meta[best_pred_key] <span class="op">=</span> pred</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pred:</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>                any_pos <span class="op">=</span> <span class="va">True</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>        convo.meta[best_label_key] <span class="op">=</span> <span class="bu">int</span>(any_pos)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> horizon(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>        comments_until_end <span class="op">=</span> {}</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> selector(convo) <span class="kw">and</span> convo.meta[<span class="st">"best_forecast"</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.get_chronological_utterance_list()):</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>                    prediction <span class="op">=</span> utt.meta[<span class="st">"best_prediction"</span>]</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> prediction <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>                        comments_until_end[convo.<span class="bu">id</span>] <span class="op">=</span> (</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">len</span>(convo.get_chronological_utterance_list()) <span class="op">-</span> i</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> comments_until_end</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co">"""Taken + modified from forecaster class"""</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>, threshold <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> corpus.get_conversations_dataframe(selector<span class="op">=</span>selector)</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>         <span class="co"># counts</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>        tp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>        fp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>        tn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>        fn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># accuracy is always well‑defined</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>        acc <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precision, recall, fpr guard against zero‐denom</span></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>        recall    <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>        fpr       <span class="op">=</span> fp <span class="op">/</span> (fp <span class="op">+</span> tn) <span class="cf">if</span> (fp <span class="op">+</span> tn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># F1 = 2 * (precision * recall) / (precision + recall)</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>        f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall) <span class="cf">if</span> (precision <span class="op">+</span> recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Accuracy"</span>:  acc,</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Precision"</span>: precision,</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Recall"</span>:    recall,</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FPR"</span>:       fpr,</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"F1"</span>:        f1,</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Best Threshold"</span>: threshold,}</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_confusion_matrices(corpora_info):</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    names, corpora, metrics_list, dfs, horizons <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>,<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merged.join(</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>            df[[<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>            ), how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) confusion matrices</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>))</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_craft_models(corpora_info, split_key<span class="op">=</span><span class="st">"split"</span>, train_tag<span class="op">=</span><span class="st">"train"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>, best<span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a><span class="co">    corpora_info: list of (name, Corpus, metrics_dict, conv_df, horizon_dict)</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>    names, corpora, metrics_list, dfs, horizons <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) avg lengths</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Avg. Conversation Length =="</span>)</span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus <span class="kw">in</span> <span class="bu">zip</span>(names, corpora):</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>        train_lens <span class="op">=</span> [</span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>train_tag</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>        test_lens  <span class="op">=</span> [</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>test_tag</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss">  train=</span><span class="sc">{</span>np<span class="sc">.</span>mean(train_lens)<span class="sc">:.1f}</span><span class="ss">  test=</span><span class="sc">{</span>np<span class="sc">.</span>mean(test_lens)<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) metrics table</span></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Test Metrics =="</span>)</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics_list, index<span class="op">=</span>names)</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) horizon histograms</span></span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>    all_vals   <span class="op">=</span> np.concatenate([<span class="bu">list</span>(h.values()) <span class="cf">for</span> h <span class="kw">in</span> horizons])</span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>    global_max <span class="op">=</span> <span class="bu">int</span>(all_vals.<span class="bu">max</span>()) <span class="cf">if</span> all_vals.size <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>    bins       <span class="op">=</span> np.arange(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>    fig, axes  <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name, hor <span class="kw">in</span> <span class="bu">zip</span>(axes, names, horizons):</span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(hor.values()))</span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# comments after first+forecast"</span>)</span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>,<span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>vals<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>np<span class="sc">.</span>median(vals)<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) merge conversation‑level dfs</span></span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>,<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(  </span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merged.join(</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>            df[[<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>            ), how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5) calibration + probability histogram</span></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>    fig, (ax_cal, ax_hist) <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a>        CalibrationDisplay.from_predictions(</span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>            y_prob<span class="op">=</span>merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>            n_bins<span class="op">=</span><span class="dv">10</span>, name<span class="op">=</span>name, ax<span class="op">=</span>ax_cal</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a>    ax_cal.set_title(<span class="st">"Calibration Curves"</span>)<span class="op">;</span> ax_cal.grid(<span class="va">True</span>)</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>    bins_prob <span class="op">=</span> np.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">11</span>)</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>        ax_hist.hist(merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>], bins<span class="op">=</span>bins_prob,</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span>name, edgecolor<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_title(<span class="st">"Probability Histogram"</span>)</span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_xlabel(<span class="st">"Predicted probability"</span>)</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_ylabel(<span class="st">"Count of convos"</span>)</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>    ax_hist.legend()<span class="op">;</span> ax_hist.grid(<span class="va">True</span>)</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) confusion matrices</span></span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>))</span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7) ROC &amp; PR curves + find best thresholds</span></span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> {}</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {}</span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a>    corpora <span class="op">=</span> {}</span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ROC</span></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> merged[<span class="st">'label'</span>]</span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>        y_score<span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a>        fpr, tpr, _ <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> roc_auc_score(y_true, y_score)</span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>        plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AUC=</span><span class="sc">{</span>auc<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>        thr, t, f, j <span class="op">=</span> find_best_threshold(y_true, y_score)</span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>        thresholds[name] <span class="op">=</span> thr</span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss"> best thr=</span><span class="sc">{</span>thr<span class="sc">:.3f}</span><span class="ss">, TPR=</span><span class="sc">{</span>t<span class="sc">:.3f}</span><span class="ss">, FPR=</span><span class="sc">{</span>f<span class="sc">:.3f}</span><span class="ss">, J=</span><span class="sc">{</span>j<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">'k--'</span>)</span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"ROC Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"FPR"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"TPR"</span>)<span class="op">;</span> plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>    <span class="co">#annotate corpora with best prediction:</span></span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus, <span class="op">*</span>_ <span class="kw">in</span> corpora_info:</span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">not</span> <span class="kw">in</span> thresholds:</span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"No threshold provided for model </span><span class="sc">{</span>name<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a>        apply_best_threshold(corpus, thresholds[name],  selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create best metrics</span></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a>        metrics[name] <span class="op">=</span> summarize(corpus, selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>, threshold<span class="op">=</span>thresholds[name])</span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a>        corpora[name] <span class="op">=</span> corpus</span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PR</span></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a>        prec, rec, _ <span class="op">=</span> precision_recall_curve(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a>        ap <span class="op">=</span> average_precision_score(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a>        plt.plot(rec, prec, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AP=</span><span class="sc">{</span>ap<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Precision–Recall Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"Recall"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"Precision"</span>)</span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a>    plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8) summary table</span></span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> {</span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_acc"</span>:      (merged[<span class="st">'label'</span>]<span class="op">==</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]).mean()</span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a>    summary.update({</span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_avg_prob"</span>: merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>].mean()</span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Summary of Convo Acc &amp; Avg Prob =="</span>)</span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame(summary, index<span class="op">=</span>[<span class="st">"conversation_level"</span>]))</span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresholds, metrics, corpora</span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-248"><a href="#cb33-248" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> best_thersholds(corpora_info, split_key<span class="op">=</span><span class="st">"split"</span>, train_tag<span class="op">=</span><span class="st">"train"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>):</span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 7) ROC &amp; PR curves + find best thresholds</span></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> {}</span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {}</span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a>    corpora <span class="op">=</span> {}</span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> merged[<span class="st">'label'</span>]</span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a>        y_score<span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb33-259"><a href="#cb33-259" aria-hidden="true" tabindex="-1"></a>        thr, t, f, j <span class="op">=</span> find_best_threshold(y_true, y_score)</span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a>        thresholds[name] <span class="op">=</span> thr</span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_models(thresholds, metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) metrics table</span></span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Best Threshold Test Set Metrics =="</span>)</span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics, index<span class="op">=</span><span class="bu">list</span>(metrics.values())[<span class="dv">0</span>].keys()).T</span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) confusion matrices</span></span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>))</span>
<span id="cb33-272"><a href="#cb33-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-273"><a href="#cb33-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect true/test only</span></span>
<span id="cb33-277"><a href="#cb33-277" aria-hidden="true" tabindex="-1"></a>        conv_df <span class="op">=</span> corpora[name].get_conversations_dataframe().reset_index()</span>
<span id="cb33-278"><a href="#cb33-278" aria-hidden="true" tabindex="-1"></a>        test_df <span class="op">=</span> conv_df[conv_df[<span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>] <span class="op">==</span> test_tag]</span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> test_df[<span class="st">"meta.label"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> test_df[<span class="st">"meta.best_forecast"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>y_true,</span>
<span id="cb33-283"><a href="#cb33-283" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>y_pred,</span>
<span id="cb33-284"><a href="#cb33-284" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) forecast‑horizon histograms</span></span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-294"><a href="#cb33-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-295"><a href="#cb33-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-296"><a href="#cb33-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute global max horizon to align bins</span></span>
<span id="cb33-297"><a href="#cb33-297" aria-hidden="true" tabindex="-1"></a>    all_horizons <span class="op">=</span> []</span>
<span id="cb33-298"><a href="#cb33-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-299"><a href="#cb33-299" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb33-300"><a href="#cb33-300" aria-hidden="true" tabindex="-1"></a>        all_horizons.extend(h.values())</span>
<span id="cb33-301"><a href="#cb33-301" aria-hidden="true" tabindex="-1"></a>    max_h <span class="op">=</span> <span class="bu">int</span>(<span class="bu">max</span>(all_horizons)) <span class="cf">if</span> all_horizons <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb33-302"><a href="#cb33-302" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> np.arange(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb33-303"><a href="#cb33-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-304"><a href="#cb33-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb33-305"><a href="#cb33-305" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb33-306"><a href="#cb33-306" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(h.values()))</span>
<span id="cb33-307"><a href="#cb33-307" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb33-308"><a href="#cb33-308" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb33-309"><a href="#cb33-309" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# utts after first + forecast"</span>)</span>
<span id="cb33-310"><a href="#cb33-310" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb33-311"><a href="#cb33-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb33-312"><a href="#cb33-312" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb33-313"><a href="#cb33-313" aria-hidden="true" tabindex="-1"></a>        m, md <span class="op">=</span> vals.mean() <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span>, np.median(vals) <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-314"><a href="#cb33-314" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>, <span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>m<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>md<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb33-315"><a href="#cb33-315" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb33-316"><a href="#cb33-316" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-317"><a href="#cb33-317" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-318"><a href="#cb33-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-319"><a href="#cb33-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-320"><a href="#cb33-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-321"><a href="#cb33-321" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_confusion(thresholds, metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb33-322"><a href="#cb33-322" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb33-323"><a href="#cb33-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) confusion matrices</span></span>
<span id="cb33-324"><a href="#cb33-324" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>))</span>
<span id="cb33-325"><a href="#cb33-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb33-326"><a href="#cb33-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb33-327"><a href="#cb33-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect true/test only</span></span>
<span id="cb33-328"><a href="#cb33-328" aria-hidden="true" tabindex="-1"></a>        conv_df <span class="op">=</span> corpora[name].get_conversations_dataframe().reset_index()</span>
<span id="cb33-329"><a href="#cb33-329" aria-hidden="true" tabindex="-1"></a>        test_df <span class="op">=</span> conv_df[conv_df[<span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>] <span class="op">==</span> test_tag]</span>
<span id="cb33-330"><a href="#cb33-330" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> test_df[<span class="st">"meta.label"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-331"><a href="#cb33-331" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> test_df[<span class="st">"meta.best_forecast"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-332"><a href="#cb33-332" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb33-333"><a href="#cb33-333" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>y_true,</span>
<span id="cb33-334"><a href="#cb33-334" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>y_pred,</span>
<span id="cb33-335"><a href="#cb33-335" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb33-336"><a href="#cb33-336" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb33-337"><a href="#cb33-337" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb33-338"><a href="#cb33-338" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-339"><a href="#cb33-339" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb33-340"><a href="#cb33-340" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-341"><a href="#cb33-341" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-342"><a href="#cb33-342" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-343"><a href="#cb33-343" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-344"><a href="#cb33-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-345"><a href="#cb33-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-346"><a href="#cb33-346" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_metrics(metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb33-347"><a href="#cb33-347" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb33-348"><a href="#cb33-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) metrics table</span></span>
<span id="cb33-349"><a href="#cb33-349" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Best Threshold Test Set Metrics =="</span>)</span>
<span id="cb33-350"><a href="#cb33-350" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics, index<span class="op">=</span><span class="bu">list</span>(metrics.values())[<span class="dv">0</span>].keys()).T</span>
<span id="cb33-351"><a href="#cb33-351" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb33-352"><a href="#cb33-352" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-353"><a href="#cb33-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-354"><a href="#cb33-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-355"><a href="#cb33-355" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-356"><a href="#cb33-356" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-357"><a href="#cb33-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-358"><a href="#cb33-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-359"><a href="#cb33-359" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-360"><a href="#cb33-360" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-361"><a href="#cb33-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-362"><a href="#cb33-362" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_convo_histograms(</span>
<span id="cb33-363"><a href="#cb33-363" aria-hidden="true" tabindex="-1"></a>    groups_of_corpora_info,</span>
<span id="cb33-364"><a href="#cb33-364" aria-hidden="true" tabindex="-1"></a>    bins_prob<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb33-365"><a href="#cb33-365" aria-hidden="true" tabindex="-1"></a>    title_key: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-366"><a href="#cb33-366" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb33-367"><a href="#cb33-367" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-368"><a href="#cb33-368" aria-hidden="true" tabindex="-1"></a><span class="co">    groups_of_corpora_info: list of lists of corpora_info tuples</span></span>
<span id="cb33-369"><a href="#cb33-369" aria-hidden="true" tabindex="-1"></a><span class="co">    bins_prob: optional bin edges for the histograms</span></span>
<span id="cb33-370"><a href="#cb33-370" aria-hidden="true" tabindex="-1"></a><span class="co">    title_key: 0 or 1, picks one of two title‐sets</span></span>
<span id="cb33-371"><a href="#cb33-371" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-372"><a href="#cb33-372" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pick the right set of group names</span></span>
<span id="cb33-373"><a href="#cb33-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_key <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-374"><a href="#cb33-374" aria-hidden="true" tabindex="-1"></a>        titles <span class="op">=</span> [<span class="st">"Default"</span>, <span class="st">"Downsampled"</span>, <span class="st">"Weighted"</span>, <span class="st">"Wiki"</span>]</span>
<span id="cb33-375"><a href="#cb33-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-376"><a href="#cb33-376" aria-hidden="true" tabindex="-1"></a>        titles <span class="op">=</span> [<span class="st">"Ground"</span>, <span class="st">"No Last"</span>, <span class="st">"No Subm"</span>, <span class="st">"Wiki"</span>]</span>
<span id="cb33-377"><a href="#cb33-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-378"><a href="#cb33-378" aria-hidden="true" tabindex="-1"></a>    n_groups <span class="op">=</span> <span class="bu">len</span>(groups_of_corpora_info)</span>
<span id="cb33-379"><a href="#cb33-379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bins_prob <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-380"><a href="#cb33-380" aria-hidden="true" tabindex="-1"></a>        bins_prob <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">11</span>)</span>
<span id="cb33-381"><a href="#cb33-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-382"><a href="#cb33-382" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n_groups, figsize<span class="op">=</span>(<span class="dv">6</span> <span class="op">*</span> n_groups, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-383"><a href="#cb33-383" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_groups <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb33-384"><a href="#cb33-384" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb33-385"><a href="#cb33-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-386"><a href="#cb33-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, corpora_info, group_title <span class="kw">in</span> <span class="bu">zip</span>(axes, groups_of_corpora_info, titles):</span>
<span id="cb33-387"><a href="#cb33-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1) unpack &amp; merge</span></span>
<span id="cb33-388"><a href="#cb33-388" aria-hidden="true" tabindex="-1"></a>        names, _, _, dfs, _ <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb33-389"><a href="#cb33-389" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>, <span class="st">'score'</span>, <span class="st">'forecast'</span>]].rename(</span>
<span id="cb33-390"><a href="#cb33-390" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'score'</span>: <span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb33-391"><a href="#cb33-391" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'forecast'</span>: <span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb33-392"><a href="#cb33-392" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb33-393"><a href="#cb33-393" aria-hidden="true" tabindex="-1"></a>            merged <span class="op">=</span> merged.join(</span>
<span id="cb33-394"><a href="#cb33-394" aria-hidden="true" tabindex="-1"></a>                df[[<span class="st">'score'</span>, <span class="st">'forecast'</span>]].rename(</span>
<span id="cb33-395"><a href="#cb33-395" aria-hidden="true" tabindex="-1"></a>                    columns<span class="op">=</span>{<span class="st">'score'</span>: <span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb33-396"><a href="#cb33-396" aria-hidden="true" tabindex="-1"></a>                             <span class="st">'forecast'</span>: <span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}),</span>
<span id="cb33-397"><a href="#cb33-397" aria-hidden="true" tabindex="-1"></a>                how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb33-398"><a href="#cb33-398" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-399"><a href="#cb33-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-400"><a href="#cb33-400" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2) plot histograms</span></span>
<span id="cb33-401"><a href="#cb33-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-402"><a href="#cb33-402" aria-hidden="true" tabindex="-1"></a>            ax.hist(</span>
<span id="cb33-403"><a href="#cb33-403" aria-hidden="true" tabindex="-1"></a>                merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb33-404"><a href="#cb33-404" aria-hidden="true" tabindex="-1"></a>                bins<span class="op">=</span>bins_prob,</span>
<span id="cb33-405"><a href="#cb33-405" aria-hidden="true" tabindex="-1"></a>                density<span class="op">=</span><span class="va">False</span>,    <span class="co"># raw counts</span></span>
<span id="cb33-406"><a href="#cb33-406" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb33-407"><a href="#cb33-407" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span>name,</span>
<span id="cb33-408"><a href="#cb33-408" aria-hidden="true" tabindex="-1"></a>                edgecolor<span class="op">=</span><span class="st">'k'</span></span>
<span id="cb33-409"><a href="#cb33-409" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-410"><a href="#cb33-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-411"><a href="#cb33-411" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3) compute mean &amp; variance for each model</span></span>
<span id="cb33-412"><a href="#cb33-412" aria-hidden="true" tabindex="-1"></a>        stats_lines <span class="op">=</span> []</span>
<span id="cb33-413"><a href="#cb33-413" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb33-414"><a href="#cb33-414" aria-hidden="true" tabindex="-1"></a>            arr <span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>].to_numpy()</span>
<span id="cb33-415"><a href="#cb33-415" aria-hidden="true" tabindex="-1"></a>            mu  <span class="op">=</span> arr.mean()</span>
<span id="cb33-416"><a href="#cb33-416" aria-hidden="true" tabindex="-1"></a>            var <span class="op">=</span> arr.var()</span>
<span id="cb33-417"><a href="#cb33-417" aria-hidden="true" tabindex="-1"></a>            stats_lines.append(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: μ=</span><span class="sc">{</span>mu<span class="sc">:.2f}</span><span class="ss">, σ²=</span><span class="sc">{</span>var<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-418"><a href="#cb33-418" aria-hidden="true" tabindex="-1"></a>        subtitle <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(stats_lines)</span>
<span id="cb33-419"><a href="#cb33-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-420"><a href="#cb33-420" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4) format subplot</span></span>
<span id="cb33-421"><a href="#cb33-421" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>group_title<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>subtitle<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb33-422"><a href="#cb33-422" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Predicted probability"</span>)</span>
<span id="cb33-423"><a href="#cb33-423" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb33-424"><a href="#cb33-424" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Count of convos"</span>)</span>
<span id="cb33-425"><a href="#cb33-425" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>)</span>
<span id="cb33-426"><a href="#cb33-426" aria-hidden="true" tabindex="-1"></a>        ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb33-427"><a href="#cb33-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-428"><a href="#cb33-428" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb33-429"><a href="#cb33-429" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="conversation-utilities" class="level3">
<h3 class="anchored" data-anchor-id="conversation-utilities">Conversation Utilities</h3>
<div id="cell-46" class="cell" data-execution_count="155">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_conversation(corpus, convo_id):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Pretty–print the dialogue for a single conversation.</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">        corpus:    a ConvoKit Corpus</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">        convo_id:  the ID of the conversation you want to print</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grab the utterance DataFrame for that convo</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> corpus.get_conversation(convo_id).get_utterances_dataframe()</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure it's sorted by timestamp (or by its original index order)</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"timestamp"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.sort_values(<span class="st">"timestamp"</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now print each turn</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        speaker <span class="op">=</span> row.get(<span class="st">"speaker"</span>, <span class="st">"Unknown"</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        text    <span class="op">=</span> row.get(<span class="st">"text"</span>, <span class="st">""</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>speaker<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_avg_frustration_score(corpus):</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    filepath <span class="op">=</span> <span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/preprocessed_dyads.csv"</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    final_data <span class="op">=</span> DataPreprocesser(filepath)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span> final_data.getDataframe()</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'avg_frustration_score'</span>] <span class="op">=</span> df[[<span class="st">'b_Tact_4'</span>, <span class="st">'b_Tact_9'</span>, <span class="st">'s_Tact_4'</span>, <span class="st">'s_Tact_9'</span>]].<span class="bu">apply</span>(</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: row.mean() <span class="cf">if</span> row.notnull().<span class="bu">all</span>() <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    non_missing <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'avg_frustration_score'</span>])</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build a mapping from conversation ID to score, only for non-missing scores</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    score_map <span class="op">=</span> {</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"utt0_con</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>: score</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, score <span class="kw">in</span> non_missing[<span class="st">'avg_frustration_score'</span>].dropna().items()</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign the score if present, else None</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>        convo.meta[<span class="st">'avg_frustration_score'</span>] <span class="op">=</span> score_map.get(convo.<span class="bu">id</span>, <span class="va">None</span>)</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_max_pred_score_to_conversations(corpus, utt_score_key<span class="op">=</span><span class="st">'pred_score'</span>, conv_meta_key<span class="op">=</span><span class="st">'max_pred_score'</span>):</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect all non-null scores</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> [</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>            utt.meta.get(utt_score_key)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances()</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> utt.meta.get(utt_score_key) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># set the max (or None if there were no scores)</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        convo.meta[conv_meta_key] <span class="op">=</span> <span class="bu">max</span>(scores) <span class="cf">if</span> scores <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fighting-words" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words">Fighting Words</h3>
<div id="cell-48" class="cell" data-execution_count="112">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.fighting_words.fightingWords <span class="im">import</span> FightingWords</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> TextCleaner</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cleantext <span class="im">import</span> clean</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_agreement(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    patterns <span class="op">=</span> [<span class="vs">r"Submitted agreement:"</span>, <span class="vs">r"\brefund, buyer\b"</span>, <span class="vs">r"\breview, seller\b"</span>]</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(re.search(pat, text, flags<span class="op">=</span>re.IGNORECASE) <span class="cf">for</span> pat <span class="kw">in</span> patterns):</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"Submitted agreement:.*?\.(\s|$)"</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        text,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        flags<span class="op">=</span>re.IGNORECASE,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Remove any leftover 'refund, buyer' or 'review, seller'</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\brefund, buyer\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\breview, seller\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Collapse multiple spaces down to one, then strip edges</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s{2,}"</span>, <span class="st">" "</span>, text).strip()</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_mispredicted_fighting_words(</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    corpus,</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    split_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    test_tag: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    best_pred_key: <span class="bu">str</span>  <span class="op">=</span> <span class="st">"best_forecast"</span>,</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    label_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"label"</span>,</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    prob_key: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"pred_score"</span>,</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    threshold: <span class="bu">float</span>    <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    custom_vec          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    plot: <span class="bu">bool</span>          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    ngram_range<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    min_df<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    max_df<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    max_features<span class="op">=</span><span class="dv">15000</span>,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    prior<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span>            <span class="op">=</span> <span class="st">"false_pos_neg"</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Identify “fighting words” that distinguish mis‐predicted success vs mis‐predicted impasse</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="co">    at the utterance level, optionally filtered by a probability threshold.</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define text preprocessor</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocess(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> strip_agreement(text)</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> FightingWords.clean_text(s)</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define misprediction types</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_pos(u):</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> u.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&gt;=</span> threshold</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_neg(u):</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> u.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&lt;</span> threshold</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_pos(utt):</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_pos(utt)</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_neg(utt):</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_neg(utt)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_pos(utt):</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_pos(utt)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_neg(utt):</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_neg(utt)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map key to class functions and labels</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="op">==</span> <span class="st">"false_pos_false_neg"</span>:</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, false_neg</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"False Derailmemt"</span>, <span class="st">"False Success"</span></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_true_neg"</span>:</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, true_neg</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_false_pos"</span>:</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, false_pos</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"False Derailmemt"</span></span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"false_pos_true_neg"</span>:</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, true_neg</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span><span class="st">"False Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown key </span><span class="sc">{</span>key<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> custom_vec:</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Build over entire corpus """</span></span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>        cv_custom <span class="op">=</span> CountVectorizer(</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>        all_texts <span class="op">=</span> [u.text <span class="cf">for</span> u <span class="kw">in</span> corpus.iter_utterances()]</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>        cv_custom.fit(all_texts)</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>        prior_counts <span class="op">=</span> cv_custom.transform(all_texts).toarray().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>        cv_locked <span class="op">=</span> CountVectorizer(vocabulary<span class="op">=</span>cv_custom.vocabulary_, preprocessor<span class="op">=</span>preprocess)</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instantiate and fit FightingWords</span></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> utt: preprocess(utt.text),</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_locked,</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior_counts</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Build over the utterances in the selected classes """</span></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>        cv<span class="op">=</span> CountVectorizer(</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span> <span class="st">'english'</span>,</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features,</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> utt: preprocess(utt.text),</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"utterance"</span>,</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span> cv,</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span> prior</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>    fw.fit(corpus, class1_func<span class="op">=</span>class1_func, class2_func<span class="op">=</span>class2_func,</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>            selector<span class="op">=</span><span class="kw">lambda</span> utt: utt.get_conversation().meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract z‐scores with dynamic labels</span></span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>    zdf <span class="op">=</span> fw.get_ngram_zscores(class1_name<span class="op">=</span>class1_label, class2_name<span class="op">=</span>class2_label)</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot if needed</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot:</span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>        cfg <span class="op">=</span> {<span class="st">"annot_method"</span>:<span class="st">"top_k"</span>, <span class="st">"top_k"</span>:<span class="dv">10</span>}</span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>        fw.plot_fighting_words(</span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>            max_label_size<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>            class1_name<span class="op">=</span>class1_label,</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>            class2_name<span class="op">=</span>class2_label,</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>cfg</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fw, zdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fighting-words-by-conversation" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-by-conversation">Fighting Words By conversation</h3>
<div id="db530e2f" class="cell" data-execution_count="116">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.fighting_words.fightingWords <span class="im">import</span> FightingWords</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable, Tuple</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> TextCleaner</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cleantext <span class="im">import</span> clean</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_agreement(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    patterns <span class="op">=</span> [<span class="vs">r"Submitted agreement:"</span>, <span class="vs">r"\brefund, buyer\b"</span>, <span class="vs">r"\breview, seller\b"</span>]</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(re.search(pat, text, flags<span class="op">=</span>re.IGNORECASE) <span class="cf">for</span> pat <span class="kw">in</span> patterns):</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"Submitted agreement:.*?\.(\s|$)"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\brefund, buyer\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\breview, seller\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s{2,}"</span>, <span class="st">" "</span>, text).strip()</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_mispredicted_fighting_words_by_conversation(</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    corpus,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    split_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    test_tag: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    best_pred_key: <span class="bu">str</span>  <span class="op">=</span> <span class="st">"best_forecast"</span>,</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    label_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"label"</span>,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    prob_key: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"pred_score"</span>,</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    threshold: <span class="bu">float</span>    <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    custom_vec: <span class="bu">bool</span>    <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    plot: <span class="bu">bool</span>          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    ngram_range: Tuple[<span class="bu">int</span>,<span class="bu">int</span>] <span class="op">=</span> (<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    min_df: <span class="bu">int</span>         <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    max_df: <span class="bu">float</span>       <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    max_features: <span class="bu">int</span>   <span class="op">=</span> <span class="dv">15000</span>,</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    prior: <span class="bu">float</span>        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span>            <span class="op">=</span> <span class="st">"false_pos_neg"</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[FightingWords, pd.DataFrame]:</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Variation of FightingWords at the **conversation** level.</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Compares two classes of conversations (e.g. mispredictions) rather than utterances.</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessor for raw text</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocess(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> FightingWords.clean_text(strip_agreement(text))</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helpers for conversation-level threshold</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_pos_conv(conv):</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> conv.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&gt;=</span> threshold</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_neg_conv(conv):</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> conv.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&lt;</span> threshold</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class definitions on conversation.meta</span></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_pos(convo):</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">1</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_pos_conv(convo))</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_neg(convo):</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">0</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_neg_conv(convo))</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_pos(convo):</span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">1</span></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_pos_conv(convo))</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_neg(convo):</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">0</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_neg_conv(convo))</span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map key to class functions and labels</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="op">==</span> <span class="st">"false_pos_false_neg"</span>:</span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, false_neg</span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"False Derailmemt"</span>, <span class="st">"False Success"</span></span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_true_neg"</span>:</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, true_neg</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_false_pos"</span>:</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, false_pos</span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"False Derailmemt"</span></span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"false_pos_true_neg"</span>:</span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, true_neg</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span><span class="st">"False Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown key </span><span class="sc">{</span>key<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build vectorizer over full set of conversation texts</span></span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> custom_vec:</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>        cv_full <span class="op">=</span> CountVectorizer(</span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gather all conversation-level texts</span></span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>        all_texts <span class="op">=</span> [preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances()))</span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_objs(<span class="st">"conversation"</span>)]</span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a>        cv_full.fit(all_texts)</span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a>        prior_counts <span class="op">=</span> cv_full.transform(all_texts).toarray().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>        cv_locked <span class="op">=</span> CountVectorizer(vocabulary<span class="op">=</span>cv_full.vocabulary_, preprocessor<span class="op">=</span>preprocess)</span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"conversation"</span>,</span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> convo: preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances())),</span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_locked,</span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior_counts</span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Default uniform prior over subset vocabulary</span></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>        cv_sub <span class="op">=</span> CountVectorizer(</span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"conversation"</span>,</span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> convo: preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances())),</span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_sub,</span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior</span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit on selected conversations</span></span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a>    fw.fit(</span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a>        corpus,</span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>        class1_func<span class="op">=</span>class1_func,</span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a>        class2_func<span class="op">=</span>class2_func,</span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>        selector<span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(split_key)<span class="op">==</span>test_tag</span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract z-scores DataFrame</span></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a>    zdf <span class="op">=</span> fw.get_ngram_zscores(class1_name<span class="op">=</span>class1_label, class2_name<span class="op">=</span>class2_label)</span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally plot</span></span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot:</span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a>        cfg <span class="op">=</span> {<span class="st">"annot_method"</span>: <span class="st">"top_k"</span>, <span class="st">"top_k"</span>: <span class="dv">10</span>}</span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a>        fw.plot_fighting_words(</span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a>            max_label_size<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a>            class1_name<span class="op">=</span>class1_label,</span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a>            class2_name<span class="op">=</span>class2_label,</span>
<span id="cb36-143"><a href="#cb36-143" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>cfg</span>
<span id="cb36-144"><a href="#cb36-144" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fw, zdf</span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="forecasting-trends" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-trends">Forecasting Trends</h3>
<div id="cell-52" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_position_score_evolution_by_outcome(</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    corpus, split_key<span class="op">=</span><span class="st">"split"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    prob_key<span class="op">=</span><span class="st">"pred_score"</span>, name<span class="op">=</span><span class="va">None</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    pos_scores <span class="op">=</span> {<span class="dv">0</span>: defaultdict(<span class="bu">list</span>), <span class="dv">1</span>: defaultdict(<span class="bu">list</span>)}</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> test_tag:</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        lbl <span class="op">=</span> convo.meta.get(<span class="st">"label"</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.iter_utterances(), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                pos_scores[lbl][p].append(score)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    overall_max_pos <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>(d.keys()) <span class="cf">for</span> d <span class="kw">in</span> pos_scores.values() <span class="cf">if</span> d</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> <span class="bu">any</span>(pos_scores.values()) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    fig.subplots_adjust(left<span class="op">=</span><span class="fl">0.05</span>, right<span class="op">=</span><span class="fl">0.80</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ix, lbl <span class="kw">in</span> <span class="bu">enumerate</span>((<span class="dv">0</span>, <span class="dv">1</span>), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">2</span>, ix, projection<span class="op">=</span><span class="st">'3d'</span>)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> np.arange(<span class="dv">1</span>, overall_max_pos <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> [</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>            np.mean(pos_scores[lbl].get(p, [])) <span class="cf">if</span> pos_scores[lbl].get(p)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> X</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> X</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># force colormap and scatter scale to 0→1</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        sc <span class="op">=</span> ax.scatter(</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>            X, Y, Z,</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span>Y, cmap<span class="op">=</span><span class="st">'viridis'</span>,</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, Z, color<span class="op">=</span><span class="st">'black'</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, zs<span class="op">=</span><span class="dv">0</span>, zdir<span class="op">=</span><span class="st">'z'</span>, color<span class="op">=</span><span class="st">'gray'</span>, ls<span class="op">=</span><span class="st">'--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> xi, yi, zi <span class="kw">in</span> <span class="bu">zip</span>(X, Y, Z):</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>            ax.plot([xi, xi], [yi, yi], [<span class="dv">0</span>, zi],</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, lw<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Utterance Position"</span>)</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Mean Predicted Probability"</span>)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        ax.set_zlabel(<span class="st">"Conversation Length so far"</span>)</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)                      <span class="co"># &lt;— lock the probability axis</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>        title_lbl <span class="op">=</span> <span class="st">"Successful"</span> <span class="cf">if</span> lbl <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"Impasse"</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title_lbl<span class="sc">}</span><span class="ss"> (label=</span><span class="sc">{</span>lbl<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add colorbar to its own axes on the far right</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>    cbar_ax <span class="op">=</span> fig.add_axes([<span class="fl">0.82</span>, <span class="fl">0.15</span>, <span class="fl">0.02</span>, <span class="fl">0.7</span>])</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>    cb <span class="op">=</span> fig.colorbar(sc, cax<span class="op">=</span>cbar_ax)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>    cb.set_label(<span class="st">"Avg. Probability"</span>)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name:</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Evolution of Model Confidence by Turn for </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="fl">0.95</span>, fontsize<span class="op">=</span><span class="dv">14</span></span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wiki-ground-functions" class="level3">
<h3 class="anchored" data-anchor-id="wiki-ground-functions">Wiki Ground Functions</h3>
<div id="cell-54" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>filepath <span class="op">=</span> <span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/preprocessed_dyads.csv"</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>filepath_no_last <span class="op">=</span> <span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/convos_exclude_last_utt.csv'</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>filepath_no_submit_last <span class="op">=</span> <span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/convos_exclude_submit_and_last.csv'</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling/"</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp_weighted <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_weighted/"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>results_filepath_downsampled <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled/"</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_convo_labels(corpus, final_data):</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> final_data.getDataframe().iterrows():</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        convo_id <span class="op">=</span> <span class="ss">f"utt0_con</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>  <span class="co"># generate conversation_id format from index</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> row[<span class="st">"dispute_outcome"</span>]  <span class="co"># update if your label column is named differently</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo_id <span class="kw">in</span> corpus.conversations:</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>            corpus.get_conversation(convo_id).meta[<span class="st">"label"</span>] <span class="op">=</span> label</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corpus_train_test_split(corpus):</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    random.seed(<span class="dv">42</span>)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get all conversation IDs</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    all_convo_ids <span class="op">=</span> <span class="bu">list</span>(corpus.get_conversation_ids())</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Shuffle the conversation IDs</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    random.shuffle(all_convo_ids)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Define proportions</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(all_convo_ids)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> n_total)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.1</span> <span class="op">*</span> n_total)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    n_test <span class="op">=</span> n_total <span class="op">-</span> n_train <span class="op">-</span> n_val  <span class="co"># ensures 100% total</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Split into train/val/test</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    train_convos <span class="op">=</span> all_convo_ids[:n_train]</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    val_convos <span class="op">=</span> all_convo_ids[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    test_convos <span class="op">=</span> all_convo_ids[n_train<span class="op">+</span>n_val:]</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Mark conversations with a split tag</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> train_convos:</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> val_convos:</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"val"</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> test_convos:</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"test"</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_selector(context_tuple, split):</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Select only contexts in the given split, at the end of the conversation,</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="co">    and skip any utterance that’s been tagged exclude=True.</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the desired split</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    matches_split <span class="op">=</span> (</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>        context_tuple.current_utterance</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>            .get_conversation()</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            .meta[<span class="st">"split"</span>]</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> split</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the final context in each convo</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>    is_end <span class="op">=</span> (<span class="bu">len</span>(context_tuple.future_context) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # skip if the current utterance was marked exclude=True</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not_excluded = not context_tuple.current_utterance.meta.get("exclude", False)</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matches_split <span class="kw">and</span> is_end </span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_selector(context_tuple):</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a><span class="co">    For transform we only need to check that the conversation is in the test split</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (context_tuple.current_utterance.get_conversation().meta[<span class="st">"split"</span>] <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="co"># selector for summarize: takes a Conversation</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convo_selector(convo: Conversation):</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a><span class="co">""" CRAFT MODEL INSTANCES """</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>model_wiki <span class="op">=</span> CRAFTModel(</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span> <span class="st">"craft-wiki-finetuned"</span>,  <span class="co"># or "craft-wiki-finetuned"</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span><span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a><span class="co">""" FORECASTER MODEL INSTANCE """</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_wiki <span class="op">=</span> Forecaster(</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_wiki,</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading craft-wiki-finetuned to /Users/mishkin/.convokit/saved-models/craft-wiki-finetuned
Downloading craft-wiki-finetuned/craft_full.tar from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/craft_full.tar (548.6MB)... Done
Downloading craft-wiki-finetuned/index2word.json from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/index2word.json (998.5KB)... Done
Downloading craft-wiki-finetuned/word2index.json from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/word2index.json (898.4KB)... Done</code></pre>
</div>
</div>
</section>
<section id="frustration-correlation-1" class="level3">
<h3 class="anchored" data-anchor-id="frustration-correlation-1">Frustration Correlation</h3>
<div id="712ff852" class="cell" data-execution_count="158">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_prediction_vs_frustration(corpus,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                                       split_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                                       test_tag: <span class="bu">str</span> <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                                       pred_meta_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"max_pred_score"</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                                       frust_meta_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"avg_frustration_score"</span>):</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only test‑split</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> test_tag:</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        pred_score <span class="op">=</span> convo.meta.get(pred_meta_key)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        frust     <span class="op">=</span> convo.meta.get(frust_meta_key)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pred_score <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> frust <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        records.append({</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>            pred_meta_key: pred_score,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>            frust_meta_key: frust</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"The numbr of conversations to perform regression analysis on is </span><span class="sc">{</span><span class="bu">len</span>(records)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df.empty:</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No test conversations with both scores present."</span>)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correlation</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> df[pred_meta_key].corr(df[frust_meta_key])</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># linear regression</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[[pred_meta_key]].values</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[frust_meta_key].values</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> lr.score(X, y)</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[pred_meta_key], df[frust_meta_key], alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>    plt.plot(df[pred_meta_key], lr.predict(X), color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(pred_meta_key)</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(frust_meta_key)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"</span><span class="sc">{</span>pred_meta_key<span class="sc">}</span><span class="ss"> vs. </span><span class="sc">{</span>frust_meta_key<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"r = </span><span class="sc">{</span>corr<span class="sc">:.2f}</span><span class="ss">,  R² = </span><span class="sc">{</span>r2<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, corr, r2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-57" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>final_data <span class="op">=</span> DataPreprocesser(filepath)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>final_data_no_last <span class="op">=</span> DataPreprocesser(filepath_no_last)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>final_data_no_submit_last <span class="op">=</span> DataPreprocesser(filepath_no_submit_last)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>ground2<span class="op">=</span> corp.corpusBuilder(final_data_no_last)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>ground3<span class="op">=</span>corp.corpusBuilder(final_data_no_submit_last)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co">"""Testing"""</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_orig <span class="op">=</span> forecaster_kodis_wiki.transform(ground1, transform_selector)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>ground_wiki_df, ground_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>ground_wiki_horizon <span class="op">=</span>forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_wiki.transform(ground2, transform_selector)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>no_last_wiki_df, no_last_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nl , convo_selector)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>no_last_wiki_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nls <span class="op">=</span> forecaster_kodis_wiki.transform(ground3, transform_selector)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>no_last_submit_wiki_df, no_last_submit_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nls,convo_selector)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>no_last_submit_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'
27498it [00:01, 22699.92it/s]
25391it [00:00, 70088.95it/s]
23117it [00:00, 28601.33it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 5524 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.1%
Iteration: 2; Percent complete: 2.3%
Iteration: 3; Percent complete: 3.4%
Iteration: 4; Percent complete: 4.6%
Iteration: 5; Percent complete: 5.7%
Iteration: 6; Percent complete: 6.9%
Iteration: 7; Percent complete: 8.0%
Iteration: 8; Percent complete: 9.2%
Iteration: 9; Percent complete: 10.3%
Iteration: 10; Percent complete: 11.5%
Iteration: 11; Percent complete: 12.6%
Iteration: 12; Percent complete: 13.8%
Iteration: 13; Percent complete: 14.9%
Iteration: 14; Percent complete: 16.1%
Iteration: 15; Percent complete: 17.2%
Iteration: 16; Percent complete: 18.4%
Iteration: 17; Percent complete: 19.5%
Iteration: 18; Percent complete: 20.7%
Iteration: 19; Percent complete: 21.8%
Iteration: 20; Percent complete: 23.0%
Iteration: 21; Percent complete: 24.1%
Iteration: 22; Percent complete: 25.3%
Iteration: 23; Percent complete: 26.4%
Iteration: 24; Percent complete: 27.6%
Iteration: 25; Percent complete: 28.7%
Iteration: 26; Percent complete: 29.9%
Iteration: 27; Percent complete: 31.0%
Iteration: 28; Percent complete: 32.2%
Iteration: 29; Percent complete: 33.3%
Iteration: 30; Percent complete: 34.5%
Iteration: 31; Percent complete: 35.6%
Iteration: 32; Percent complete: 36.8%
Iteration: 33; Percent complete: 37.9%
Iteration: 34; Percent complete: 39.1%
Iteration: 35; Percent complete: 40.2%
Iteration: 36; Percent complete: 41.4%
Iteration: 37; Percent complete: 42.5%
Iteration: 38; Percent complete: 43.7%
Iteration: 39; Percent complete: 44.8%
Iteration: 40; Percent complete: 46.0%
Iteration: 41; Percent complete: 47.1%
Iteration: 42; Percent complete: 48.3%
Iteration: 43; Percent complete: 49.4%
Iteration: 44; Percent complete: 50.6%
Iteration: 45; Percent complete: 51.7%
Iteration: 46; Percent complete: 52.9%
Iteration: 47; Percent complete: 54.0%
Iteration: 48; Percent complete: 55.2%
Iteration: 49; Percent complete: 56.3%
Iteration: 50; Percent complete: 57.5%
Iteration: 51; Percent complete: 58.6%
Iteration: 52; Percent complete: 59.8%
Iteration: 53; Percent complete: 60.9%
Iteration: 54; Percent complete: 62.1%
Iteration: 55; Percent complete: 63.2%
Iteration: 56; Percent complete: 64.4%
Iteration: 57; Percent complete: 65.5%
Iteration: 58; Percent complete: 66.7%
Iteration: 59; Percent complete: 67.8%
Iteration: 60; Percent complete: 69.0%
Iteration: 61; Percent complete: 70.1%
Iteration: 62; Percent complete: 71.3%
Iteration: 63; Percent complete: 72.4%
Iteration: 64; Percent complete: 73.6%
Iteration: 65; Percent complete: 74.7%
Iteration: 66; Percent complete: 75.9%
Iteration: 67; Percent complete: 77.0%
Iteration: 68; Percent complete: 78.2%
Iteration: 69; Percent complete: 79.3%
Iteration: 70; Percent complete: 80.5%
Iteration: 71; Percent complete: 81.6%
Iteration: 72; Percent complete: 82.8%
Iteration: 73; Percent complete: 83.9%
Iteration: 74; Percent complete: 85.1%
Iteration: 75; Percent complete: 86.2%
Iteration: 76; Percent complete: 87.4%
Iteration: 77; Percent complete: 88.5%
Iteration: 78; Percent complete: 89.7%
Iteration: 79; Percent complete: 90.8%
Iteration: 80; Percent complete: 92.0%
Iteration: 81; Percent complete: 93.1%
Iteration: 82; Percent complete: 94.3%
Iteration: 83; Percent complete: 95.4%
Iteration: 84; Percent complete: 96.6%
Iteration: 85; Percent complete: 97.7%
Iteration: 86; Percent complete: 98.9%
Iteration: 87; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 10.191176470588236, Median = 9.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 5101 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.2%
Iteration: 2; Percent complete: 2.5%
Iteration: 3; Percent complete: 3.8%
Iteration: 4; Percent complete: 5.0%
Iteration: 5; Percent complete: 6.2%
Iteration: 6; Percent complete: 7.5%
Iteration: 7; Percent complete: 8.8%
Iteration: 8; Percent complete: 10.0%
Iteration: 9; Percent complete: 11.2%
Iteration: 10; Percent complete: 12.5%
Iteration: 11; Percent complete: 13.8%
Iteration: 12; Percent complete: 15.0%
Iteration: 13; Percent complete: 16.2%
Iteration: 14; Percent complete: 17.5%
Iteration: 15; Percent complete: 18.8%
Iteration: 16; Percent complete: 20.0%
Iteration: 17; Percent complete: 21.2%
Iteration: 18; Percent complete: 22.5%
Iteration: 19; Percent complete: 23.8%
Iteration: 20; Percent complete: 25.0%
Iteration: 21; Percent complete: 26.2%
Iteration: 22; Percent complete: 27.5%
Iteration: 23; Percent complete: 28.7%
Iteration: 24; Percent complete: 30.0%
Iteration: 25; Percent complete: 31.2%
Iteration: 26; Percent complete: 32.5%
Iteration: 27; Percent complete: 33.8%
Iteration: 28; Percent complete: 35.0%
Iteration: 29; Percent complete: 36.2%
Iteration: 30; Percent complete: 37.5%
Iteration: 31; Percent complete: 38.8%
Iteration: 32; Percent complete: 40.0%
Iteration: 33; Percent complete: 41.2%
Iteration: 34; Percent complete: 42.5%
Iteration: 35; Percent complete: 43.8%
Iteration: 36; Percent complete: 45.0%
Iteration: 37; Percent complete: 46.2%
Iteration: 38; Percent complete: 47.5%
Iteration: 39; Percent complete: 48.8%
Iteration: 40; Percent complete: 50.0%
Iteration: 41; Percent complete: 51.2%
Iteration: 42; Percent complete: 52.5%
Iteration: 43; Percent complete: 53.8%
Iteration: 44; Percent complete: 55.0%
Iteration: 45; Percent complete: 56.2%
Iteration: 46; Percent complete: 57.5%
Iteration: 47; Percent complete: 58.8%
Iteration: 48; Percent complete: 60.0%
Iteration: 49; Percent complete: 61.3%
Iteration: 50; Percent complete: 62.5%
Iteration: 51; Percent complete: 63.7%
Iteration: 52; Percent complete: 65.0%
Iteration: 53; Percent complete: 66.2%
Iteration: 54; Percent complete: 67.5%
Iteration: 55; Percent complete: 68.8%
Iteration: 56; Percent complete: 70.0%
Iteration: 57; Percent complete: 71.2%
Iteration: 58; Percent complete: 72.5%
Iteration: 59; Percent complete: 73.8%
Iteration: 60; Percent complete: 75.0%
Iteration: 61; Percent complete: 76.2%
Iteration: 62; Percent complete: 77.5%
Iteration: 63; Percent complete: 78.8%
Iteration: 64; Percent complete: 80.0%
Iteration: 65; Percent complete: 81.2%
Iteration: 66; Percent complete: 82.5%
Iteration: 67; Percent complete: 83.8%
Iteration: 68; Percent complete: 85.0%
Iteration: 69; Percent complete: 86.2%
Iteration: 70; Percent complete: 87.5%
Iteration: 71; Percent complete: 88.8%
Iteration: 72; Percent complete: 90.0%
Iteration: 73; Percent complete: 91.2%
Iteration: 74; Percent complete: 92.5%
Iteration: 75; Percent complete: 93.8%
Iteration: 76; Percent complete: 95.0%
Iteration: 77; Percent complete: 96.2%
Iteration: 78; Percent complete: 97.5%
Iteration: 79; Percent complete: 98.8%
Iteration: 80; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 9.191176470588236, Median = 8.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 4656 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.4%
Iteration: 2; Percent complete: 2.7%
Iteration: 3; Percent complete: 4.1%
Iteration: 4; Percent complete: 5.5%
Iteration: 5; Percent complete: 6.8%
Iteration: 6; Percent complete: 8.2%
Iteration: 7; Percent complete: 9.6%
Iteration: 8; Percent complete: 11.0%
Iteration: 9; Percent complete: 12.3%
Iteration: 10; Percent complete: 13.7%
Iteration: 11; Percent complete: 15.1%
Iteration: 12; Percent complete: 16.4%
Iteration: 13; Percent complete: 17.8%
Iteration: 14; Percent complete: 19.2%
Iteration: 15; Percent complete: 20.5%
Iteration: 16; Percent complete: 21.9%
Iteration: 17; Percent complete: 23.3%
Iteration: 18; Percent complete: 24.7%
Iteration: 19; Percent complete: 26.0%
Iteration: 20; Percent complete: 27.4%
Iteration: 21; Percent complete: 28.8%
Iteration: 22; Percent complete: 30.1%
Iteration: 23; Percent complete: 31.5%
Iteration: 24; Percent complete: 32.9%
Iteration: 25; Percent complete: 34.2%
Iteration: 26; Percent complete: 35.6%
Iteration: 27; Percent complete: 37.0%
Iteration: 28; Percent complete: 38.4%
Iteration: 29; Percent complete: 39.7%
Iteration: 30; Percent complete: 41.1%
Iteration: 31; Percent complete: 42.5%
Iteration: 32; Percent complete: 43.8%
Iteration: 33; Percent complete: 45.2%
Iteration: 34; Percent complete: 46.6%
Iteration: 35; Percent complete: 47.9%
Iteration: 36; Percent complete: 49.3%
Iteration: 37; Percent complete: 50.7%
Iteration: 38; Percent complete: 52.1%
Iteration: 39; Percent complete: 53.4%
Iteration: 40; Percent complete: 54.8%
Iteration: 41; Percent complete: 56.2%
Iteration: 42; Percent complete: 57.5%
Iteration: 43; Percent complete: 58.9%
Iteration: 44; Percent complete: 60.3%
Iteration: 45; Percent complete: 61.6%
Iteration: 46; Percent complete: 63.0%
Iteration: 47; Percent complete: 64.4%
Iteration: 48; Percent complete: 65.8%
Iteration: 49; Percent complete: 67.1%
Iteration: 50; Percent complete: 68.5%
Iteration: 51; Percent complete: 69.9%
Iteration: 52; Percent complete: 71.2%
Iteration: 53; Percent complete: 72.6%
Iteration: 54; Percent complete: 74.0%
Iteration: 55; Percent complete: 75.3%
Iteration: 56; Percent complete: 76.7%
Iteration: 57; Percent complete: 78.1%
Iteration: 58; Percent complete: 79.5%
Iteration: 59; Percent complete: 80.8%
Iteration: 60; Percent complete: 82.2%
Iteration: 61; Percent complete: 83.6%
Iteration: 62; Percent complete: 84.9%
Iteration: 63; Percent complete: 86.3%
Iteration: 64; Percent complete: 87.7%
Iteration: 65; Percent complete: 89.0%
Iteration: 66; Percent complete: 90.4%
Iteration: 67; Percent complete: 91.8%
Iteration: 68; Percent complete: 93.2%
Iteration: 69; Percent complete: 94.5%
Iteration: 70; Percent complete: 95.9%
Iteration: 71; Percent complete: 97.3%
Iteration: 72; Percent complete: 98.6%
Iteration: 73; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 8.5, Median = 7.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-30-output-18.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="loading-artifacts-utilities" class="level3">
<h3 class="anchored" data-anchor-id="loading-artifacts-utilities">Loading Artifacts Utilities</h3>
<div id="cell-59" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>downpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>defaultpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_run"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>weights_path <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/weighted_run"</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#/work/data/fine_tuning_results/nosampling/run_20250509_090059/corpus_kodis_ground_default</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_artifact(exp_dir: Path, name: <span class="bu">str</span>):</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> exp_dir <span class="op">/</span> name</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.json'</span>)).exists():</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.loads((p.with_suffix(<span class="st">'.json'</span>)).read_text())</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.csv'</span>)).exists():</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(p.with_suffix(<span class="st">'.csv'</span>))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p.is_dir():</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Corpus(filename<span class="op">=</span> <span class="bu">str</span>(p))</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.pt'</span>)).exists():</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.load(p.with_suffix(<span class="st">'.pt'</span>))</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"No artifact </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_all_variants(exp_dir: Path):</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># detect which naming scheme this folder uses</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_downsampled"</span>).is_dir():</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"downsampled"</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_weighted_loss"</span>).is_dir():</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"weighted"</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"default"</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build name‐templates</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    tpl <span class="op">=</span> {</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"downsampled"</span>: {</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_downsampled"</span>,</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_downsampled_conv_df"</span>,</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_downsampled_metrics"</span>,</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_horizon_utterances"</span>,</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_downsampled",</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_downsampled"</span>,</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_downsampled_conv_df"</span>,</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_downsampled_metrics"</span>,</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_horizon_utterances"</span>,</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_downsampled",</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_last_submit_downsampled"</span>,</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_downsampled_conv_df"</span>,</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_downsampled_metrics"</span>,</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_horizon_utterances"</span>,</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_downsampled",</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weighted"</span>: {</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_weighted_loss"</span>,</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_weight_conv_df"</span>,</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_weighted_metrics"</span>,</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_weight_horizon"</span>,</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_weighted",</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_weighted_loss"</span>,</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_weight_conv_df"</span>,</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_weighted_metrics"</span>,</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_weight_horizon"</span>,</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_weighted",</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_weighted_loss"</span>,</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_weight_conv_df"</span>,</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_weighted_metrics"</span>,</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_weight_horizon"</span>,</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_weighted",</span></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"default"</span>: {</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_default"</span>,</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_conv_default_df"</span>,</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_default_metrics"</span>,</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_default_horizon"</span>,</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_default",</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_default"</span>,</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"no_last_conv_df_default"</span>,</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_default_metrics"</span>,</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_default_horizon"</span>,</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_default",</span></span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_last_default"</span>,</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_last_submit_conv_default_df"</span>,</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_default_metrics"</span>,</span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_default_horizon"</span>,</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_last_submit_last_default",</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>    }[variant]</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>        key: load_artifact(exp_dir, fname)</span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, fname <span class="kw">in</span> tpl.items()</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Now load each regime:</span></span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>down <span class="op">=</span> load_all_variants(downpath)</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>no_samp <span class="op">=</span> load_all_variants(defaultpath)</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>wt <span class="op">=</span> load_all_variants(weights_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-artifacts" class="level3">
<h3 class="anchored" data-anchor-id="load-artifacts">Load Artifacts</h3>
<div id="cell-61" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>wiki <span class="op">=</span>{}</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_orig</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_metrics"</span>] <span class="op">=</span> ground_wiki_metrics</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_df"</span>] <span class="op">=</span>  ground_wiki_df</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_horizon"</span>] <span class="op">=</span> ground_wiki_horizon</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nl</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_metrics"</span>] <span class="op">=</span> no_last_wiki_metrics</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_df"</span>] <span class="op">=</span>  no_last_wiki_df</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_horizon"</span>] <span class="op">=</span> no_last_wiki_horizon</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nls</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_metrics"</span>] <span class="op">=</span> no_last_submit_wiki_metrics</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_df"</span>] <span class="op">=</span>  no_last_submit_wiki_df</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_horizon"</span>] <span class="op">=</span> no_last_submit_horizon</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_df"</span>] <span class="op">=</span> wiki[<span class="st">"ground_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_df"</span>] <span class="op">=</span> wiki[<span class="st">"no_last_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_df"</span>] <span class="op">=</span> wiki[<span class="st">"no_last_submit_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>corpora_info_ground <span class="op">=</span> [</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DEFAULT"</span>,</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_df"</span>],</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WEIGHTED"</span>,</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_df"</span>],</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DOWNSAMPLED"</span>,</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_df"</span>],</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>corpora_info_no_last <span class="op">=</span> [</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DEFAULT"</span>,</span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_df"</span>],</span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_WEIGHTED"</span>,</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_df"</span>],</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DOWNSAMPLED"</span>,</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_df"</span>],</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a>corpora_info_no_subm <span class="op">=</span> [</span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DEFAULT"</span>,</span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_df"</span>],</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_WEIGHTED"</span>,</span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_df"</span>],</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DOWNSAMPLED"</span>,</span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_df"</span>],</span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a>    ), (</span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="utterance-variants" class="level3">
<h3 class="anchored" data-anchor-id="utterance-variants">Utterance Variants</h3>
<div id="cell-63" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>corpora_info_downsampled <span class="op">=</span> [</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DOWNSAMPLED"</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_df"</span>],</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DOWNSAMPLED"</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_df"</span>],</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DOWNSAMPLED"</span>,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_df"</span>],</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>corpora_info_weighted <span class="op">=</span> [</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WEIGHTED"</span>,</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_df"</span>],</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_WEIGHTED"</span>,</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_df"</span>],</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_WEIGHTED"</span>,</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_df"</span>],</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>corpora_info_no_sampling <span class="op">=</span> [</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEFAULT_NOSAMP"</span>,</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_df"</span>],</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_NOSAMP"</span>,</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_df"</span>],</span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_NOSAMP"</span>,</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_df"</span>],</span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>