<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michelle Gelman">
<meta name="dcterms.date" content="2025-05-15">

<title>Fine-Tuning Kodis Analysis – Weekly ConvoKit Updates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Weekly ConvoKit Updates</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Current</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../src/fine-tuning_final.html"> 
<span class="menu-text">Fine-Tuning Kodis</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#fine-tuning-configuration" id="toc-fine-tuning-configuration" class="nav-link active" data-scroll-target="#fine-tuning-configuration">Fine-Tuning Configuration:</a>
  <ul class="collapse">
  <li><a href="#data-splits" id="toc-data-splits" class="nav-link" data-scroll-target="#data-splits"><strong>1. Data &amp; Splits</strong></a></li>
  <li><a href="#model-configuration" id="toc-model-configuration" class="nav-link" data-scroll-target="#model-configuration"><strong>2. Model Configuration</strong></a></li>
  <li><a href="#craft-model" id="toc-craft-model" class="nav-link" data-scroll-target="#craft-model"><strong>Craft Model:</strong></a></li>
  <li><a href="#forecaster-training-configuration" id="toc-forecaster-training-configuration" class="nav-link" data-scroll-target="#forecaster-training-configuration"><strong>3. Forecaster Training Configuration</strong></a></li>
  <li><a href="#evaluation-aggregation" id="toc-evaluation-aggregation" class="nav-link" data-scroll-target="#evaluation-aggregation"><strong>5.Evaluation &amp; Aggregation</strong></a></li>
  </ul></li>
  <li><a href="#key-questions" id="toc-key-questions" class="nav-link" data-scroll-target="#key-questions">Key Questions</a></li>
  <li><a href="#current-interpretation" id="toc-current-interpretation" class="nav-link" data-scroll-target="#current-interpretation">Current Interpretation:</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions:</a></li>
  <li><a href="#goals" id="toc-goals" class="nav-link" data-scroll-target="#goals">Goals:</a></li>
  <li><a href="#improvement-considerations" id="toc-improvement-considerations" class="nav-link" data-scroll-target="#improvement-considerations">Improvement Considerations:</a></li>
  <li><a href="#design-decisions" id="toc-design-decisions" class="nav-link" data-scroll-target="#design-decisions">Design Decisions:</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">TODO:</a></li>
  </ul></li>
  <li><a href="#comparison-of-metrics-for-all-model-variants-using-best-threshhold" id="toc-comparison-of-metrics-for-all-model-variants-using-best-threshhold" class="nav-link" data-scroll-target="#comparison-of-metrics-for-all-model-variants-using-best-threshhold">Comparison of Metrics for all Model variants using Best Threshhold</a>
  <ul class="collapse">
  <li><a href="#determining-best-threshold-for-wiki-test-from-wiki-model" id="toc-determining-best-threshold-for-wiki-test-from-wiki-model" class="nav-link" data-scroll-target="#determining-best-threshold-for-wiki-test-from-wiki-model">Determining Best threshold for Wiki test from Wiki Model</a></li>
  </ul></li>
  <li><a href="#differences-in-distributed-probabilities" id="toc-differences-in-distributed-probabilities" class="nav-link" data-scroll-target="#differences-in-distributed-probabilities">Differences in Distributed Probabilities</a>
  <ul class="collapse">
  <li><a href="#model-sensitivity-of-probability-forecast-to-downsampling" id="toc-model-sensitivity-of-probability-forecast-to-downsampling" class="nav-link" data-scroll-target="#model-sensitivity-of-probability-forecast-to-downsampling">Model Sensitivity of Probability Forecast to Downsampling</a></li>
  <li><a href="#model-sensitivity-of-probability-forecast-to-utterance-variability" id="toc-model-sensitivity-of-probability-forecast-to-utterance-variability" class="nav-link" data-scroll-target="#model-sensitivity-of-probability-forecast-to-utterance-variability">Model Sensitivity of Probability Forecast to Utterance Variability</a></li>
  </ul></li>
  <li><a href="#misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" id="toc-misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" class="nav-link" data-scroll-target="#misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling">Misclassified Texts Analysis: No Last Utterance No Submit with Downsampling</a>
  <ul class="collapse">
  <li><a href="#example-misclassified-conversation" id="toc-example-misclassified-conversation" class="nav-link" data-scroll-target="#example-misclassified-conversation">Example Misclassified Conversation</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Utterance Level)</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Conversation Level)</a></li>
  <li><a href="#fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" id="toc-fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="nav-link" data-scroll-target="#fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Derailment for No Last No Submit Agreement Downsampled Model (Utterance Level)</a></li>
  </ul></li>
  <li><a href="#predicition-evolution-overtime" id="toc-predicition-evolution-overtime" class="nav-link" data-scroll-target="#predicition-evolution-overtime">Predicition Evolution Overtime</a>
  <ul class="collapse">
  <li><a href="#ground-wiki-on-wiki-data-test-set" id="toc-ground-wiki-on-wiki-data-test-set" class="nav-link" data-scroll-target="#ground-wiki-on-wiki-data-test-set">Ground wiki on Wiki Data Test Set</a></li>
  <li><a href="#average-length-for-all-kodis-test-set" id="toc-average-length-for-all-kodis-test-set" class="nav-link" data-scroll-target="#average-length-for-all-kodis-test-set">Average length for all KODIS Test set</a></li>
  <li><a href="#ground-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  </ul></li>
  <li><a href="#frustration-correlation" id="toc-frustration-correlation" class="nav-link" data-scroll-target="#frustration-correlation">Frustration Correlation</a>
  <ul class="collapse">
  <li><a href="#no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last Downsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  <li><a href="#no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last No SubmitDownsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  <li><a href="#ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" id="toc-ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="nav-link" data-scroll-target="#ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">Ground Wiki: Correlation with highest predicted score per conversation and avg_frustration frequency</a></li>
  </ul></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions">Utility Functions</a>
  <ul class="collapse">
  <li><a href="#convokit-transformers" id="toc-convokit-transformers" class="nav-link" data-scroll-target="#convokit-transformers">ConvoKit Transformers</a></li>
  <li><a href="#metric-and-plotting-functions" id="toc-metric-and-plotting-functions" class="nav-link" data-scroll-target="#metric-and-plotting-functions">Metric and Plotting Functions</a></li>
  <li><a href="#conversation-utilities" id="toc-conversation-utilities" class="nav-link" data-scroll-target="#conversation-utilities">Conversation Utilities</a></li>
  <li><a href="#fighting-words" id="toc-fighting-words" class="nav-link" data-scroll-target="#fighting-words">Fighting Words</a></li>
  <li><a href="#fighting-words-by-conversation" id="toc-fighting-words-by-conversation" class="nav-link" data-scroll-target="#fighting-words-by-conversation">Fighting Words By conversation</a></li>
  <li><a href="#forecasting-trends" id="toc-forecasting-trends" class="nav-link" data-scroll-target="#forecasting-trends">Forecasting Trends</a></li>
  <li><a href="#kodis-wiki-ground-functions" id="toc-kodis-wiki-ground-functions" class="nav-link" data-scroll-target="#kodis-wiki-ground-functions">KODIS Wiki Ground Functions</a></li>
  <li><a href="#wiki-test-set" id="toc-wiki-test-set" class="nav-link" data-scroll-target="#wiki-test-set">Wiki Test Set</a></li>
  <li><a href="#frustration-correlation-1" id="toc-frustration-correlation-1" class="nav-link" data-scroll-target="#frustration-correlation-1">Frustration Correlation</a></li>
  <li><a href="#loading-artifacts-utilities" id="toc-loading-artifacts-utilities" class="nav-link" data-scroll-target="#loading-artifacts-utilities">Loading Artifacts Utilities</a></li>
  <li><a href="#load-artifacts" id="toc-load-artifacts" class="nav-link" data-scroll-target="#load-artifacts">Load Artifacts</a></li>
  <li><a href="#utterance-variants" id="toc-utterance-variants" class="nav-link" data-scroll-target="#utterance-variants">Utterance Variants</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fine-Tuning Kodis Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michelle Gelman </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="cell-1" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint <span class="im">as</span> pp</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> entropy</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    roc_curve,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    roc_auc_score,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    average_precision_score,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> modules.DataPreprocesser <span class="im">import</span> DataPreprocesser</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> modules <span class="im">import</span> CorpusUtils <span class="im">as</span> corp</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Convokit Imports</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.CRAFTModel <span class="im">import</span> CRAFTModel</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.forecaster <span class="im">import</span> Forecaster</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> download, Corpus</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> Corpus, Speaker, Utterance, Conversation</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.convokitConfig <span class="im">import</span> ConvoKitConfig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-2" class="cell" data-execution_count="203">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>downpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_ground_downsampled"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>defaultpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_run/corpus_kodis_ground_default"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>weights_path <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/weighted_run/corpus_kodis_ground_weighted_loss"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>corpus_down <span class="op">=</span> Corpus(filename<span class="op">=</span>downpath)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>corpus_default <span class="op">=</span> Corpus(filename<span class="op">=</span>defaultpath)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>corpus_weighted <span class="op">=</span> Corpus(filename<span class="op">=</span>weights_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="fine-tuning-configuration" class="level1">
<h1>Fine-Tuning Configuration:</h1>
<ul>
<li><a href="">Forecaster Model</a></li>
</ul>
<section id="data-splits" class="level3">
<h3 class="anchored" data-anchor-id="data-splits"><strong>1. Data &amp; Splits</strong></h3>
<ul>
<li>Corpus: 2,107 buyer–seller disputes. No AI.</li>
<li>Train/Val/Test: 60/20/20 split (1,264 / 421 / 421 conversations).
<ul>
<li>random-seed: 42 (for reproducibility)</li>
</ul></li>
</ul>
</section>
<section id="model-configuration" class="level3">
<h3 class="anchored" data-anchor-id="model-configuration"><strong>2. Model Configuration</strong></h3>
<section id="total-models-fine-tuned-9-3x3-fine-tuned-model-configurations-paired-as-imbalance-variant-x-context-selection" class="level4">
<h4 class="anchored" data-anchor-id="total-models-fine-tuned-9-3x3-fine-tuned-model-configurations-paired-as-imbalance-variant-x-context-selection"><strong>Total models fine-tuned:</strong> 9 (3x3) fine-tuned model configurations, paired as (imbalance variant x context-selection)</h4>
</section>
<section id="baseline-comparison-model-wiki-fine-tuned-model" class="level4">
<h4 class="anchored" data-anchor-id="baseline-comparison-model-wiki-fine-tuned-model"><strong>Baseline comparison model:</strong> Wiki fine-tuned model</h4>
<p><strong>Pre-trained fixed model parameters: pre-wiki trained CRAFT model</strong> - the utterance‑encoder’s state_dict - the context‑encoder’s state_dict - the word‑embedding layer’s state_dict - Vocabulary size (tokenization): <a href="https://colab.research.google.com/drive/1GvICZN0VwZQSWw3pJaEVY-EQGoO-L5lH?utm_source=chatgpt.com">50004: it was built using a fixed vocab size of 50k plus 4 spots for special tokens PAD, SOS, EOS, and UNK</a></p>
<pre><code>```
voc = loadPrecomputedVoc("wikiconv", WORD2INDEX_URL, INDEX2WORD_URL)
```
- used in CRAFT Model to tokenize context tuples:

```
def processContext(voc, context, is_attack):
(...)
    utterance.meta["craft_tokens"] = tokenize(voc, utterance.text)

```</code></pre>
<p><strong>Fine-tuning affects:</strong> - atk_clf”: attack_clf.state_dict()</p>
</section>
</section>
<section id="craft-model" class="level3">
<h3 class="anchored" data-anchor-id="craft-model"><strong>Craft Model:</strong></h3>
<pre><code>{
    "iteration": iteration,
    "en": encoder.state_dict(),
    "ctx": context_encoder.state_dict(),
    "atk_clf": attack_clf.state_dict(),
    "en_opt": encoder_optimizer.state_dict(),
    "ctx_opt": context_encoder_optimizer.state_dict(),
    "atk_clf_opt": attack_clf_optimizer.state_dict(),
    "loss": loss,
    "voc_dict": voc.__dict__,
    "embedding": embedding.state_dict(),
}</code></pre>
<ul>
<li>Conversation-selection Training Logic: last context-tuple (entire conversation history up to last utterance) for all conversations</li>
</ul>
<p><strong>DEFAULT_CONFIG from CRAFT backend</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Parameter</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dropout</td>
<td>0.1</td>
</tr>
<tr class="even">
<td>batch_size</td>
<td>64</td>
</tr>
<tr class="odd">
<td>clip</td>
<td>50.0</td>
</tr>
<tr class="even">
<td>learning_rate</td>
<td>1e-5</td>
</tr>
<tr class="odd">
<td>print_every</td>
<td>10</td>
</tr>
<tr class="even">
<td>finetune_epochs</td>
<td>30</td>
</tr>
<tr class="odd">
<td>validation_size</td>
<td>0.2</td>
</tr>
</tbody>
</table>
<section id="training-set-preprocessing-variants" class="level4">
<h4 class="anchored" data-anchor-id="training-set-preprocessing-variants"><strong>2.1. Training Set Preprocessing Variants</strong></h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 81%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Variant</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Ground</strong></td>
<td>All utterances up to (and including) the final one marked as derailment</td>
</tr>
<tr class="even">
<td><strong>No‑Last</strong></td>
<td>All utterances except the final comment (i.e.&nbsp;drop the last utterance)</td>
</tr>
<tr class="odd">
<td><strong>No‑Last‑No‑Submit</strong></td>
<td>As <strong>No‑Last</strong>, plus remove any “Submitted agreement” system messages from the remaining text</td>
</tr>
</tbody>
</table>
</section>
<section id="class-imbalance-variants-variants" class="level4">
<h4 class="anchored" data-anchor-id="class-imbalance-variants-variants"><strong>2.2. Class Imbalance Variants Variants</strong></h4>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 51%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Regime</th>
<th>Loss</th>
<th>Sampling</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Default</strong></td>
<td>Standard binary cross‐entropy (BCE)</td>
<td>Train Set (1264): (1044 success, 220 impasse)</td>
</tr>
<tr class="even">
<td><strong>Weighted</strong></td>
<td>BCE with class‐weighted loss (higher weight on the minority “derail” class)</td>
<td>Train Set(1264) : (1044 success, 220 impasse)</td>
</tr>
<tr class="odd">
<td><strong>Downsampled</strong></td>
<td>BCE, but training set downsampled to a 1:1 class ratio</td>
<td>Train Set (1264): (220 succes,220 impasse)</td>
</tr>
</tbody>
</table>
<p>Modify train.py:</p>
<pre><code>loss = F.binary_cross_entropy_with_logits(logits, labels) -&gt; loss_fn = nn.BCEWithLogitsLoss(pos_weight=attack_clf.pos_weight)</code></pre>
<p>Compute pos_weight by counting number of pos/neg contexts tuples:</p>
<pre><code>train_pairs = self._context_to_craft_data(iter(contexts))
labels = [label for (_ctx, _utt, label, _id) in train_pairs]
num_pos = sum(labels)
num_neg = len(labels) - num_pos
self._pos_weight = torch.tensor(num_neg / num_pos, device=self._device)</code></pre>
</section>
</section>
<section id="forecaster-training-configuration" class="level3">
<h3 class="anchored" data-anchor-id="forecaster-training-configuration"><strong>3. Forecaster Training Configuration</strong></h3>
<section id="number-of-runs-9-total.-1-for-each-variant-with-same-traintestsplit-seed-42" class="level4">
<h4 class="anchored" data-anchor-id="number-of-runs-9-total.-1-for-each-variant-with-same-traintestsplit-seed-42"><strong>Number of Runs</strong>: 9 total. 1 for each variant with same train/test/split seed (42)</h4>
<ul>
<li><strong>Forecaster:</strong> uses CRAFT Backend, writes conversation.meta[“prediction”] (0/1) and meta[“pred_score”] (probability) for all utterances in training set variants</li>
<li><strong>Default threshold:</strong> 0.54 for binary decision in any utterance to classifiy conversation as impasse (1)</li>
<li><strong>Optimized threshold</strong>: per‐variant “best” threshold chosen via Youden’s J (maximize TPR – FPR) on the test set from conversation-level AUC/PR Curves across variants</li>
</ul>
</section>
</section>
<section id="evaluation-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-aggregation"><strong>5.Evaluation &amp; Aggregation</strong></h3>
<section id="evaluation-test-set-421-convsersations.-uses-original-ground-variant." class="level4">
<h4 class="anchored" data-anchor-id="evaluation-test-set-421-convsersations.-uses-original-ground-variant."><strong>Evaluation:</strong> Test Set (421 Convsersations). Uses Original Ground Variant.</h4>
</section>
<section id="initial-analysis" class="level4">
<h4 class="anchored" data-anchor-id="initial-analysis"><strong>5.1. Initial Analysis</strong></h4>
<ul>
<li>Accuracy, Precision, Recall (TPR), FPR, F1</li>
<li>AUC / PR curves (using max pred_score from each conversation)</li>
<li>Horizon plots: aggregate utterance‐position forecast scores to visualize how early derailment is detected.</li>
</ul>
</section>
<section id="secondary-analysis" class="level4">
<h4 class="anchored" data-anchor-id="secondary-analysis"><strong>5.2. Secondary Analysis</strong></h4>
<ul>
<li><strong>Best‐Threshold Performance</strong>(accuracy, TPR, FPR, F1, J index, threshold)</li>
<li><strong>Forecast Score Evolution Trends Over Conversational Contexts:</strong> Compares evolution of avg.(across conversations) of forecast score per utterance for each model broken out by impasse and success.</li>
<li><strong>Self‑report Avg. Frustration CVorrelation with Max Prediction:</strong> Pearson r and linear regression (R²) Between each convo’s max_pred_score (highest utterance probability) and its avg_frustration_score.</li>
<li><strong>Probability Score Distribution:</strong> Explore sensitivity of probability scores across utterances for models, controlling for imbalance or training set variants</li>
<li><strong>Fighing Words:</strong> Comparing <a href="https://www.cambridge.org/core/journals/political-analysis/article/fightin-words-lexical-feature-selection-and-evaluation-for-identifying-the-content-of-political-conflict/81B3703230D21620B81EB6E2266C7A66">Fighting words</a> between Misclassified True Derailed Conversations class and Correctly Classified Successful Conversations class
<ul>
<li>Comparing n-gram log-odds ratio versus frequency of word on per utterance and per conversation basis</li>
<li>Using vocabulary generated stricly from all classes (not entire corpus). Default prior (occ. of n-gram) set to .1 as default</li>
<li>Y-axis: Prevalance of word within the Class. negative = class2, positive = class1</li>
<li>X- axis: Occurence of n-gram within associated class.</li>
<li>Z-score: tells you how many “standard deviations” away from zero the log‑odds difference is. Comparing “class 1 vs.&nbsp;class 2” directly</li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="key-questions" class="level1">
<h1>Key Questions</h1>
<section id="question-is-forecasters-conversation-level-derailment-score-a-good-indicator-of-objective-dispute-outcome" class="level4">
<h4 class="anchored" data-anchor-id="question-is-forecasters-conversation-level-derailment-score-a-good-indicator-of-objective-dispute-outcome"><strong>Question: Is Forecaster’s Conversation-level derailment score a good indicator of objective dispute outcome?</strong></h4>
<ul>
<li><strong>IV</strong>: Max Derailment Score assigned to conversation selected from utterance-level scores</li>
<li><strong>DV</strong>: Dispute Outcome: measured by success/impasse</li>
</ul>
</section>
<section id="question-do-fine-tuned-model-variants-affect-crafts-max-conversation-derailment-score" class="level4">
<h4 class="anchored" data-anchor-id="question-do-fine-tuned-model-variants-affect-crafts-max-conversation-derailment-score"><strong>Question: Do fine-tuned Model Variants affect CRAFT’s Max Conversation Derailment score?</strong></h4>
<ul>
<li><strong>DV</strong>: Model variant for imbalance and utterance exposure.
<ul>
<li>Variant Condition: Imbalance Technique</li>
<li>Variant Condition: Utterances exposed</li>
</ul></li>
<li><strong>IV 1</strong>: Mean of Max Derailment probabilities for test conversations (Does one variant cause higher avg. max forecasts?)</li>
<li><strong>IV 2</strong>: Variance of Max Derailment probabilities for test conversations (Does one variant cause higher avg. variances across all max convo forecasts?)</li>
</ul>
</section>
<section id="question-do-fine-tuned-model-variants-affect-crafts-avg.-forecasted-utterance-probablity-trends-as-conversation-evolves" class="level4">
<h4 class="anchored" data-anchor-id="question-do-fine-tuned-model-variants-affect-crafts-avg.-forecasted-utterance-probablity-trends-as-conversation-evolves"><strong>Question: Do fine-tuned Model variants affect CRAFT’s avg. Forecasted Utterance Probablity Trends as Conversation Evolves?</strong></h4>
<ul>
<li><strong>DV</strong>: Model variant for imbalance and utterance exposure.
<ul>
<li>Variant Condition: Imbalance Technique</li>
<li>Variant Condition: Utterances exposed</li>
</ul></li>
<li><strong>IV 1</strong>: Mean, variance of Max Derailment probabilities for test conversations</li>
</ul>
</section>
<section id="question-what-artifacts-is-forecaster-picking-up-as-signal-in-making-predicitons" class="level4">
<h4 class="anchored" data-anchor-id="question-what-artifacts-is-forecaster-picking-up-as-signal-in-making-predicitons"><strong>Question: What Artifacts is Forecaster picking up as signal in making predicitons?</strong></h4>
<ul>
<li>look at fighting words between Correctly predicted True derailmenets (TP) and Falsely Predicited True Derailments (FN)</li>
<li>How significant is repetitive token bias</li>
</ul>
</section>
<section id="question-can-fine-tuned-kodis-models-pick-up-conversational-context-trends-as-well-as-ground-wiki-fine-tuned-model" class="level4">
<h4 class="anchored" data-anchor-id="question-can-fine-tuned-kodis-models-pick-up-conversational-context-trends-as-well-as-ground-wiki-fine-tuned-model"><strong>Question: Can fine-tuned KODIS models pick up conversational context trends as well as ground wiki fine-tuned model?</strong></h4>
<ul>
<li>On wiki test set, the avg. utterance probabilities are more well defined
<ul>
<li>dip for success</li>
<li>more upward for impasses</li>
<li>both trend upwards at longer conversations lengths</li>
</ul></li>
</ul>
</section>
</section>
<section id="current-interpretation" class="level1">
<h1>Current Interpretation:</h1>
<p><strong>In summary, even with ground KODIS test set there is more variability in the max conversation probability as indicated by the probability distribution of max conversation predictions for the Ground Wiki fine-tuned model. Indicates:</strong> - Kodis fine-tuned models learn certian biases in tokens from ground truth and submit agreement labels. - Predicted avg. utt forecast evolution trends for no last/no submit similar to ground wiki model. May be something with repetitve phrases.</p>
<ul>
<li>The ground default model (perfectly classifying test set) pays attention less to other convesation dynamics and more to label?
<ul>
<li>Predicted avg. utt forcast evolution trends are much less variable for impasse on ground default.</li>
</ul></li>
<li><label><input type="checkbox">Compare model runs with custom vocabulary both from wiki and from CRAFT.</label>
<ul>
<li>Wiki Vocabulary size (tokenization): <a href="https://colab.research.google.com/drive/1GvICZN0VwZQSWw3pJaEVY-EQGoO-L5lH?utm_source=chatgpt.com">50004: it was built using a fixed vocab size of 50k plus 4 spots for special tokens PAD, SOS, EOS, and UNK</a></li>
</ul></li>
</ul>
<p><strong>Including the submit agreement boxes makes our fine-tuned models more prone to forecasting very similar scores for all conversations as indicated by the forecast score evolution and probabilitity distribution comparisons.</strong> - Variance in the max predicted conversation derailment probability is near 0 for fine-tuned models that include submit agrement boxes. - Hiding submission agreement gave more distinct dips (lower) in succesfull dispute avg. utterance probabilities as disputes continue over time, whereas impasse disuptes have more distinct upwards (higher) avg. utterance probabilities as disputes continue over time.</p>
<ul>
<li>There is more jitter due to noise for longer conversations since avg. conversation length is 10.3 (?).</li>
</ul>
<p><strong>No last no submit downsampled (T = .75) gave the best threshold closests to ground model (T = .88) on TEST SET. Rest of models close to .5ish. Out of the box derailment threshold is .54 for wiki/cmv datasets.</strong> - Using wiki test set, wiki ground uses .54 as default threshold prediction. T his does not align with using youden’s method or F1-Max score to make metrics better from test set -&gt; at what point in model training was this threshold computed? - [ ] think of logic for selecting best threshold to predict on for KODIS</p>
<p><strong>Caveat with Current Fighting Words Analysis:</strong> - The test set includes all utterances, so the fighting words assessed across both classes include words like “walk away” when the fine-tuned model was not exposed to them. - [ ] Do fighting words with fine-tuned vocabulary</p>
<p><strong>Caveat with All Models:</strong> - The metrics are not consistent due to unreproducability from randomization in the training pipeline in fine-tuning CRAFT. - Though initial train/test/val split is same, the few downsampling training runs had high accuracy variablitiy (27% to 80%) - [ ] Think about what model parameters to vary.</p>
<section id="questions" class="level2">
<h2 class="anchored" data-anchor-id="questions">Questions:</h2>
<ul>
<li>Want to know how to better analyze mispredictions
<ul>
<li>Fighting Words unclear still. Tried training vocabulary both on entire corpus and on just chosesn TP/FP/TN/FP Subsets. Vary n-gram (length of phrases). Unsure about whether or not to include stopping_words or use priors from entire corpus</li>
</ul></li>
<li>Ground wiki picked up high best decision threshold (.88), while most others around .55-.75</li>
<li>No submit no last variants most similar to ground_wiki in terms of confusion matrix and metrics(theshold as well, .75)</li>
<li>Weighted variants overfitting I think. All Impasse mispredicted as success.</li>
<li>No last no submit closest to ground wiki model. Also has similar utterance aggregtaed prediction score trends across impasse and success dialogues</li>
<li>The few downsampling training runs had high accuracy variablitiy (27% to 80%) meaning fine-tuning is not entirely reproducible despite controlling for same training/test/split</li>
<li>AUC/PR curved looked good (better than baseline for all model)</li>
<li>Caviates to having high prediction threshold?</li>
<li>Should we use custom pre-trained vocabulary and try fine-tuning as well?</li>
<li>K-cross fold validation on training set?</li>
</ul>
</section>
<section id="goals" class="level2">
<h2 class="anchored" data-anchor-id="goals">Goals:</h2>
<ul>
<li>Define conference target and paper goals to guide interpretation and futher testing</li>
<li>Define characteristics of derailment for dispute-type dialogues</li>
<li>What does the model pick up in a dispute to forecast derailment when predicting probability over-time</li>
</ul>
</section>
<section id="improvement-considerations" class="level2">
<h2 class="anchored" data-anchor-id="improvement-considerations">Improvement Considerations:</h2>
<ul>
<li>Including Learning‑rate scheduling or early stopping to stop training early when it converges to prevent overfitting/underfitting</li>
<li>Full-end to end training with testing model_config parameters to improve metrics</li>
<li>k-fold cross validation</li>
<li>use custom vocabulary and try fine-tuning(word2vec, vec2word)</li>
</ul>
</section>
<section id="design-decisions" class="level2">
<h2 class="anchored" data-anchor-id="design-decisions">Design Decisions:</h2>
<ul>
<li>Do we include submit agreements or no? Lose out on potential dispute dynamics with chains of submit agreements</li>
<li>Test on ground kodis conversations?</li>
<li>Revalant Analysis considerations?</li>
<li>Establishing a baseline for expected predicted probability trends based on artifacts in success/dispute convos</li>
<li>Sentiment granularity: comparing utterance level predicitons with conversational-level self-report scores</li>
<li>Predicting SVI (self, fairness, outcome, relationships). Predict Frustration?</li>
</ul>
</section>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO:</h2>
<ul class="task-list">
<li><label><input type="checkbox">Go over CARC tutortial + set up GPU</label></li>
<li><label><input type="checkbox">Predict SVI (relationships, frustration, outcome, impasse)</label></li>
<li><label><input type="checkbox">Establish goals for publicaiton + applicaitions of forecaster as next steps?</label></li>
</ul>
</section>
</section>
<section id="comparison-of-metrics-for-all-model-variants-using-best-threshhold" class="level1">
<h1>Comparison of Metrics for all Model variants using Best Threshhold</h1>
<div id="cell-6" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ground_thresholds, ground_metrics, ground_corpora <span class="op">=</span> compare_craft_models(corpora_info_ground)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>no_last_thresholds, no_last_metrics, no_last_corpora <span class="op">=</span> compare_craft_models(corpora_info_no_last)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>no_subm_thresholds, no_subm_metrics, no_subm_corpora <span class="op">=</span> compare_craft_models(corpora_info_no_subm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-7" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>allmetrics <span class="op">=</span> {}</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>allmetrics.update(ground_metrics)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>allmetrics.update(no_last_metrics)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>allmetrics.update(no_subm_metrics)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>allcorpora <span class="op">=</span> {}</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>allcorpora.update(ground_corpora)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>allcorpora.update(no_last_corpora)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>allcorpora.update(no_subm_corpora)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>compare_best_model_metrics(allmetrics, ground_corpora)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion(ground_thresholds, ground_metrics, ground_corpora)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion(no_last_thresholds, ground_metrics,  no_last_corpora)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>compare_best_model_confusion( no_subm_thresholds, no_subm_metrics, no_subm_corpora)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Conversation‑level Best Threshold Test Set Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
<th data-quarto-table-cell-role="th">Best Threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DEFAULT</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.541032</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.575249</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED</td>
<td>0.850711</td>
<td>0.556818</td>
<td>0.671233</td>
<td>0.111748</td>
<td>0.608696</td>
<td>0.580783</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.749409</td>
<td>0.374046</td>
<td>0.671233</td>
<td>0.234286</td>
<td>0.480392</td>
<td>0.885502</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DEFAULT</td>
<td>0.535545</td>
<td>0.226667</td>
<td>0.698630</td>
<td>0.498567</td>
<td>0.342282</td>
<td>0.555385</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.576696</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED</td>
<td>0.431280</td>
<td>0.218855</td>
<td>0.890411</td>
<td>0.664756</td>
<td>0.351351</td>
<td>0.559719</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT</td>
<td>0.696682</td>
<td>0.337278</td>
<td>0.780822</td>
<td>0.320917</td>
<td>0.471074</td>
<td>0.521406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED</td>
<td>0.739336</td>
<td>0.366906</td>
<td>0.698630</td>
<td>0.252149</td>
<td>0.481132</td>
<td>0.497068</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED</td>
<td>0.765403</td>
<td>0.404412</td>
<td>0.753425</td>
<td>0.232092</td>
<td>0.526316</td>
<td>0.757998</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-5-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
</div>
<section id="determining-best-threshold-for-wiki-test-from-wiki-model" class="level3">
<h3 class="anchored" data-anchor-id="determining-best-threshold-for-wiki-test-from-wiki-model">Determining Best threshold for Wiki test from Wiki Model</h3>
<ul>
<li>Using test set, wiki ground uses .54 as default threshold prediction. This does not align with using youden’s method or F1-Max score to make metrics better from test set -&gt; at what point in model training was this threshold computed?</li>
</ul>
<div id="1ad32c2e" class="cell" data-execution_count="225">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    roc_curve,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    auc,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_best_thresholds(y_true, y_scores):</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- ROC / Youden’s J ---</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, roc_thresh <span class="op">=</span> roc_curve(y_true, y_scores)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    j_stat <span class="op">=</span> tpr <span class="op">-</span> fpr</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    best_roc_idx    <span class="op">=</span> np.argmax(j_stat)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    best_roc_thresh <span class="op">=</span> roc_thresh[best_roc_idx]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    best_roc_j      <span class="op">=</span> j_stat[best_roc_idx]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Precision–Recall / F₁‑max ---</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    prec, rec, pr_thresh <span class="op">=</span> precision_recall_curve(y_true, y_scores)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pr_thresh has length len(prec)-1, matching prec[1:], rec[1:]</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    f1_scores <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> prec <span class="op">*</span> rec <span class="op">/</span> (prec <span class="op">+</span> rec <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    best_pr_idx    <span class="op">=</span> np.nanargmax(f1_scores)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># guard against picking the “zero‑threshold” at idx=0</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_pr_idx <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        best_pr_idx <span class="op">=</span> np.nanargmax(f1_scores[<span class="dv">1</span>:]) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    best_pr_thresh <span class="op">=</span> pr_thresh[best_pr_idx <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    best_pr_f1     <span class="op">=</span> f1_scores[best_pr_idx]</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"roc_curve"</span>:          (fpr, tpr, roc_thresh),</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pr_curve"</span>:           (prec, rec, pr_thresh),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_roc_idx"</span>:       best_roc_idx,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_roc_threshold"</span>: best_roc_thresh,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_roc_j"</span>:         best_roc_j,</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_pr_idx"</span>:        best_pr_idx,</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_pr_threshold"</span>:  best_pr_thresh,</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"best_pr_f1"</span>:         best_pr_f1,</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_conv_level_scores(corpus, split<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>                          label_field<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>):</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) restrict to test conversations</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    conv_df <span class="op">=</span> corpus.get_conversations_dataframe()</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    test_ids <span class="op">=</span> conv_df.loc[conv_df[<span class="st">'meta.split'</span>] <span class="op">==</span> split].index</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) utterance-level preds</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    utt <span class="op">=</span> (</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        corpus</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        .get_utterances_dataframe()[[<span class="st">"conversation_id"</span>, <span class="ss">f"meta.pred_score"</span>]]</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    utt <span class="op">=</span> utt[utt[<span class="st">"conversation_id"</span>].isin(test_ids)]</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) conversation-level score = max utterance score</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    conv_scores <span class="op">=</span> utt.groupby(<span class="st">"conversation_id"</span>)[<span class="ss">f"meta.pred_score"</span>].<span class="bu">max</span>()</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    conv_scores <span class="op">=</span> conv_scores.reindex(test_ids, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) true labels for those same test conversations</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    y_true   <span class="op">=</span> conv_df.loc[test_ids, <span class="ss">f"meta.</span><span class="sc">{</span>label_field<span class="sc">}</span><span class="ss">"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    y_scores <span class="op">=</span> conv_scores.values</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y_true, y_scores</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_baseline_accuracy(corpus, split<span class="op">=</span><span class="st">"test"</span>, label_field<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>):</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    conv_df <span class="op">=</span> corpus.get_conversations_dataframe()</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> conv_df[conv_df[<span class="st">'meta.split'</span>] <span class="op">==</span> split]</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    counts  <span class="op">=</span> test_df[<span class="ss">f"meta.</span><span class="sc">{</span>label_field<span class="sc">}</span><span class="ss">"</span>].value_counts()</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    maj     <span class="op">=</span> counts.idxmax()</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    baseline_acc <span class="op">=</span> counts.<span class="bu">max</span>() <span class="op">/</span> counts.<span class="bu">sum</span>()</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Test‑split baseline (always predict </span><span class="sc">{</span>maj<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>baseline_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="co"># === USAGE ===</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) pull out test‑split labels &amp; scores</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>y_test, scores_test <span class="op">=</span> get_conv_level_scores(corpus_wiki,</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>                                            split<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>                                            label_field<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) quick sanity checks</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>conv_df <span class="op">=</span> corpus_wiki.get_conversations_dataframe()</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"split counts:</span><span class="ch">\n</span><span class="st">"</span>, conv_df[<span class="st">'meta.split'</span>].value_counts(), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"test‑split label counts:</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>      conv_df.loc[conv_df[<span class="st">'meta.split'</span>]<span class="op">==</span><span class="st">"test"</span>,<span class="st">'meta.conversation_has_personal_attack'</span>]</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>             .value_counts(), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Positive (attack) rate on test: </span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>print_baseline_accuracy(corpus_wiki,</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>                        split<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>                        label_field<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>)</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) find your best thresholds</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>best <span class="op">=</span> find_best_thresholds(y_test, scores_test)</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"▶ Youden’s J max = </span><span class="sc">{</span>best[<span class="st">'best_roc_j'</span>]<span class="sc">:.3f}</span><span class="ss"> at thresh </span><span class="sc">{</span>best[<span class="st">'best_roc_threshold'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"▶ F₁‑max   = </span><span class="sc">{</span>best[<span class="st">'best_pr_f1'</span>]<span class="sc">:.3f}</span><span class="ss"> at thresh </span><span class="sc">{</span>best[<span class="st">'best_pr_threshold'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) unpack curve data &amp; indices</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>fpr, tpr, roc_thresh <span class="op">=</span> best[<span class="st">"roc_curve"</span>]</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>prec, rec, pr_thresh <span class="op">=</span> best[<span class="st">"pr_curve"</span>]</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>i_roc <span class="op">=</span> best[<span class="st">"best_roc_idx"</span>]</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>i_pr  <span class="op">=</span> best[<span class="st">"best_pr_idx"</span>]</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) plot</span></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>,figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>ax1.plot(fpr, tpr,         label<span class="op">=</span><span class="st">"ROC"</span>)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>ax1.scatter(fpr[i_roc], tpr[i_roc], c<span class="op">=</span><span class="st">"red"</span>, s<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f"Youden J @ </span><span class="sc">{</span>best[<span class="st">'best_roc_threshold'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>ax1.<span class="bu">set</span>(title<span class="op">=</span><span class="st">"ROC Curve"</span>, xlabel<span class="op">=</span><span class="st">"FPR"</span>, ylabel<span class="op">=</span><span class="st">"TPR"</span>)</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>ax2.plot(rec, prec,         label<span class="op">=</span><span class="st">"PR"</span>)</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>ax2.scatter(rec[i_pr], prec[i_pr], c<span class="op">=</span><span class="st">"red"</span>, s<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f"F₁ @ </span><span class="sc">{</span>best[<span class="st">'best_pr_threshold'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>ax2.<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Precision–Recall Curve"</span>, xlabel<span class="op">=</span><span class="st">"Recall"</span>, ylabel<span class="op">=</span><span class="st">"Precision"</span>)</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>split counts:
 meta.split
train    2508
test      840
val       840
Name: count, dtype: int64 

test‑split label counts:
 meta.conversation_has_personal_attack
False    420
True     420
Name: count, dtype: int64 

Positive (attack) rate on test: 50.00%
Test‑split baseline (always predict False): 0.500
▶ Youden’s J max = 0.510 at thresh 0.740
▶ F₁‑max   = 0.780 at thresh 0.713</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4d3ee2e3" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>compare_craft_models(corpora_info_wiki)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>find_avg_conversation_length(corpus_wiki)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> avg_length_by_split_and_label(corpus_wiki, split_key<span class="op">=</span><span class="st">"split"</span>, label_key<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Avg. Conversation Length ==
  WIKI_TEST_SET         train=7.2  test=7.1

== Conversation‑level Test Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">WIKI_TEST_SET</td>
<td>0.704762</td>
<td>0.638264</td>
<td>0.945238</td>
<td>0.535714</td>
<td>0.761996</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-7-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-7-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-7-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>WIKI_TEST_SET        best thr=0.740, TPR=0.850, FPR=0.340, J=0.510</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-7-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== Summary of Convo Acc &amp; Avg Prob ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">WIKI_TEST_SET_acc</th>
<th data-quarto-table-cell-role="th">WIKI_TEST_SET_avg_prob</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">conversation_level</td>
<td>0.704762</td>
<td>0.742258</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="241">
<pre><code>7.168338108882521</code></pre>
</div>
</div>
</section>
</section>
<section id="differences-in-distributed-probabilities" class="level1">
<h1>Differences in Distributed Probabilities</h1>
<div id="cell-12" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>all_corpora_by_downsampling_comp <span class="op">=</span> [corpora_info_ground, corpora_info_no_last, corpora_info_no_subm]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>all_corpora_by_utterance_comp <span class="op">=</span> [corpora_info_no_sampling, corpora_info_downsampled, corpora_info_weighted]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="model-sensitivity-of-probability-forecast-to-downsampling" class="level3">
<h3 class="anchored" data-anchor-id="model-sensitivity-of-probability-forecast-to-downsampling">Model Sensitivity of Probability Forecast to Downsampling</h3>
<div id="cell-14" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>compare_best_model_convo_histograms(all_corpora_by_downsampling_comp, title_key<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-sensitivity-of-probability-forecast-to-utterance-variability" class="level3">
<h3 class="anchored" data-anchor-id="model-sensitivity-of-probability-forecast-to-utterance-variability">Model Sensitivity of Probability Forecast to Utterance Variability</h3>
<div id="cell-16" class="cell" data-execution_count="206">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>compare_best_model_convo_histograms(all_corpora_by_utterance_comp, title_key<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="misclassified-texts-analysis-no-last-utterance-no-submit-with-downsampling" class="level1">
<h1>Misclassified Texts Analysis: No Last Utterance No Submit with Downsampling</h1>
<div id="cell-18" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred <span class="op">=</span> no_last_downsampled_mispred.filter_conversations_by(selector<span class="op">=</span> convo_selector)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_mispred, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_mispred<span class="op">=</span> no_last_downsampled_mispred.filter_conversations_by(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"best_forecast"</span>) <span class="op">!=</span> convo.meta.get(<span class="st">"label"</span>))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true <span class="op">=</span> no_last_downsampled_true.filter_conversations_by(selector<span class="op">=</span> convo_selector)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_true, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_true<span class="op">=</span> no_last_downsampled_true.filter_conversations_by(</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"best_forecast"</span>) <span class="op">==</span> convo.meta.get(<span class="st">"label"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="example-misclassified-conversation" class="level3">
<h3 class="anchored" data-anchor-id="example-misclassified-conversation">Example Misclassified Conversation</h3>
<div id="cell-20" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>print_conversation(no_last_downsampled_mispred, <span class="st">"utt0_con67"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buyer_67: You know the site was advertising a Kobe Bryant jersey so that's what I should be still entitled to receive.
Seller_67: Hello, I'm sorry but I think there was misunderstanding. The jersey that I was selling wasn't for any particular player.
Buyer_67: You had originally stated that it was a Bryant jersey, no one would have bought it for the second rate player that is on the jersey you set me.
Seller_67: I never stated that, nor have I ever talked to you. You simply purchased the jersey and I sent it to you. I am willing to work with you if you're that unhappy, but you have to understand where I am coming from too.
Buyer_67: The advertising stated that I know I wasn't talking to you directly are you willing to refund me for the purchase?
Seller_67: No, I can't refund you. You purchased the jersey under the listing that never stated any particular name. Are you able to review the listing again?
Buyer_67: You've conveniently altered the listing so that it indicates no specific player, the original listing, did in fact state it was for a Kobe Bryant jersey.
Seller_67: That's not possible for me to alter the listing. The listing is the same as the one you purchased. I can see how you could have misread or thought it was a specific player. So, If you apologize I will apologize as well.
Buyer_67: I'll accept the retraction of your bad review, I don't need the unwarranted hit to my rep.
Seller_67: Okay, I will also apologize for the misunderstanding with the listing and next time I will provide a clear detail in the listings for future customers.
Buyer_67: Thank you that's fine
Seller_67: Will you please also retract the bad review that you wrote me?
Buyer_67: I will, this one time, but if you try that kind of deal again I'm going to screen print the original screen it and let the site know what you're up to.
Seller_67: It was never my intention to deceive anyone. I apologize for the misunderstanding and wish you a good rest of your week.
Buyer_67: Submitted agreement: Buyer gets no refund, buyer retracted their review, seller kept their review, buyer did apologize, and seller didn't apologize.
Seller_67: Reject Deal
Seller_67: Submitted agreement: Buyer gets no refund, buyer retracted their review, seller retracted their review, buyer did apologize, and seller didn't apologize.
Buyer_67: Accept Deal</code></pre>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Utterance Level)</h3>
<div id="cell-22" class="cell" data-execution_count="182">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display(no_last_downsampled.get_utterances_dataframe()[["text", "meta.pred_score"]])</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_fr <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_downsampled'</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_downsampled_fr, threshold<span class="op">=</span><span class="fl">0.5597192049026489</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>f_model, z_df_utt<span class="op">=</span> analyze_mispredicted_fighting_words(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"false_pos_true_neg"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>display(z_df_utt.head(<span class="dv">10</span>)) </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>display(z_df_utt.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 3157 valid corpus components. class2_func returned 1369 valid corpus components.
Vocab size is 684
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">deal</td>
<td>-6.718907</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">yes</td>
<td>-6.428303</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">thank</td>
<td>-6.114948</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">broken</td>
<td>-5.905448</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bad review</td>
<td>-5.232216</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">retract bad review</td>
<td>-4.881626</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">retract bad</td>
<td>-4.874775</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ok</td>
<td>-4.812029</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">accept deal</td>
<td>-4.678088</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bad</td>
<td>-4.660040</td>
<td>True Success</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">listing</td>
<td>3.131796</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">specific</td>
<td>3.138968</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant jersey</td>
<td>4.292191</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant jersey</td>
<td>4.718836</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">website</td>
<td>5.338543</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">player</td>
<td>5.492360</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant</td>
<td>5.771620</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kobe</td>
<td>6.207311</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bryant</td>
<td>6.473314</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">jersey</td>
<td>9.604167</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-sucess-for-no-last-no-submit-agreement-downsampled-model-conversation-level">Fighting Words Analysis Example: False Derailment vs True Sucess for No Last No Submit Agreement Downsampled Model (Conversation Level)</h3>
<div id="cell-24" class="cell" data-execution_count="181">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>f_model, z_df_conv <span class="op">=</span> analyze_mispredicted_fighting_words_by_conversation(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"false_pos_true_neg"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.head(<span class="dv">10</span>)) </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 232 valid corpus components. class2_func returned 117 valid corpus components.
Vocab size is 1999
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">yes</td>
<td>-6.535231</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">broken</td>
<td>-5.965318</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">much</td>
<td>-5.362650</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ok</td>
<td>-4.909162</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">okay</td>
<td>-4.537755</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the buyer</td>
<td>-4.356455</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bad review of</td>
<td>-4.352271</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">retract</td>
<td>-4.268908</td>
<td>True Success</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">so much</td>
<td>-4.220469</td>
<td>True Success</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">review of</td>
<td>-4.212235</td>
<td>True Success</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">that you</td>
<td>3.516404</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the website</td>
<td>3.684440</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant jersey</td>
<td>4.182163</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant jersey</td>
<td>4.554592</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">website</td>
<td>5.241377</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">player</td>
<td>5.401609</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kobe bryant</td>
<td>5.695863</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kobe</td>
<td>6.078845</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">the jersey</td>
<td>6.101230</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bryant</td>
<td>6.393911</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-analysis-example-false-derailment-vs-true-derailment-for-no-last-no-submit-agreement-downsampled-model-utterance-level">Fighting Words Analysis Example: False Derailment vs True Derailment for No Last No Submit Agreement Downsampled Model (Utterance Level)</h3>
<div id="076430c6" class="cell" data-execution_count="184">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>f_model, z_df_conv <span class="op">=</span> analyze_mispredicted_fighting_words_by_conversation(no_last_downsampled_fr, plot<span class="op">=</span><span class="va">True</span>, key<span class="op">=</span><span class="st">"true_pos_false_pos"</span>, custom_vec <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.head(<span class="dv">10</span>)) </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>display(z_df_conv.tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>class1_func returned 65 valid corpus components. class2_func returned 232 valid corpus components.
Vocab size is 2013
Comparing language...
ngram zscores computed.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">thank</td>
<td>-5.749773</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">thank you</td>
<td>-5.718247</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">apologize</td>
<td>-5.336655</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">thank you for</td>
<td>-3.687553</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">apologize for</td>
<td>-3.622634</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">for the</td>
<td>-3.569466</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">retract the</td>
<td>-3.504892</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">you for</td>
<td>-3.339534</td>
<td>False Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">us</td>
<td>-3.280998</td>
<td>False Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">the bad</td>
<td>-3.234680</td>
<td>False Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">z-score</th>
<th data-quarto-table-cell-role="th">class</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ngram</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">dishonest</td>
<td>4.315086</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sales are final</td>
<td>4.431480</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sales are</td>
<td>4.605759</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">lying</td>
<td>4.759982</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">all</td>
<td>5.001141</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">you are</td>
<td>5.133342</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sales</td>
<td>5.317728</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">walk</td>
<td>5.562037</td>
<td>True Derailmemt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">walk away</td>
<td>5.562037</td>
<td>True Derailmemt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">away</td>
<td>9.649999</td>
<td>True Derailmemt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="predicition-evolution-overtime" class="level1">
<h1>Predicition Evolution Overtime</h1>
<section id="ground-wiki-on-wiki-data-test-set" class="level3">
<h3 class="anchored" data-anchor-id="ground-wiki-on-wiki-data-test-set">Ground wiki on Wiki Data Test Set</h3>
<div id="a30f7ed9" class="cell" data-execution_count="245">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>avg_length_by_split_and_label(corpus_wiki)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="245">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">False</th>
<th data-quarto-table-cell-role="th">True</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">test</td>
<td>6.959524</td>
<td>7.257143</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">train</td>
<td>6.966507</td>
<td>7.421053</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">val</td>
<td>6.859524</td>
<td>7.445238</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="4bef7046" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(corpus_wiki, name <span class="op">=</span> <span class="st">"Wiki Corpus"</span>, label_key<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="average-length-for-all-kodis-test-set" class="level3">
<h3 class="anchored" data-anchor-id="average-length-for-all-kodis-test-set">Average length for all KODIS Test set</h3>
<div id="9bc9c5ae" class="cell" data-execution_count="246">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>avg_length_by_split_and_label(no_samp[<span class="st">"ground_corpus"</span>], label_key <span class="op">=</span><span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="246">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">0.0</th>
<th data-quarto-table-cell-role="th">1.0</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">test</td>
<td>12.968481</td>
<td>13.534247</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">train</td>
<td>12.937739</td>
<td>13.486364</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">val</td>
<td>13.032070</td>
<td>13.333333</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="9d3e92e2" class="cell" data-execution_count="203">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Default"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Downsampled"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Weighted"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-19-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-19-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-19-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="163604a2" class="cell" data-execution_count="149">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Default"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Downsampled"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Weighted"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-20-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-20-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="level3">
<h3 class="anchored" data-anchor-id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</h3>
<div id="a1b7d3c8" class="cell" data-execution_count="150">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Default"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Downsampled"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Weighted"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-21-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-21-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="frustration-correlation" class="level1">
<h1>Frustration Correlation</h1>
<section id="no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="no-last-downsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last Downsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="764e34f9" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.7579975724220276</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(no_last_downsampled_fr)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_downsampled_fr)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_downsampled_fr)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#display(no_last_downsampled_fr.get_conversations_dataframe())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e2e0eb51" class="cell" data-execution_count="171">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(no_last_downsampled_fr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 358</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="no-last-no-submitdownsampled-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">No Last No SubmitDownsampled: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="8b579aec" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>no_last_submit_downsampled <span class="op">=</span> Corpus(filename<span class="op">=</span><span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run/corpus_kodis_no_last_submit_downsampled'</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(no_last_submit_downsampled, threshold<span class="op">=</span><span class="fl">0.7579975724220276</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(no_last_submit_downsampled)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(no_last_submit_downsampled)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># display(no_last_submit_downsampled.get_conversations_dataframe())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="20b09d2b" class="cell" data-execution_count="176">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(no_last_submit_downsampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 358</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-25-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency" class="level3">
<h3 class="anchored" data-anchor-id="ground-wiki-correlation-with-highest-predicted-score-per-conversation-and-avg_frustration-frequency">Ground Wiki: Correlation with highest predicted score per conversation and avg_frustration frequency</h3>
<div id="8889af06" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>wiki_corp <span class="op">=</span> corpus_kodis_ground_orig</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>apply_best_threshold(wiki_corp, threshold<span class="op">=</span><span class="fl">0.7579975724220276</span>, selector<span class="op">=</span>convo_selector)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>add_avg_frustration_score(wiki_corp)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>add_max_pred_score_to_conversations(wiki_corp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="87a98666" class="cell" data-execution_count="179">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df, corr, r2 <span class="op">=</span> evaluate_prediction_vs_frustration(wiki_corp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The numbr of conversations to perform regression analysis on is 359</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-27-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="utility-functions" class="level1">
<h1>Utility Functions</h1>
<section id="convokit-transformers" class="level3">
<h3 class="anchored" data-anchor-id="convokit-transformers">ConvoKit Transformers</h3>
</section>
<section id="metric-and-plotting-functions" class="level3">
<h3 class="anchored" data-anchor-id="metric-and-plotting-functions">Metric and Plotting Functions</h3>
<div id="cell-52" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Callable</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    roc_curve, roc_auc_score,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve, average_precision_score,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_best_threshold(y_true, y_score):</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the threshold that maximizes Youden's J = TPR − FPR.</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresh <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    youden <span class="op">=</span> tpr <span class="op">-</span> fpr</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    idx    <span class="op">=</span> np.argmax(youden)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresh[idx], tpr[idx], fpr[idx], youden[idx]</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_best_threshold(corpus, threshold, prob_key<span class="op">=</span> <span class="st">"pred_score"</span>, best_pred_key<span class="op">=</span> <span class="st">"best_prediction"</span>,</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    best_label_key<span class="op">=</span> <span class="st">"best_forecast"</span>, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        any_pos <span class="op">=</span> <span class="va">False</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances():</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key, <span class="fl">0.0</span>)</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>            pred  <span class="op">=</span> <span class="bu">int</span>(score <span class="op">&gt;=</span> threshold)</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>            utt.meta[best_pred_key] <span class="op">=</span> pred</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pred:</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>                any_pos <span class="op">=</span> <span class="va">True</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        convo.meta[best_label_key] <span class="op">=</span> <span class="bu">int</span>(any_pos)</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> horizon(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>        comments_until_end <span class="op">=</span> {}</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> selector(convo) <span class="kw">and</span> convo.meta[<span class="st">"best_forecast"</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.get_chronological_utterance_list()):</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>                    prediction <span class="op">=</span> utt.meta[<span class="st">"best_prediction"</span>]</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> prediction <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>                        comments_until_end[convo.<span class="bu">id</span>] <span class="op">=</span> (</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">len</span>(convo.get_chronological_utterance_list()) <span class="op">-</span> i</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> comments_until_end</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="co">"""Taken + modified from forecaster class"""</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>, threshold <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> corpus.get_conversations_dataframe(selector<span class="op">=</span>selector)</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>         <span class="co"># counts</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>        tp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>        fp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>        tn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>        fn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># accuracy is always well‑defined</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>        acc <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precision, recall, fpr guard against zero‐denom</span></span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        recall    <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>        fpr       <span class="op">=</span> fp <span class="op">/</span> (fp <span class="op">+</span> tn) <span class="cf">if</span> (fp <span class="op">+</span> tn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># F1 = 2 * (precision * recall) / (precision + recall)</span></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>        f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall) <span class="cf">if</span> (precision <span class="op">+</span> recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Accuracy"</span>:  acc,</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Precision"</span>: precision,</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Recall"</span>:    recall,</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FPR"</span>:       fpr,</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"F1"</span>:        f1,</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Best Threshold"</span>: threshold,}</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_confusion_matrices(corpora_info):</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>    names, corpora, metrics_list, dfs, horizons <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>,<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merged.join(</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>            df[[<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>            ), how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) confusion matrices</span></span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>))</span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_craft_models(corpora_info, split_key<span class="op">=</span><span class="st">"split"</span>, train_tag<span class="op">=</span><span class="st">"train"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>, best<span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a><span class="co">    corpora_info: list of (name, Corpus, metrics_dict, conv_df, horizon_dict)</span></span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a>    names, corpora, metrics_list, dfs, horizons <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) avg lengths</span></span>
<span id="cb47-111"><a href="#cb47-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Avg. Conversation Length =="</span>)</span>
<span id="cb47-112"><a href="#cb47-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus <span class="kw">in</span> <span class="bu">zip</span>(names, corpora):</span>
<span id="cb47-113"><a href="#cb47-113" aria-hidden="true" tabindex="-1"></a>        train_lens <span class="op">=</span> [</span>
<span id="cb47-114"><a href="#cb47-114" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb47-115"><a href="#cb47-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb47-116"><a href="#cb47-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>train_tag</span>
<span id="cb47-117"><a href="#cb47-117" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb47-118"><a href="#cb47-118" aria-hidden="true" tabindex="-1"></a>        test_lens  <span class="op">=</span> [</span>
<span id="cb47-119"><a href="#cb47-119" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb47-120"><a href="#cb47-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb47-121"><a href="#cb47-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>test_tag</span>
<span id="cb47-122"><a href="#cb47-122" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb47-123"><a href="#cb47-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss">  train=</span><span class="sc">{</span>np<span class="sc">.</span>mean(train_lens)<span class="sc">:.1f}</span><span class="ss">  test=</span><span class="sc">{</span>np<span class="sc">.</span>mean(test_lens)<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb47-124"><a href="#cb47-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb47-125"><a href="#cb47-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-126"><a href="#cb47-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) metrics table</span></span>
<span id="cb47-127"><a href="#cb47-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Test Metrics =="</span>)</span>
<span id="cb47-128"><a href="#cb47-128" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics_list, index<span class="op">=</span>names)</span>
<span id="cb47-129"><a href="#cb47-129" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb47-130"><a href="#cb47-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-131"><a href="#cb47-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) horizon histograms</span></span>
<span id="cb47-132"><a href="#cb47-132" aria-hidden="true" tabindex="-1"></a>    all_vals   <span class="op">=</span> np.concatenate([<span class="bu">list</span>(h.values()) <span class="cf">for</span> h <span class="kw">in</span> horizons])</span>
<span id="cb47-133"><a href="#cb47-133" aria-hidden="true" tabindex="-1"></a>    global_max <span class="op">=</span> <span class="bu">int</span>(all_vals.<span class="bu">max</span>()) <span class="cf">if</span> all_vals.size <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb47-134"><a href="#cb47-134" aria-hidden="true" tabindex="-1"></a>    bins       <span class="op">=</span> np.arange(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb47-135"><a href="#cb47-135" aria-hidden="true" tabindex="-1"></a>    fig, axes  <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-136"><a href="#cb47-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-137"><a href="#cb47-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name, hor <span class="kw">in</span> <span class="bu">zip</span>(axes, names, horizons):</span>
<span id="cb47-138"><a href="#cb47-138" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(hor.values()))</span>
<span id="cb47-139"><a href="#cb47-139" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb47-140"><a href="#cb47-140" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb47-141"><a href="#cb47-141" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# comments after first+forecast"</span>)</span>
<span id="cb47-142"><a href="#cb47-142" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb47-143"><a href="#cb47-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb47-144"><a href="#cb47-144" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb47-145"><a href="#cb47-145" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>,<span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>vals<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>np<span class="sc">.</span>median(vals)<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb47-146"><a href="#cb47-146" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb47-147"><a href="#cb47-147" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-148"><a href="#cb47-148" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-149"><a href="#cb47-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-150"><a href="#cb47-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) merge conversation‑level dfs</span></span>
<span id="cb47-151"><a href="#cb47-151" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>,<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(  </span>
<span id="cb47-152"><a href="#cb47-152" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb47-153"><a href="#cb47-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb47-154"><a href="#cb47-154" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merged.join(</span>
<span id="cb47-155"><a href="#cb47-155" aria-hidden="true" tabindex="-1"></a>            df[[<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb47-156"><a href="#cb47-156" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb47-157"><a href="#cb47-157" aria-hidden="true" tabindex="-1"></a>            ), how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb47-158"><a href="#cb47-158" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-159"><a href="#cb47-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-160"><a href="#cb47-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5) calibration + probability histogram</span></span>
<span id="cb47-161"><a href="#cb47-161" aria-hidden="true" tabindex="-1"></a>    fig, (ax_cal, ax_hist) <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb47-162"><a href="#cb47-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-163"><a href="#cb47-163" aria-hidden="true" tabindex="-1"></a>        CalibrationDisplay.from_predictions(</span>
<span id="cb47-164"><a href="#cb47-164" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb47-165"><a href="#cb47-165" aria-hidden="true" tabindex="-1"></a>            y_prob<span class="op">=</span>merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb47-166"><a href="#cb47-166" aria-hidden="true" tabindex="-1"></a>            n_bins<span class="op">=</span><span class="dv">10</span>, name<span class="op">=</span>name, ax<span class="op">=</span>ax_cal</span>
<span id="cb47-167"><a href="#cb47-167" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-168"><a href="#cb47-168" aria-hidden="true" tabindex="-1"></a>    ax_cal.set_title(<span class="st">"Calibration Curves"</span>)<span class="op">;</span> ax_cal.grid(<span class="va">True</span>)</span>
<span id="cb47-169"><a href="#cb47-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-170"><a href="#cb47-170" aria-hidden="true" tabindex="-1"></a>    bins_prob <span class="op">=</span> np.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">11</span>)</span>
<span id="cb47-171"><a href="#cb47-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-172"><a href="#cb47-172" aria-hidden="true" tabindex="-1"></a>        ax_hist.hist(merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>], bins<span class="op">=</span>bins_prob,</span>
<span id="cb47-173"><a href="#cb47-173" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span>name, edgecolor<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb47-174"><a href="#cb47-174" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_title(<span class="st">"Probability Histogram"</span>)</span>
<span id="cb47-175"><a href="#cb47-175" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_xlabel(<span class="st">"Predicted probability"</span>)</span>
<span id="cb47-176"><a href="#cb47-176" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_ylabel(<span class="st">"Count of convos"</span>)</span>
<span id="cb47-177"><a href="#cb47-177" aria-hidden="true" tabindex="-1"></a>    ax_hist.legend()<span class="op">;</span> ax_hist.grid(<span class="va">True</span>)</span>
<span id="cb47-178"><a href="#cb47-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-179"><a href="#cb47-179" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb47-180"><a href="#cb47-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-181"><a href="#cb47-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) confusion matrices</span></span>
<span id="cb47-182"><a href="#cb47-182" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>))</span>
<span id="cb47-183"><a href="#cb47-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-184"><a href="#cb47-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb47-185"><a href="#cb47-185" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb47-186"><a href="#cb47-186" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb47-187"><a href="#cb47-187" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb47-188"><a href="#cb47-188" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb47-189"><a href="#cb47-189" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb47-190"><a href="#cb47-190" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-191"><a href="#cb47-191" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb47-192"><a href="#cb47-192" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb47-193"><a href="#cb47-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-194"><a href="#cb47-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7) ROC &amp; PR curves + find best thresholds</span></span>
<span id="cb47-195"><a href="#cb47-195" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> {}</span>
<span id="cb47-196"><a href="#cb47-196" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {}</span>
<span id="cb47-197"><a href="#cb47-197" aria-hidden="true" tabindex="-1"></a>    corpora <span class="op">=</span> {}</span>
<span id="cb47-198"><a href="#cb47-198" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb47-199"><a href="#cb47-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-200"><a href="#cb47-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ROC</span></span>
<span id="cb47-201"><a href="#cb47-201" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb47-202"><a href="#cb47-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-203"><a href="#cb47-203" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> merged[<span class="st">'label'</span>]</span>
<span id="cb47-204"><a href="#cb47-204" aria-hidden="true" tabindex="-1"></a>        y_score<span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb47-205"><a href="#cb47-205" aria-hidden="true" tabindex="-1"></a>        fpr, tpr, _ <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb47-206"><a href="#cb47-206" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> roc_auc_score(y_true, y_score)</span>
<span id="cb47-207"><a href="#cb47-207" aria-hidden="true" tabindex="-1"></a>        plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AUC=</span><span class="sc">{</span>auc<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb47-208"><a href="#cb47-208" aria-hidden="true" tabindex="-1"></a>        thr, t, f, j <span class="op">=</span> find_best_threshold(y_true, y_score)</span>
<span id="cb47-209"><a href="#cb47-209" aria-hidden="true" tabindex="-1"></a>        thresholds[name] <span class="op">=</span> thr</span>
<span id="cb47-210"><a href="#cb47-210" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss"> best thr=</span><span class="sc">{</span>thr<span class="sc">:.3f}</span><span class="ss">, TPR=</span><span class="sc">{</span>t<span class="sc">:.3f}</span><span class="ss">, FPR=</span><span class="sc">{</span>f<span class="sc">:.3f}</span><span class="ss">, J=</span><span class="sc">{</span>j<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb47-211"><a href="#cb47-211" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">'k--'</span>)</span>
<span id="cb47-212"><a href="#cb47-212" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"ROC Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"FPR"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"TPR"</span>)<span class="op">;</span> plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb47-213"><a href="#cb47-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-214"><a href="#cb47-214" aria-hidden="true" tabindex="-1"></a>    <span class="co">#annotate corpora with best prediction:</span></span>
<span id="cb47-215"><a href="#cb47-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus, <span class="op">*</span>_ <span class="kw">in</span> corpora_info:</span>
<span id="cb47-216"><a href="#cb47-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">not</span> <span class="kw">in</span> thresholds:</span>
<span id="cb47-217"><a href="#cb47-217" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"No threshold provided for model </span><span class="sc">{</span>name<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb47-218"><a href="#cb47-218" aria-hidden="true" tabindex="-1"></a>        apply_best_threshold(corpus, thresholds[name],  selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb47-219"><a href="#cb47-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create best metrics</span></span>
<span id="cb47-220"><a href="#cb47-220" aria-hidden="true" tabindex="-1"></a>        metrics[name] <span class="op">=</span> summarize(corpus, selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>, threshold<span class="op">=</span>thresholds[name])</span>
<span id="cb47-221"><a href="#cb47-221" aria-hidden="true" tabindex="-1"></a>        corpora[name] <span class="op">=</span> corpus</span>
<span id="cb47-222"><a href="#cb47-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-223"><a href="#cb47-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-224"><a href="#cb47-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PR</span></span>
<span id="cb47-225"><a href="#cb47-225" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb47-226"><a href="#cb47-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-227"><a href="#cb47-227" aria-hidden="true" tabindex="-1"></a>        prec, rec, _ <span class="op">=</span> precision_recall_curve(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb47-228"><a href="#cb47-228" aria-hidden="true" tabindex="-1"></a>        ap <span class="op">=</span> average_precision_score(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb47-229"><a href="#cb47-229" aria-hidden="true" tabindex="-1"></a>        plt.plot(rec, prec, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AP=</span><span class="sc">{</span>ap<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb47-230"><a href="#cb47-230" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Precision–Recall Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"Recall"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"Precision"</span>)</span>
<span id="cb47-231"><a href="#cb47-231" aria-hidden="true" tabindex="-1"></a>    plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb47-232"><a href="#cb47-232" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb47-233"><a href="#cb47-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-234"><a href="#cb47-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8) summary table</span></span>
<span id="cb47-235"><a href="#cb47-235" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> {</span>
<span id="cb47-236"><a href="#cb47-236" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_acc"</span>:      (merged[<span class="st">'label'</span>]<span class="op">==</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]).mean()</span>
<span id="cb47-237"><a href="#cb47-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb47-238"><a href="#cb47-238" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-239"><a href="#cb47-239" aria-hidden="true" tabindex="-1"></a>    summary.update({</span>
<span id="cb47-240"><a href="#cb47-240" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_avg_prob"</span>: merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>].mean()</span>
<span id="cb47-241"><a href="#cb47-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb47-242"><a href="#cb47-242" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb47-243"><a href="#cb47-243" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Summary of Convo Acc &amp; Avg Prob =="</span>)</span>
<span id="cb47-244"><a href="#cb47-244" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame(summary, index<span class="op">=</span>[<span class="st">"conversation_level"</span>]))</span>
<span id="cb47-245"><a href="#cb47-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-246"><a href="#cb47-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresholds, metrics, corpora</span>
<span id="cb47-247"><a href="#cb47-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-248"><a href="#cb47-248" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> best_thersholds(corpora_info, split_key<span class="op">=</span><span class="st">"split"</span>, train_tag<span class="op">=</span><span class="st">"train"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>):</span>
<span id="cb47-249"><a href="#cb47-249" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 7) ROC &amp; PR curves + find best thresholds</span></span>
<span id="cb47-250"><a href="#cb47-250" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> {}</span>
<span id="cb47-251"><a href="#cb47-251" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {}</span>
<span id="cb47-252"><a href="#cb47-252" aria-hidden="true" tabindex="-1"></a>    corpora <span class="op">=</span> {}</span>
<span id="cb47-253"><a href="#cb47-253" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb47-254"><a href="#cb47-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-255"><a href="#cb47-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-256"><a href="#cb47-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-257"><a href="#cb47-257" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> merged[<span class="st">'label'</span>]</span>
<span id="cb47-258"><a href="#cb47-258" aria-hidden="true" tabindex="-1"></a>        y_score<span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb47-259"><a href="#cb47-259" aria-hidden="true" tabindex="-1"></a>        thr, t, f, j <span class="op">=</span> find_best_threshold(y_true, y_score)</span>
<span id="cb47-260"><a href="#cb47-260" aria-hidden="true" tabindex="-1"></a>        thresholds[name] <span class="op">=</span> thr</span>
<span id="cb47-261"><a href="#cb47-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-262"><a href="#cb47-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-263"><a href="#cb47-263" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_models(thresholds, metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb47-264"><a href="#cb47-264" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb47-265"><a href="#cb47-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) metrics table</span></span>
<span id="cb47-266"><a href="#cb47-266" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Best Threshold Test Set Metrics =="</span>)</span>
<span id="cb47-267"><a href="#cb47-267" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics, index<span class="op">=</span><span class="bu">list</span>(metrics.values())[<span class="dv">0</span>].keys()).T</span>
<span id="cb47-268"><a href="#cb47-268" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb47-269"><a href="#cb47-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-270"><a href="#cb47-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) confusion matrices</span></span>
<span id="cb47-271"><a href="#cb47-271" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>))</span>
<span id="cb47-272"><a href="#cb47-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-273"><a href="#cb47-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-274"><a href="#cb47-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb47-275"><a href="#cb47-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-276"><a href="#cb47-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect true/test only</span></span>
<span id="cb47-277"><a href="#cb47-277" aria-hidden="true" tabindex="-1"></a>        conv_df <span class="op">=</span> corpora[name].get_conversations_dataframe().reset_index()</span>
<span id="cb47-278"><a href="#cb47-278" aria-hidden="true" tabindex="-1"></a>        test_df <span class="op">=</span> conv_df[conv_df[<span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>] <span class="op">==</span> test_tag]</span>
<span id="cb47-279"><a href="#cb47-279" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> test_df[<span class="st">"meta.label"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb47-280"><a href="#cb47-280" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> test_df[<span class="st">"meta.best_forecast"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb47-281"><a href="#cb47-281" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb47-282"><a href="#cb47-282" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>y_true,</span>
<span id="cb47-283"><a href="#cb47-283" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>y_pred,</span>
<span id="cb47-284"><a href="#cb47-284" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb47-285"><a href="#cb47-285" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb47-286"><a href="#cb47-286" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb47-287"><a href="#cb47-287" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-288"><a href="#cb47-288" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb47-289"><a href="#cb47-289" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-290"><a href="#cb47-290" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-291"><a href="#cb47-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-292"><a href="#cb47-292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) forecast‑horizon histograms</span></span>
<span id="cb47-293"><a href="#cb47-293" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-294"><a href="#cb47-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-295"><a href="#cb47-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-296"><a href="#cb47-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute global max horizon to align bins</span></span>
<span id="cb47-297"><a href="#cb47-297" aria-hidden="true" tabindex="-1"></a>    all_horizons <span class="op">=</span> []</span>
<span id="cb47-298"><a href="#cb47-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-299"><a href="#cb47-299" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb47-300"><a href="#cb47-300" aria-hidden="true" tabindex="-1"></a>        all_horizons.extend(h.values())</span>
<span id="cb47-301"><a href="#cb47-301" aria-hidden="true" tabindex="-1"></a>    max_h <span class="op">=</span> <span class="bu">int</span>(<span class="bu">max</span>(all_horizons)) <span class="cf">if</span> all_horizons <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb47-302"><a href="#cb47-302" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> np.arange(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb47-303"><a href="#cb47-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-304"><a href="#cb47-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb47-305"><a href="#cb47-305" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb47-306"><a href="#cb47-306" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(h.values()))</span>
<span id="cb47-307"><a href="#cb47-307" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb47-308"><a href="#cb47-308" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb47-309"><a href="#cb47-309" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# utts after first + forecast"</span>)</span>
<span id="cb47-310"><a href="#cb47-310" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb47-311"><a href="#cb47-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb47-312"><a href="#cb47-312" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb47-313"><a href="#cb47-313" aria-hidden="true" tabindex="-1"></a>        m, md <span class="op">=</span> vals.mean() <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span>, np.median(vals) <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb47-314"><a href="#cb47-314" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>, <span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>m<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>md<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb47-315"><a href="#cb47-315" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb47-316"><a href="#cb47-316" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-317"><a href="#cb47-317" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-318"><a href="#cb47-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-319"><a href="#cb47-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-320"><a href="#cb47-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-321"><a href="#cb47-321" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_confusion(thresholds, metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb47-322"><a href="#cb47-322" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb47-323"><a href="#cb47-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) confusion matrices</span></span>
<span id="cb47-324"><a href="#cb47-324" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>))</span>
<span id="cb47-325"><a href="#cb47-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb47-326"><a href="#cb47-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb47-327"><a href="#cb47-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect true/test only</span></span>
<span id="cb47-328"><a href="#cb47-328" aria-hidden="true" tabindex="-1"></a>        conv_df <span class="op">=</span> corpora[name].get_conversations_dataframe().reset_index()</span>
<span id="cb47-329"><a href="#cb47-329" aria-hidden="true" tabindex="-1"></a>        test_df <span class="op">=</span> conv_df[conv_df[<span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>] <span class="op">==</span> test_tag]</span>
<span id="cb47-330"><a href="#cb47-330" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> test_df[<span class="st">"meta.label"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb47-331"><a href="#cb47-331" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> test_df[<span class="st">"meta.best_forecast"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb47-332"><a href="#cb47-332" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb47-333"><a href="#cb47-333" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>y_true,</span>
<span id="cb47-334"><a href="#cb47-334" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>y_pred,</span>
<span id="cb47-335"><a href="#cb47-335" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb47-336"><a href="#cb47-336" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb47-337"><a href="#cb47-337" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb47-338"><a href="#cb47-338" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-339"><a href="#cb47-339" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb47-340"><a href="#cb47-340" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-341"><a href="#cb47-341" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-342"><a href="#cb47-342" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-343"><a href="#cb47-343" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-344"><a href="#cb47-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-345"><a href="#cb47-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-346"><a href="#cb47-346" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_metrics(metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb47-347"><a href="#cb47-347" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb47-348"><a href="#cb47-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) metrics table</span></span>
<span id="cb47-349"><a href="#cb47-349" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Best Threshold Test Set Metrics =="</span>)</span>
<span id="cb47-350"><a href="#cb47-350" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics, index<span class="op">=</span><span class="bu">list</span>(metrics.values())[<span class="dv">0</span>].keys()).T</span>
<span id="cb47-351"><a href="#cb47-351" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb47-352"><a href="#cb47-352" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-353"><a href="#cb47-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-354"><a href="#cb47-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-355"><a href="#cb47-355" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-356"><a href="#cb47-356" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb47-357"><a href="#cb47-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-358"><a href="#cb47-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-359"><a href="#cb47-359" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-360"><a href="#cb47-360" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb47-361"><a href="#cb47-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-362"><a href="#cb47-362" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_model_convo_histograms(</span>
<span id="cb47-363"><a href="#cb47-363" aria-hidden="true" tabindex="-1"></a>    groups_of_corpora_info,</span>
<span id="cb47-364"><a href="#cb47-364" aria-hidden="true" tabindex="-1"></a>    bins_prob<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb47-365"><a href="#cb47-365" aria-hidden="true" tabindex="-1"></a>    title_key: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-366"><a href="#cb47-366" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb47-367"><a href="#cb47-367" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-368"><a href="#cb47-368" aria-hidden="true" tabindex="-1"></a><span class="co">    groups_of_corpora_info: list of lists of corpora_info tuples</span></span>
<span id="cb47-369"><a href="#cb47-369" aria-hidden="true" tabindex="-1"></a><span class="co">    bins_prob: optional bin edges for the histograms</span></span>
<span id="cb47-370"><a href="#cb47-370" aria-hidden="true" tabindex="-1"></a><span class="co">    title_key: 0 or 1, picks one of two title‐sets</span></span>
<span id="cb47-371"><a href="#cb47-371" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-372"><a href="#cb47-372" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pick the right set of group names</span></span>
<span id="cb47-373"><a href="#cb47-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_key <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb47-374"><a href="#cb47-374" aria-hidden="true" tabindex="-1"></a>        titles <span class="op">=</span> [<span class="st">"Default"</span>, <span class="st">"Downsampled"</span>, <span class="st">"Weighted"</span>, <span class="st">"Wiki"</span>]</span>
<span id="cb47-375"><a href="#cb47-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb47-376"><a href="#cb47-376" aria-hidden="true" tabindex="-1"></a>        titles <span class="op">=</span> [<span class="st">"Ground"</span>, <span class="st">"No Last"</span>, <span class="st">"No Subm"</span>, <span class="st">"Wiki"</span>]</span>
<span id="cb47-377"><a href="#cb47-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-378"><a href="#cb47-378" aria-hidden="true" tabindex="-1"></a>    n_groups <span class="op">=</span> <span class="bu">len</span>(groups_of_corpora_info)</span>
<span id="cb47-379"><a href="#cb47-379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bins_prob <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb47-380"><a href="#cb47-380" aria-hidden="true" tabindex="-1"></a>        bins_prob <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">11</span>)</span>
<span id="cb47-381"><a href="#cb47-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-382"><a href="#cb47-382" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n_groups, figsize<span class="op">=</span>(<span class="dv">6</span> <span class="op">*</span> n_groups, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-383"><a href="#cb47-383" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_groups <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb47-384"><a href="#cb47-384" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb47-385"><a href="#cb47-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-386"><a href="#cb47-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, corpora_info, group_title <span class="kw">in</span> <span class="bu">zip</span>(axes, groups_of_corpora_info, titles):</span>
<span id="cb47-387"><a href="#cb47-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1) unpack &amp; merge</span></span>
<span id="cb47-388"><a href="#cb47-388" aria-hidden="true" tabindex="-1"></a>        names, _, _, dfs, _ <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb47-389"><a href="#cb47-389" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>, <span class="st">'score'</span>, <span class="st">'forecast'</span>]].rename(</span>
<span id="cb47-390"><a href="#cb47-390" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'score'</span>: <span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb47-391"><a href="#cb47-391" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'forecast'</span>: <span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb47-392"><a href="#cb47-392" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb47-393"><a href="#cb47-393" aria-hidden="true" tabindex="-1"></a>            merged <span class="op">=</span> merged.join(</span>
<span id="cb47-394"><a href="#cb47-394" aria-hidden="true" tabindex="-1"></a>                df[[<span class="st">'score'</span>, <span class="st">'forecast'</span>]].rename(</span>
<span id="cb47-395"><a href="#cb47-395" aria-hidden="true" tabindex="-1"></a>                    columns<span class="op">=</span>{<span class="st">'score'</span>: <span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb47-396"><a href="#cb47-396" aria-hidden="true" tabindex="-1"></a>                             <span class="st">'forecast'</span>: <span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}),</span>
<span id="cb47-397"><a href="#cb47-397" aria-hidden="true" tabindex="-1"></a>                how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb47-398"><a href="#cb47-398" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-399"><a href="#cb47-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-400"><a href="#cb47-400" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2) plot histograms</span></span>
<span id="cb47-401"><a href="#cb47-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-402"><a href="#cb47-402" aria-hidden="true" tabindex="-1"></a>            ax.hist(</span>
<span id="cb47-403"><a href="#cb47-403" aria-hidden="true" tabindex="-1"></a>                merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb47-404"><a href="#cb47-404" aria-hidden="true" tabindex="-1"></a>                bins<span class="op">=</span>bins_prob,</span>
<span id="cb47-405"><a href="#cb47-405" aria-hidden="true" tabindex="-1"></a>                density<span class="op">=</span><span class="va">False</span>,    <span class="co"># raw counts</span></span>
<span id="cb47-406"><a href="#cb47-406" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb47-407"><a href="#cb47-407" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span>name,</span>
<span id="cb47-408"><a href="#cb47-408" aria-hidden="true" tabindex="-1"></a>                edgecolor<span class="op">=</span><span class="st">'k'</span></span>
<span id="cb47-409"><a href="#cb47-409" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-410"><a href="#cb47-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-411"><a href="#cb47-411" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3) compute mean &amp; variance for each model</span></span>
<span id="cb47-412"><a href="#cb47-412" aria-hidden="true" tabindex="-1"></a>        stats_lines <span class="op">=</span> []</span>
<span id="cb47-413"><a href="#cb47-413" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb47-414"><a href="#cb47-414" aria-hidden="true" tabindex="-1"></a>            arr <span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>].to_numpy()</span>
<span id="cb47-415"><a href="#cb47-415" aria-hidden="true" tabindex="-1"></a>            mu  <span class="op">=</span> arr.mean()</span>
<span id="cb47-416"><a href="#cb47-416" aria-hidden="true" tabindex="-1"></a>            var <span class="op">=</span> arr.var()</span>
<span id="cb47-417"><a href="#cb47-417" aria-hidden="true" tabindex="-1"></a>            stats_lines.append(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: μ=</span><span class="sc">{</span>mu<span class="sc">:.2f}</span><span class="ss">, σ²=</span><span class="sc">{</span>var<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb47-418"><a href="#cb47-418" aria-hidden="true" tabindex="-1"></a>        subtitle <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(stats_lines)</span>
<span id="cb47-419"><a href="#cb47-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-420"><a href="#cb47-420" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4) format subplot</span></span>
<span id="cb47-421"><a href="#cb47-421" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>group_title<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>subtitle<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb47-422"><a href="#cb47-422" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Predicted probability"</span>)</span>
<span id="cb47-423"><a href="#cb47-423" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb47-424"><a href="#cb47-424" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Count of convos"</span>)</span>
<span id="cb47-425"><a href="#cb47-425" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>)</span>
<span id="cb47-426"><a href="#cb47-426" aria-hidden="true" tabindex="-1"></a>        ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb47-427"><a href="#cb47-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-428"><a href="#cb47-428" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb47-429"><a href="#cb47-429" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="conversation-utilities" class="level3">
<h3 class="anchored" data-anchor-id="conversation-utilities">Conversation Utilities</h3>
<div id="cell-54" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_conversation(corpus, convo_id):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Pretty–print the dialogue for a single conversation.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">        corpus:    a ConvoKit Corpus</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">        convo_id:  the ID of the conversation you want to print</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grab the utterance DataFrame for that convo</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> corpus.get_conversation(convo_id).get_utterances_dataframe()</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure it's sorted by timestamp (or by its original index order)</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"timestamp"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.sort_values(<span class="st">"timestamp"</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now print each turn</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        speaker <span class="op">=</span> row.get(<span class="st">"speaker"</span>, <span class="st">"Unknown"</span>)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        text    <span class="op">=</span> row.get(<span class="st">"text"</span>, <span class="st">""</span>)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>speaker<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_avg_frustration_score(corpus):</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    filepath <span class="op">=</span> <span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/preprocessed_dyads.csv"</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    final_data <span class="op">=</span> DataPreprocesser(filepath)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span> final_data.getDataframe()</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'avg_frustration_score'</span>] <span class="op">=</span> df[[<span class="st">'b_Tact_4'</span>, <span class="st">'b_Tact_9'</span>, <span class="st">'s_Tact_4'</span>, <span class="st">'s_Tact_9'</span>]].<span class="bu">apply</span>(</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: row.mean() <span class="cf">if</span> row.notnull().<span class="bu">all</span>() <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    non_missing <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'avg_frustration_score'</span>])</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build a mapping from conversation ID to score, only for non-missing scores</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    score_map <span class="op">=</span> {</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"utt0_con</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>: score</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, score <span class="kw">in</span> non_missing[<span class="st">'avg_frustration_score'</span>].dropna().items()</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign the score if present, else None</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>        convo.meta[<span class="st">'avg_frustration_score'</span>] <span class="op">=</span> score_map.get(convo.<span class="bu">id</span>, <span class="va">None</span>)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_max_pred_score_to_conversations(corpus, utt_score_key<span class="op">=</span><span class="st">'pred_score'</span>, conv_meta_key<span class="op">=</span><span class="st">'max_pred_score'</span>):</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect all non-null scores</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> [</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>            utt.meta.get(utt_score_key)</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances()</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> utt.meta.get(utt_score_key) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># set the max (or None if there were no scores)</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>        convo.meta[conv_meta_key] <span class="op">=</span> <span class="bu">max</span>(scores) <span class="cf">if</span> scores <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_length_by_split_and_label(corpus, split_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"split"</span>, label_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"label"</span>):</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a><span class="op">\</span></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>        sp <span class="op">=</span> convo.meta.get(split_key, <span class="va">None</span>)</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>        lbl <span class="op">=</span> convo.meta.get(label_key, <span class="va">None</span>)</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>        length <span class="op">=</span> <span class="bu">len</span>(convo.get_utterance_ids())</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>        records.append({<span class="st">"split"</span>: sp, <span class="st">"label"</span>: lbl, <span class="st">"length"</span>: length})</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if you prefer to treat missing split/label as a category, uncomment:</span></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># df["split"] = df["split"].fillna("unspecified")</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># df["label"] = df["label"].fillna("unspecified")</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pivot to get avg length by split × label</span></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> df.groupby([<span class="st">"split"</span>, <span class="st">"label"</span>])[<span class="st">"length"</span>].mean().unstack()</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fighting-words" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words">Fighting Words</h3>
<div id="cell-56" class="cell" data-execution_count="112">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.fighting_words.fightingWords <span class="im">import</span> FightingWords</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> TextCleaner</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cleantext <span class="im">import</span> clean</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_agreement(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    patterns <span class="op">=</span> [<span class="vs">r"Submitted agreement:"</span>, <span class="vs">r"\brefund, buyer\b"</span>, <span class="vs">r"\breview, seller\b"</span>]</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(re.search(pat, text, flags<span class="op">=</span>re.IGNORECASE) <span class="cf">for</span> pat <span class="kw">in</span> patterns):</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"Submitted agreement:.*?\.(\s|$)"</span>,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        text,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        flags<span class="op">=</span>re.IGNORECASE,</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Remove any leftover 'refund, buyer' or 'review, seller'</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\brefund, buyer\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\breview, seller\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Collapse multiple spaces down to one, then strip edges</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s{2,}"</span>, <span class="st">" "</span>, text).strip()</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_mispredicted_fighting_words(</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    corpus,</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    split_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    test_tag: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    best_pred_key: <span class="bu">str</span>  <span class="op">=</span> <span class="st">"best_forecast"</span>,</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    label_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"label"</span>,</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>    prob_key: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"pred_score"</span>,</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>    threshold: <span class="bu">float</span>    <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    custom_vec          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    plot: <span class="bu">bool</span>          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    ngram_range<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>    min_df<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>    max_df<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>    max_features<span class="op">=</span><span class="dv">15000</span>,</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>    prior<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span>            <span class="op">=</span> <span class="st">"false_pos_neg"</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Identify “fighting words” that distinguish mis‐predicted success vs mis‐predicted impasse</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co">    at the utterance level, optionally filtered by a probability threshold.</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define text preprocessor</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocess(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> strip_agreement(text)</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> FightingWords.clean_text(s)</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define misprediction types</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_pos(u):</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> u.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&gt;=</span> threshold</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_neg(u):</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> u.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&lt;</span> threshold</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_pos(utt):</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_pos(utt)</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_neg(utt):</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_neg(utt)</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_pos(utt):</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_pos(utt)</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_neg(utt):</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> utt.get_conversation().meta</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> c.get(best_pred_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> c.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_neg(utt)</span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map key to class functions and labels</span></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="op">==</span> <span class="st">"false_pos_false_neg"</span>:</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, false_neg</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"False Derailmemt"</span>, <span class="st">"False Success"</span></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_true_neg"</span>:</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, true_neg</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_false_pos"</span>:</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, false_pos</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"False Derailmemt"</span></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"false_pos_true_neg"</span>:</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, true_neg</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span><span class="st">"False Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown key </span><span class="sc">{</span>key<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> custom_vec:</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Build over entire corpus """</span></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>        cv_custom <span class="op">=</span> CountVectorizer(</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>        all_texts <span class="op">=</span> [u.text <span class="cf">for</span> u <span class="kw">in</span> corpus.iter_utterances()]</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>        cv_custom.fit(all_texts)</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>        prior_counts <span class="op">=</span> cv_custom.transform(all_texts).toarray().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>        cv_locked <span class="op">=</span> CountVectorizer(vocabulary<span class="op">=</span>cv_custom.vocabulary_, preprocessor<span class="op">=</span>preprocess)</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instantiate and fit FightingWords</span></span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> utt: preprocess(utt.text),</span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_locked,</span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior_counts</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Build over the utterances in the selected classes """</span></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>        cv<span class="op">=</span> CountVectorizer(</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span> <span class="st">'english'</span>,</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features,</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> utt: preprocess(utt.text),</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"utterance"</span>,</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span> cv,</span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span> prior</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>    fw.fit(corpus, class1_func<span class="op">=</span>class1_func, class2_func<span class="op">=</span>class2_func,</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>            selector<span class="op">=</span><span class="kw">lambda</span> utt: utt.get_conversation().meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract z‐scores with dynamic labels</span></span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>    zdf <span class="op">=</span> fw.get_ngram_zscores(class1_name<span class="op">=</span>class1_label, class2_name<span class="op">=</span>class2_label)</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot if needed</span></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot:</span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>        cfg <span class="op">=</span> {<span class="st">"annot_method"</span>:<span class="st">"top_k"</span>, <span class="st">"top_k"</span>:<span class="dv">10</span>}</span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>        fw.plot_fighting_words(</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a>            max_label_size<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>            class1_name<span class="op">=</span>class1_label,</span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>            class2_name<span class="op">=</span>class2_label,</span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>cfg</span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fw, zdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fighting-words-by-conversation" class="level3">
<h3 class="anchored" data-anchor-id="fighting-words-by-conversation">Fighting Words By conversation</h3>
<div id="db530e2f" class="cell" data-execution_count="116">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.fighting_words.fightingWords <span class="im">import</span> FightingWords</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable, Tuple</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> TextCleaner</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cleantext <span class="im">import</span> clean</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_agreement(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    patterns <span class="op">=</span> [<span class="vs">r"Submitted agreement:"</span>, <span class="vs">r"\brefund, buyer\b"</span>, <span class="vs">r"\breview, seller\b"</span>]</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(re.search(pat, text, flags<span class="op">=</span>re.IGNORECASE) <span class="cf">for</span> pat <span class="kw">in</span> patterns):</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"Submitted agreement:.*?\.(\s|$)"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\brefund, buyer\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"\breview, seller\b"</span>, <span class="st">""</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s{2,}"</span>, <span class="st">" "</span>, text).strip()</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_mispredicted_fighting_words_by_conversation(</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    corpus,</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    split_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    test_tag: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    best_pred_key: <span class="bu">str</span>  <span class="op">=</span> <span class="st">"best_forecast"</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    label_key: <span class="bu">str</span>      <span class="op">=</span> <span class="st">"label"</span>,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    prob_key: <span class="bu">str</span>       <span class="op">=</span> <span class="st">"pred_score"</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    threshold: <span class="bu">float</span>    <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    custom_vec: <span class="bu">bool</span>    <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    plot: <span class="bu">bool</span>          <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    ngram_range: Tuple[<span class="bu">int</span>,<span class="bu">int</span>] <span class="op">=</span> (<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    min_df: <span class="bu">int</span>         <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    max_df: <span class="bu">float</span>       <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    max_features: <span class="bu">int</span>   <span class="op">=</span> <span class="dv">15000</span>,</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    prior: <span class="bu">float</span>        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span>            <span class="op">=</span> <span class="st">"false_pos_neg"</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[FightingWords, pd.DataFrame]:</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Variation of FightingWords at the **conversation** level.</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Compares two classes of conversations (e.g. mispredictions) rather than utterances.</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessor for raw text</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocess(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> FightingWords.clean_text(strip_agreement(text))</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helpers for conversation-level threshold</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_pos_conv(conv):</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> conv.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&gt;=</span> threshold</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_neg_conv(conv):</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> threshold <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> conv.meta.get(prob_key, <span class="fl">0.0</span>) <span class="op">&lt;</span> threshold</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class definitions on conversation.meta</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_pos(convo):</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">1</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_pos_conv(convo))</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> false_neg(convo):</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">0</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_neg_conv(convo))</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_pos(convo):</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">1</span></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">1</span> <span class="kw">and</span> is_pos_conv(convo))</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> true_neg(convo):</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> convo.meta</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (m.get(split_key)<span class="op">==</span>test_tag <span class="kw">and</span> m.get(best_pred_key)<span class="op">==</span><span class="dv">0</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> m.get(label_key)<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> is_neg_conv(convo))</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map key to class functions and labels</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="op">==</span> <span class="st">"false_pos_false_neg"</span>:</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, false_neg</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"False Derailmemt"</span>, <span class="st">"False Success"</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_true_neg"</span>:</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, true_neg</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"true_pos_false_pos"</span>:</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> true_pos, false_pos</span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span> <span class="st">"True Derailmemt"</span>, <span class="st">"False Derailmemt"</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"false_pos_true_neg"</span>:</span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>        class1_func, class2_func <span class="op">=</span> false_pos, true_neg</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>        class1_label, class2_label <span class="op">=</span><span class="st">"False Derailmemt"</span>, <span class="st">"True Success"</span></span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown key </span><span class="sc">{</span>key<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build vectorizer over full set of conversation texts</span></span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> custom_vec:</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>        cv_full <span class="op">=</span> CountVectorizer(</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>            stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gather all conversation-level texts</span></span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>        all_texts <span class="op">=</span> [preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances()))</span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_objs(<span class="st">"conversation"</span>)]</span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a>        cv_full.fit(all_texts)</span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>        prior_counts <span class="op">=</span> cv_full.transform(all_texts).toarray().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>        cv_locked <span class="op">=</span> CountVectorizer(vocabulary<span class="op">=</span>cv_full.vocabulary_, preprocessor<span class="op">=</span>preprocess)</span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"conversation"</span>,</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> convo: preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances())),</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_locked,</span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior_counts</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Default uniform prior over subset vocabulary</span></span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a>        cv_sub <span class="op">=</span> CountVectorizer(</span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a>            preprocessor<span class="op">=</span>preprocess,</span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a>            min_df<span class="op">=</span>min_df,</span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a>            max_df<span class="op">=</span>max_df,</span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a>            ngram_range<span class="op">=</span>ngram_range,</span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>max_features</span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a>        fw <span class="op">=</span> FightingWords(</span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a>            obj_type<span class="op">=</span><span class="st">"conversation"</span>,</span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>            text_func<span class="op">=</span><span class="kw">lambda</span> convo: preprocess(<span class="st">" "</span>.join(utt.text <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances())),</span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>cv_sub,</span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a>            prior<span class="op">=</span>prior</span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit on selected conversations</span></span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a>    fw.fit(</span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a>        corpus,</span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a>        class1_func<span class="op">=</span>class1_func,</span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a>        class2_func<span class="op">=</span>class2_func,</span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a>        selector<span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(split_key)<span class="op">==</span>test_tag</span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract z-scores DataFrame</span></span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a>    zdf <span class="op">=</span> fw.get_ngram_zscores(class1_name<span class="op">=</span>class1_label, class2_name<span class="op">=</span>class2_label)</span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-136"><a href="#cb50-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally plot</span></span>
<span id="cb50-137"><a href="#cb50-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot:</span>
<span id="cb50-138"><a href="#cb50-138" aria-hidden="true" tabindex="-1"></a>        cfg <span class="op">=</span> {<span class="st">"annot_method"</span>: <span class="st">"top_k"</span>, <span class="st">"top_k"</span>: <span class="dv">10</span>}</span>
<span id="cb50-139"><a href="#cb50-139" aria-hidden="true" tabindex="-1"></a>        fw.plot_fighting_words(</span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a>            max_label_size<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a>            class1_name<span class="op">=</span>class1_label,</span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a>            class2_name<span class="op">=</span>class2_label,</span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>cfg</span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fw, zdf</span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="forecasting-trends" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-trends">Forecasting Trends</h3>
<div id="cell-60" class="cell" data-execution_count="202">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_position_score_evolution_by_outcome(</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    corpus, split_key<span class="op">=</span><span class="st">"split"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    prob_key<span class="op">=</span><span class="st">"pred_score"</span>, name<span class="op">=</span><span class="va">None</span>, label_key <span class="op">=</span><span class="st">'label'</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    pos_scores <span class="op">=</span> {<span class="dv">0</span>: defaultdict(<span class="bu">list</span>), <span class="dv">1</span>: defaultdict(<span class="bu">list</span>)}</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> test_tag:</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        lbl <span class="op">=</span> convo.meta.get(label_key)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.iter_utterances(), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>                pos_scores[lbl][p].append(score)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    overall_max_pos <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>(d.keys()) <span class="cf">for</span> d <span class="kw">in</span> pos_scores.values() <span class="cf">if</span> d</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> <span class="bu">any</span>(pos_scores.values()) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    fig.subplots_adjust(left<span class="op">=</span><span class="fl">0.05</span>, right<span class="op">=</span><span class="fl">0.80</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ix, lbl <span class="kw">in</span> <span class="bu">enumerate</span>((<span class="dv">0</span>, <span class="dv">1</span>), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">2</span>, ix, projection<span class="op">=</span><span class="st">'3d'</span>)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> np.arange(<span class="dv">1</span>, overall_max_pos <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> [</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>            np.mean(pos_scores[lbl].get(p, [])) <span class="cf">if</span> pos_scores[lbl].get(p)</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> X</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> X</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># force colormap and scatter scale to 0→1</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>        sc <span class="op">=</span> ax.scatter(</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>            X, Y, Z,</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span>Y, cmap<span class="op">=</span><span class="st">'viridis'</span>,</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, Z, color<span class="op">=</span><span class="st">'black'</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, zs<span class="op">=</span><span class="dv">0</span>, zdir<span class="op">=</span><span class="st">'z'</span>, color<span class="op">=</span><span class="st">'gray'</span>, ls<span class="op">=</span><span class="st">'--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> xi, yi, zi <span class="kw">in</span> <span class="bu">zip</span>(X, Y, Z):</span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>            ax.plot([xi, xi], [yi, yi], [<span class="dv">0</span>, zi],</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, lw<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Utterance Position"</span>)</span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Mean Predicted Probability"</span>)</span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>        ax.set_zlabel(<span class="st">"Conversation Length so far"</span>)</span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)                      <span class="co"># &lt;— lock the probability axis</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>        title_lbl <span class="op">=</span> <span class="st">"Successful"</span> <span class="cf">if</span> lbl <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"Impasse"</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title_lbl<span class="sc">}</span><span class="ss"> (label=</span><span class="sc">{</span>lbl<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add colorbar to its own axes on the far right</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>    cbar_ax <span class="op">=</span> fig.add_axes([<span class="fl">0.82</span>, <span class="fl">0.15</span>, <span class="fl">0.02</span>, <span class="fl">0.7</span>])</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>    cb <span class="op">=</span> fig.colorbar(sc, cax<span class="op">=</span>cbar_ax)</span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>    cb.set_label(<span class="st">"Avg. Probability"</span>)</span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name:</span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Evolution of Model Confidence by Turn for </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="fl">0.95</span>, fontsize<span class="op">=</span><span class="dv">14</span></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="kodis-wiki-ground-functions" class="level3">
<h3 class="anchored" data-anchor-id="kodis-wiki-ground-functions">KODIS Wiki Ground Functions</h3>
<div id="cell-62" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>filepath <span class="op">=</span> <span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/preprocessed_dyads.csv"</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>filepath_no_last <span class="op">=</span> <span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/convos_exclude_last_utt.csv'</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>filepath_no_submit_last <span class="op">=</span> <span class="st">'/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/convos_exclude_submit_and_last.csv'</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling/"</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp_weighted <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_weighted/"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>results_filepath_downsampled <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled/"</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_convo_labels(corpus, final_data):</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> final_data.getDataframe().iterrows():</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        convo_id <span class="op">=</span> <span class="ss">f"utt0_con</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>  <span class="co"># generate conversation_id format from index</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> row[<span class="st">"dispute_outcome"</span>]  <span class="co"># update if your label column is named differently</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo_id <span class="kw">in</span> corpus.conversations:</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>            corpus.get_conversation(convo_id).meta[<span class="st">"label"</span>] <span class="op">=</span> label</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corpus_train_test_split(corpus):</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    random.seed(<span class="dv">42</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get all conversation IDs</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    all_convo_ids <span class="op">=</span> <span class="bu">list</span>(corpus.get_conversation_ids())</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Shuffle the conversation IDs</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    random.shuffle(all_convo_ids)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Define proportions</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(all_convo_ids)</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> n_total)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.1</span> <span class="op">*</span> n_total)</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    n_test <span class="op">=</span> n_total <span class="op">-</span> n_train <span class="op">-</span> n_val  <span class="co"># ensures 100% total</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Split into train/val/test</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    train_convos <span class="op">=</span> all_convo_ids[:n_train]</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    val_convos <span class="op">=</span> all_convo_ids[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    test_convos <span class="op">=</span> all_convo_ids[n_train<span class="op">+</span>n_val:]</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Mark conversations with a split tag</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> train_convos:</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> val_convos:</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"val"</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> test_convos:</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"test"</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_selector(context_tuple, split):</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Select only contexts in the given split, at the end of the conversation,</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="co">    and skip any utterance that’s been tagged exclude=True.</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the desired split</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    matches_split <span class="op">=</span> (</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>        context_tuple.current_utterance</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>            .get_conversation()</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>            .meta[<span class="st">"split"</span>]</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> split</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the final context in each convo</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>    is_end <span class="op">=</span> (<span class="bu">len</span>(context_tuple.future_context) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # skip if the current utterance was marked exclude=True</span></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not_excluded = not context_tuple.current_utterance.meta.get("exclude", False)</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matches_split <span class="kw">and</span> is_end </span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_selector(context_tuple):</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a><span class="co">    For transform we only need to check that the conversation is in the test split</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (context_tuple.current_utterance.get_conversation().meta[<span class="st">"split"</span>] <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a><span class="co"># selector for summarize: takes a Conversation</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convo_selector(convo: Conversation):</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a><span class="co">""" CRAFT MODEL INSTANCES """</span></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>model_wiki <span class="op">=</span> CRAFTModel(</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span> <span class="st">"craft-wiki-finetuned"</span>,  <span class="co"># or "craft-wiki-finetuned"</span></span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span><span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a><span class="co">""" FORECASTER MODEL INSTANCE """</span></span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_wiki <span class="op">=</span> Forecaster(</span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_wiki,</span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading craft-wiki-finetuned to /Users/mishkin/.convokit/saved-models/craft-wiki-finetuned
Downloading craft-wiki-finetuned/craft_full.tar from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/craft_full.tar (548.6MB)... Done
Downloading craft-wiki-finetuned/index2word.json from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/index2word.json (998.5KB)... Done
Downloading craft-wiki-finetuned/word2index.json from https://zissou.infosci.cornell.edu/convokit/models/craft_wikiconv/word2index.json (898.4KB)... Done</code></pre>
</div>
</div>
</section>
<section id="wiki-test-set" class="level3">
<h3 class="anchored" data-anchor-id="wiki-test-set">Wiki Test Set</h3>
<div id="a5927e38" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>corpus_wiki <span class="op">=</span> Corpus(filename<span class="op">=</span>download(<span class="st">"conversations-gone-awry-corpus"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1990ffbd" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>forecaster_wiki <span class="op">=</span> Forecaster(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span>model_wiki,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"conversation_has_personal_attack"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>corpus_wiki <span class="op">=</span> forecaster_wiki.transform(corpus_wiki, transform_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="698be24c" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>wiki_test_df, wiki_test_metrics <span class="op">=</span> forecaster_wiki.summarize(corpus_wiki, convo_selector)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>wiki_test_horizon <span class="op">=</span> forecaster_wiki._draw_horizon_plot(corpus_wiki, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8e6c2c90" class="cell" data-execution_count="239">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>wiki_test <span class="op">=</span>{}</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>wiki_test[<span class="st">"wiki_copus"</span>] <span class="op">=</span> corpus_wiki</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>wiki_test[<span class="st">"wiki_test_metrics"</span>] <span class="op">=</span>  wiki_test_metrics</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>wiki_test[<span class="st">"wiki_test_df"</span>] <span class="op">=</span>  wiki_test_df</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>wiki_test[<span class="st">"wiki_test_horizon"</span>] <span class="op">=</span>  wiki_test_horizon</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>corpora_info_wiki <span class="op">=</span> [</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"WIKI_TEST_SET"</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        wiki_test[<span class="st">"wiki_copus"</span>],</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        wiki_test[<span class="st">"wiki_test_metrics"</span>],</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        wiki_test[<span class="st">"wiki_test_df"</span>],</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        wiki_test[<span class="st">"wiki_test_horizon"</span>]</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="63006819" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> convo <span class="kw">in</span> corpus_wiki.iter_conversations():</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only rename if the old field exists</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"conversation_has_personal_attack"</span> <span class="kw">in</span> convo.meta:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        convo.meta[<span class="st">"label"</span>] <span class="op">=</span> convo.meta.pop(<span class="st">"conversation_has_personal_attack"</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>corpus_wiki.get_conversations_dataframe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="frustration-correlation-1" class="level3">
<h3 class="anchored" data-anchor-id="frustration-correlation-1">Frustration Correlation</h3>
<div id="712ff852" class="cell" data-execution_count="158">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_prediction_vs_frustration(corpus,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                       split_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                                       test_tag: <span class="bu">str</span> <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                                       pred_meta_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"max_pred_score"</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                       frust_meta_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"avg_frustration_score"</span>):</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only test‑split</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> test_tag:</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>        pred_score <span class="op">=</span> convo.meta.get(pred_meta_key)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        frust     <span class="op">=</span> convo.meta.get(frust_meta_key)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pred_score <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> frust <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>        records.append({</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>            pred_meta_key: pred_score,</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>            frust_meta_key: frust</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"The numbr of conversations to perform regression analysis on is </span><span class="sc">{</span><span class="bu">len</span>(records)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df.empty:</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No test conversations with both scores present."</span>)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correlation</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> df[pred_meta_key].corr(df[frust_meta_key])</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># linear regression</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[[pred_meta_key]].values</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[frust_meta_key].values</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> lr.score(X, y)</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[pred_meta_key], df[frust_meta_key], alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>    plt.plot(df[pred_meta_key], lr.predict(X), color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(pred_meta_key)</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(frust_meta_key)</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"</span><span class="sc">{</span>pred_meta_key<span class="sc">}</span><span class="ss"> vs. </span><span class="sc">{</span>frust_meta_key<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"r = </span><span class="sc">{</span>corr<span class="sc">:.2f}</span><span class="ss">,  R² = </span><span class="sc">{</span>r2<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, corr, r2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-71" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>final_data <span class="op">=</span> DataPreprocesser(filepath)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>final_data_no_last <span class="op">=</span> DataPreprocesser(filepath_no_last)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>final_data_no_submit_last <span class="op">=</span> DataPreprocesser(filepath_no_submit_last)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>ground2<span class="op">=</span> corp.corpusBuilder(final_data_no_last)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>ground3<span class="op">=</span>corp.corpusBuilder(final_data_no_submit_last)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co">"""Testing"""</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_orig <span class="op">=</span> forecaster_kodis_wiki.transform(ground1, transform_selector)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>ground_wiki_df, ground_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>ground_wiki_horizon <span class="op">=</span>forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_wiki.transform(ground2, transform_selector)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>no_last_wiki_df, no_last_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nl , convo_selector)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>no_last_wiki_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nls <span class="op">=</span> forecaster_kodis_wiki.transform(ground3, transform_selector)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>no_last_submit_wiki_df, no_last_submit_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nls,convo_selector)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>no_last_submit_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Row Index not in columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/src/modules/DataPreprocesser.py:111: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '1702723625' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
  self.utterancesDF.loc[13988, 'timestamp']= '1702723625'
27498it [00:01, 22699.92it/s]
25391it [00:00, 70088.95it/s]
23117it [00:00, 28601.33it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 5524 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.1%
Iteration: 2; Percent complete: 2.3%
Iteration: 3; Percent complete: 3.4%
Iteration: 4; Percent complete: 4.6%
Iteration: 5; Percent complete: 5.7%
Iteration: 6; Percent complete: 6.9%
Iteration: 7; Percent complete: 8.0%
Iteration: 8; Percent complete: 9.2%
Iteration: 9; Percent complete: 10.3%
Iteration: 10; Percent complete: 11.5%
Iteration: 11; Percent complete: 12.6%
Iteration: 12; Percent complete: 13.8%
Iteration: 13; Percent complete: 14.9%
Iteration: 14; Percent complete: 16.1%
Iteration: 15; Percent complete: 17.2%
Iteration: 16; Percent complete: 18.4%
Iteration: 17; Percent complete: 19.5%
Iteration: 18; Percent complete: 20.7%
Iteration: 19; Percent complete: 21.8%
Iteration: 20; Percent complete: 23.0%
Iteration: 21; Percent complete: 24.1%
Iteration: 22; Percent complete: 25.3%
Iteration: 23; Percent complete: 26.4%
Iteration: 24; Percent complete: 27.6%
Iteration: 25; Percent complete: 28.7%
Iteration: 26; Percent complete: 29.9%
Iteration: 27; Percent complete: 31.0%
Iteration: 28; Percent complete: 32.2%
Iteration: 29; Percent complete: 33.3%
Iteration: 30; Percent complete: 34.5%
Iteration: 31; Percent complete: 35.6%
Iteration: 32; Percent complete: 36.8%
Iteration: 33; Percent complete: 37.9%
Iteration: 34; Percent complete: 39.1%
Iteration: 35; Percent complete: 40.2%
Iteration: 36; Percent complete: 41.4%
Iteration: 37; Percent complete: 42.5%
Iteration: 38; Percent complete: 43.7%
Iteration: 39; Percent complete: 44.8%
Iteration: 40; Percent complete: 46.0%
Iteration: 41; Percent complete: 47.1%
Iteration: 42; Percent complete: 48.3%
Iteration: 43; Percent complete: 49.4%
Iteration: 44; Percent complete: 50.6%
Iteration: 45; Percent complete: 51.7%
Iteration: 46; Percent complete: 52.9%
Iteration: 47; Percent complete: 54.0%
Iteration: 48; Percent complete: 55.2%
Iteration: 49; Percent complete: 56.3%
Iteration: 50; Percent complete: 57.5%
Iteration: 51; Percent complete: 58.6%
Iteration: 52; Percent complete: 59.8%
Iteration: 53; Percent complete: 60.9%
Iteration: 54; Percent complete: 62.1%
Iteration: 55; Percent complete: 63.2%
Iteration: 56; Percent complete: 64.4%
Iteration: 57; Percent complete: 65.5%
Iteration: 58; Percent complete: 66.7%
Iteration: 59; Percent complete: 67.8%
Iteration: 60; Percent complete: 69.0%
Iteration: 61; Percent complete: 70.1%
Iteration: 62; Percent complete: 71.3%
Iteration: 63; Percent complete: 72.4%
Iteration: 64; Percent complete: 73.6%
Iteration: 65; Percent complete: 74.7%
Iteration: 66; Percent complete: 75.9%
Iteration: 67; Percent complete: 77.0%
Iteration: 68; Percent complete: 78.2%
Iteration: 69; Percent complete: 79.3%
Iteration: 70; Percent complete: 80.5%
Iteration: 71; Percent complete: 81.6%
Iteration: 72; Percent complete: 82.8%
Iteration: 73; Percent complete: 83.9%
Iteration: 74; Percent complete: 85.1%
Iteration: 75; Percent complete: 86.2%
Iteration: 76; Percent complete: 87.4%
Iteration: 77; Percent complete: 88.5%
Iteration: 78; Percent complete: 89.7%
Iteration: 79; Percent complete: 90.8%
Iteration: 80; Percent complete: 92.0%
Iteration: 81; Percent complete: 93.1%
Iteration: 82; Percent complete: 94.3%
Iteration: 83; Percent complete: 95.4%
Iteration: 84; Percent complete: 96.6%
Iteration: 85; Percent complete: 97.7%
Iteration: 86; Percent complete: 98.9%
Iteration: 87; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 10.191176470588236, Median = 9.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 5101 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.2%
Iteration: 2; Percent complete: 2.5%
Iteration: 3; Percent complete: 3.8%
Iteration: 4; Percent complete: 5.0%
Iteration: 5; Percent complete: 6.2%
Iteration: 6; Percent complete: 7.5%
Iteration: 7; Percent complete: 8.8%
Iteration: 8; Percent complete: 10.0%
Iteration: 9; Percent complete: 11.2%
Iteration: 10; Percent complete: 12.5%
Iteration: 11; Percent complete: 13.8%
Iteration: 12; Percent complete: 15.0%
Iteration: 13; Percent complete: 16.2%
Iteration: 14; Percent complete: 17.5%
Iteration: 15; Percent complete: 18.8%
Iteration: 16; Percent complete: 20.0%
Iteration: 17; Percent complete: 21.2%
Iteration: 18; Percent complete: 22.5%
Iteration: 19; Percent complete: 23.8%
Iteration: 20; Percent complete: 25.0%
Iteration: 21; Percent complete: 26.2%
Iteration: 22; Percent complete: 27.5%
Iteration: 23; Percent complete: 28.7%
Iteration: 24; Percent complete: 30.0%
Iteration: 25; Percent complete: 31.2%
Iteration: 26; Percent complete: 32.5%
Iteration: 27; Percent complete: 33.8%
Iteration: 28; Percent complete: 35.0%
Iteration: 29; Percent complete: 36.2%
Iteration: 30; Percent complete: 37.5%
Iteration: 31; Percent complete: 38.8%
Iteration: 32; Percent complete: 40.0%
Iteration: 33; Percent complete: 41.2%
Iteration: 34; Percent complete: 42.5%
Iteration: 35; Percent complete: 43.8%
Iteration: 36; Percent complete: 45.0%
Iteration: 37; Percent complete: 46.2%
Iteration: 38; Percent complete: 47.5%
Iteration: 39; Percent complete: 48.8%
Iteration: 40; Percent complete: 50.0%
Iteration: 41; Percent complete: 51.2%
Iteration: 42; Percent complete: 52.5%
Iteration: 43; Percent complete: 53.8%
Iteration: 44; Percent complete: 55.0%
Iteration: 45; Percent complete: 56.2%
Iteration: 46; Percent complete: 57.5%
Iteration: 47; Percent complete: 58.8%
Iteration: 48; Percent complete: 60.0%
Iteration: 49; Percent complete: 61.3%
Iteration: 50; Percent complete: 62.5%
Iteration: 51; Percent complete: 63.7%
Iteration: 52; Percent complete: 65.0%
Iteration: 53; Percent complete: 66.2%
Iteration: 54; Percent complete: 67.5%
Iteration: 55; Percent complete: 68.8%
Iteration: 56; Percent complete: 70.0%
Iteration: 57; Percent complete: 71.2%
Iteration: 58; Percent complete: 72.5%
Iteration: 59; Percent complete: 73.8%
Iteration: 60; Percent complete: 75.0%
Iteration: 61; Percent complete: 76.2%
Iteration: 62; Percent complete: 77.5%
Iteration: 63; Percent complete: 78.8%
Iteration: 64; Percent complete: 80.0%
Iteration: 65; Percent complete: 81.2%
Iteration: 66; Percent complete: 82.5%
Iteration: 67; Percent complete: 83.8%
Iteration: 68; Percent complete: 85.0%
Iteration: 69; Percent complete: 86.2%
Iteration: 70; Percent complete: 87.5%
Iteration: 71; Percent complete: 88.8%
Iteration: 72; Percent complete: 90.0%
Iteration: 73; Percent complete: 91.2%
Iteration: 74; Percent complete: 92.5%
Iteration: 75; Percent complete: 93.8%
Iteration: 76; Percent complete: 95.0%
Iteration: 77; Percent complete: 96.2%
Iteration: 78; Percent complete: 97.5%
Iteration: 79; Percent complete: 98.8%
Iteration: 80; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 9.191176470588236, Median = 8.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 4656 context tuples for model evaluation
Loading saved parameters...
Building encoders, decoder, and classifier...
Models built and ready to go!
Iteration: 1; Percent complete: 1.4%
Iteration: 2; Percent complete: 2.7%
Iteration: 3; Percent complete: 4.1%
Iteration: 4; Percent complete: 5.5%
Iteration: 5; Percent complete: 6.8%
Iteration: 6; Percent complete: 8.2%
Iteration: 7; Percent complete: 9.6%
Iteration: 8; Percent complete: 11.0%
Iteration: 9; Percent complete: 12.3%
Iteration: 10; Percent complete: 13.7%
Iteration: 11; Percent complete: 15.1%
Iteration: 12; Percent complete: 16.4%
Iteration: 13; Percent complete: 17.8%
Iteration: 14; Percent complete: 19.2%
Iteration: 15; Percent complete: 20.5%
Iteration: 16; Percent complete: 21.9%
Iteration: 17; Percent complete: 23.3%
Iteration: 18; Percent complete: 24.7%
Iteration: 19; Percent complete: 26.0%
Iteration: 20; Percent complete: 27.4%
Iteration: 21; Percent complete: 28.8%
Iteration: 22; Percent complete: 30.1%
Iteration: 23; Percent complete: 31.5%
Iteration: 24; Percent complete: 32.9%
Iteration: 25; Percent complete: 34.2%
Iteration: 26; Percent complete: 35.6%
Iteration: 27; Percent complete: 37.0%
Iteration: 28; Percent complete: 38.4%
Iteration: 29; Percent complete: 39.7%
Iteration: 30; Percent complete: 41.1%
Iteration: 31; Percent complete: 42.5%
Iteration: 32; Percent complete: 43.8%
Iteration: 33; Percent complete: 45.2%
Iteration: 34; Percent complete: 46.6%
Iteration: 35; Percent complete: 47.9%
Iteration: 36; Percent complete: 49.3%
Iteration: 37; Percent complete: 50.7%
Iteration: 38; Percent complete: 52.1%
Iteration: 39; Percent complete: 53.4%
Iteration: 40; Percent complete: 54.8%
Iteration: 41; Percent complete: 56.2%
Iteration: 42; Percent complete: 57.5%
Iteration: 43; Percent complete: 58.9%
Iteration: 44; Percent complete: 60.3%
Iteration: 45; Percent complete: 61.6%
Iteration: 46; Percent complete: 63.0%
Iteration: 47; Percent complete: 64.4%
Iteration: 48; Percent complete: 65.8%
Iteration: 49; Percent complete: 67.1%
Iteration: 50; Percent complete: 68.5%
Iteration: 51; Percent complete: 69.9%
Iteration: 52; Percent complete: 71.2%
Iteration: 53; Percent complete: 72.6%
Iteration: 54; Percent complete: 74.0%
Iteration: 55; Percent complete: 75.3%
Iteration: 56; Percent complete: 76.7%
Iteration: 57; Percent complete: 78.1%
Iteration: 58; Percent complete: 79.5%
Iteration: 59; Percent complete: 80.8%
Iteration: 60; Percent complete: 82.2%
Iteration: 61; Percent complete: 83.6%
Iteration: 62; Percent complete: 84.9%
Iteration: 63; Percent complete: 86.3%
Iteration: 64; Percent complete: 87.7%
Iteration: 65; Percent complete: 89.0%
Iteration: 66; Percent complete: 90.4%
Iteration: 67; Percent complete: 91.8%
Iteration: 68; Percent complete: 93.2%
Iteration: 69; Percent complete: 94.5%
Iteration: 70; Percent complete: 95.9%
Iteration: 71; Percent complete: 97.3%
Iteration: 72; Percent complete: 98.6%
Iteration: 73; Percent complete: 100.0%
Accuracy     0.442080
Precision    0.227425
Recall       0.931507
FPR          0.660000
F1           0.365591
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Horizon statistics (# of comments between first positive forecast and conversation end):
Mean = 8.5, Median = 7.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_analysis_files/figure-html/cell-40-output-18.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="loading-artifacts-utilities" class="level3">
<h3 class="anchored" data-anchor-id="loading-artifacts-utilities">Loading Artifacts Utilities</h3>
<div id="cell-74" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>downpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/downsampled_run"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>defaultpath <span class="op">=</span>Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/nosampling_run"</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>weights_path <span class="op">=</span> Path(<span class="st">"/Users/mishkin/Desktop/Research/Convo_Kit/ConvoKit_Disputes/data/fine_tuning_results/weighted_run"</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">#/work/data/fine_tuning_results/nosampling/run_20250509_090059/corpus_kodis_ground_default</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_artifact(exp_dir: Path, name: <span class="bu">str</span>):</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> exp_dir <span class="op">/</span> name</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.json'</span>)).exists():</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.loads((p.with_suffix(<span class="st">'.json'</span>)).read_text())</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.csv'</span>)).exists():</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(p.with_suffix(<span class="st">'.csv'</span>))</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p.is_dir():</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Corpus(filename<span class="op">=</span> <span class="bu">str</span>(p))</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.pt'</span>)).exists():</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.load(p.with_suffix(<span class="st">'.pt'</span>))</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"No artifact </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_all_variants(exp_dir: Path):</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># detect which naming scheme this folder uses</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_downsampled"</span>).is_dir():</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"downsampled"</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_weighted_loss"</span>).is_dir():</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"weighted"</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"default"</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build name‐templates</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>    tpl <span class="op">=</span> {</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"downsampled"</span>: {</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_downsampled"</span>,</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_downsampled_conv_df"</span>,</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_downsampled_metrics"</span>,</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_horizon_utterances"</span>,</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_downsampled",</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_downsampled"</span>,</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_downsampled_conv_df"</span>,</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_downsampled_metrics"</span>,</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_horizon_utterances"</span>,</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_downsampled",</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_last_submit_downsampled"</span>,</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_downsampled_conv_df"</span>,</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_downsampled_metrics"</span>,</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_horizon_utterances"</span>,</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_downsampled",</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weighted"</span>: {</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_weighted_loss"</span>,</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_weight_conv_df"</span>,</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_weighted_metrics"</span>,</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_weight_horizon"</span>,</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_weighted",</span></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_weighted_loss"</span>,</span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_weight_conv_df"</span>,</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_weighted_metrics"</span>,</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_weight_horizon"</span>,</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_weighted",</span></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_weighted_loss"</span>,</span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_weight_conv_df"</span>,</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_weighted_metrics"</span>,</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_weight_horizon"</span>,</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_weighted",</span></span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"default"</span>: {</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_default"</span>,</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_conv_default_df"</span>,</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_default_metrics"</span>,</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_default_horizon"</span>,</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_default",</span></span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_default"</span>,</span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"no_last_conv_df_default"</span>,</span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_default_metrics"</span>,</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_default_horizon"</span>,</span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_default",</span></span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_last_default"</span>,</span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_last_submit_conv_default_df"</span>,</span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_default_metrics"</span>,</span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_default_horizon"</span>,</span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_last_submit_last_default",</span></span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a>    }[variant]</span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a>        key: load_artifact(exp_dir, fname)</span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, fname <span class="kw">in</span> tpl.items()</span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Now load each regime:</span></span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a>down <span class="op">=</span> load_all_variants(downpath)</span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>no_samp <span class="op">=</span> load_all_variants(defaultpath)</span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>wt <span class="op">=</span> load_all_variants(weights_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-artifacts" class="level3">
<h3 class="anchored" data-anchor-id="load-artifacts">Load Artifacts</h3>
<div id="cell-76" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>wiki <span class="op">=</span>{}</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_orig</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_metrics"</span>] <span class="op">=</span> ground_wiki_metrics</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_df"</span>] <span class="op">=</span>  ground_wiki_df</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_horizon"</span>] <span class="op">=</span> ground_wiki_horizon</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nl</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_metrics"</span>] <span class="op">=</span> no_last_wiki_metrics</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_df"</span>] <span class="op">=</span>  no_last_wiki_df</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_horizon"</span>] <span class="op">=</span> no_last_wiki_horizon</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nls</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_metrics"</span>] <span class="op">=</span> no_last_submit_wiki_metrics</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_df"</span>] <span class="op">=</span>  no_last_submit_wiki_df</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_horizon"</span>] <span class="op">=</span> no_last_submit_horizon</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_df"</span>] <span class="op">=</span> wiki[<span class="st">"ground_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_df"</span>] <span class="op">=</span> wiki[<span class="st">"no_last_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_df"</span>] <span class="op">=</span> wiki[<span class="st">"no_last_submit_df"</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>corpora_info_ground <span class="op">=</span> [</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DEFAULT"</span>,</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_df"</span>],</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WEIGHTED"</span>,</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_df"</span>],</span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DOWNSAMPLED"</span>,</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_df"</span>],</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>corpora_info_no_last <span class="op">=</span> [</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DEFAULT"</span>,</span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_df"</span>],</span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_WEIGHTED"</span>,</span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_df"</span>],</span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DOWNSAMPLED"</span>,</span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_df"</span>],</span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-77"><a href="#cb74-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb74-78"><a href="#cb74-78" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-83"><a href="#cb74-83" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb74-84"><a href="#cb74-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-85"><a href="#cb74-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-86"><a href="#cb74-86" aria-hidden="true" tabindex="-1"></a>corpora_info_no_subm <span class="op">=</span> [</span>
<span id="cb74-87"><a href="#cb74-87" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-88"><a href="#cb74-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DEFAULT"</span>,</span>
<span id="cb74-89"><a href="#cb74-89" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb74-90"><a href="#cb74-90" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb74-91"><a href="#cb74-91" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_df"</span>],</span>
<span id="cb74-92"><a href="#cb74-92" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb74-93"><a href="#cb74-93" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-94"><a href="#cb74-94" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-95"><a href="#cb74-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_WEIGHTED"</span>,</span>
<span id="cb74-96"><a href="#cb74-96" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb74-97"><a href="#cb74-97" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb74-98"><a href="#cb74-98" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_df"</span>],</span>
<span id="cb74-99"><a href="#cb74-99" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb74-100"><a href="#cb74-100" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb74-101"><a href="#cb74-101" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb74-102"><a href="#cb74-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DOWNSAMPLED"</span>,</span>
<span id="cb74-103"><a href="#cb74-103" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb74-104"><a href="#cb74-104" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb74-105"><a href="#cb74-105" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_df"</span>],</span>
<span id="cb74-106"><a href="#cb74-106" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb74-107"><a href="#cb74-107" aria-hidden="true" tabindex="-1"></a>    ), (</span>
<span id="cb74-108"><a href="#cb74-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb74-109"><a href="#cb74-109" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb74-110"><a href="#cb74-110" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb74-111"><a href="#cb74-111" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb74-112"><a href="#cb74-112" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb74-113"><a href="#cb74-113" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-114"><a href="#cb74-114" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="utterance-variants" class="level3">
<h3 class="anchored" data-anchor-id="utterance-variants">Utterance Variants</h3>
<div id="cell-78" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>corpora_info_downsampled <span class="op">=</span> [</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DOWNSAMPLED"</span>,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_df"</span>],</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DOWNSAMPLED"</span>,</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_df"</span>],</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DOWNSAMPLED"</span>,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_df"</span>],</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>corpora_info_weighted <span class="op">=</span> [</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WEIGHTED"</span>,</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_df"</span>],</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_WEIGHTED"</span>,</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_df"</span>],</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_WEIGHTED"</span>,</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_df"</span>],</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>corpora_info_no_sampling <span class="op">=</span> [</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEFAULT_NOSAMP"</span>,</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_df"</span>],</span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_NOSAMP"</span>,</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_df"</span>],</span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_NOSAMP"</span>,</span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_df"</span>],</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>