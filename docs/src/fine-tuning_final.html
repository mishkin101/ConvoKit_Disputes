<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michelle Gelman">
<meta name="dcterms.date" content="2025-04-30">

<title>Fine-Tuning Kodis – Weekly ConvoKit Updates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Weekly ConvoKit Updates</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Current</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../src/fine-tuning_final.html" aria-current="page"> 
<span class="menu-text">Fine-Tuning Kodis</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#initial-performance-impressions-in-progress" id="toc-initial-performance-impressions-in-progress" class="nav-link active" data-scroll-target="#initial-performance-impressions-in-progress">Initial Performance Impressions (In progress)</a></li>
  <li><a href="#experiment-set-ups" id="toc-experiment-set-ups" class="nav-link" data-scroll-target="#experiment-set-ups">Experiment set ups:</a></li>
  <li><a href="#development-notes" id="toc-development-notes" class="nav-link" data-scroll-target="#development-notes">Development Notes</a></li>
  <li><a href="#corpus-pre-processing" id="toc-corpus-pre-processing" class="nav-link" data-scroll-target="#corpus-pre-processing">Corpus Pre-processing</a>
  <ul class="collapse">
  <li><a href="#corpus-imports" id="toc-corpus-imports" class="nav-link" data-scroll-target="#corpus-imports">Corpus Imports</a></li>
  <li><a href="#adding-conversation-labels" id="toc-adding-conversation-labels" class="nav-link" data-scroll-target="#adding-conversation-labels">Adding Conversation Labels</a></li>
  <li><a href="#weighted-model-class" id="toc-weighted-model-class" class="nav-link" data-scroll-target="#weighted-model-class">Weighted Model Class</a></li>
  <li><a href="#download-pre-trained-models" id="toc-download-pre-trained-models" class="nav-link" data-scroll-target="#download-pre-trained-models">Download Pre-Trained Models</a></li>
  </ul></li>
  <li><a href="#splitting-kodis-trainingtest-set" id="toc-splitting-kodis-trainingtest-set" class="nav-link" data-scroll-target="#splitting-kodis-trainingtest-set">Splitting KODIS: Training/Test Set</a>
  <ul class="collapse">
  <li><a href="#context-tuple-selector" id="toc-context-tuple-selector" class="nav-link" data-scroll-target="#context-tuple-selector">Context Tuple Selector</a></li>
  </ul></li>
  <li><a href="#finetuning--no-imbalance-correction" id="toc-finetuning--no-imbalance-correction" class="nav-link" data-scroll-target="#finetuning--no-imbalance-correction">Finetuning- No Imbalance Correction</a>
  <ul class="collapse">
  <li><a href="#full-training-pipeline" id="toc-full-training-pipeline" class="nav-link" data-scroll-target="#full-training-pipeline">Full Training Pipeline</a></li>
  <li><a href="#plotting-results" id="toc-plotting-results" class="nav-link" data-scroll-target="#plotting-results">Plotting Results</a></li>
  <li><a href="#saving-experiment" id="toc-saving-experiment" class="nav-link" data-scroll-target="#saving-experiment">Saving Experiment</a></li>
  </ul></li>
  <li><a href="#fine-tuning-class-imbalance-handling-with-class-weighted-loss" id="toc-fine-tuning-class-imbalance-handling-with-class-weighted-loss" class="nav-link" data-scroll-target="#fine-tuning-class-imbalance-handling-with-class-weighted-loss">Fine-Tuning: Class Imbalance Handling with Class-Weighted Loss</a>
  <ul class="collapse">
  <li><a href="#modifying-runners.py-code-for-bce-with-weighted-loss" id="toc-modifying-runners.py-code-for-bce-with-weighted-loss" class="nav-link" data-scroll-target="#modifying-runners.py-code-for-bce-with-weighted-loss">Modifying runners.py code for BCE with weighted loss</a></li>
  <li><a href="#full-training-pipeline-weighted-loss" id="toc-full-training-pipeline-weighted-loss" class="nav-link" data-scroll-target="#full-training-pipeline-weighted-loss">Full Training Pipeline: Weighted Loss</a></li>
  <li><a href="#plotting-results-conversation-level-aggregation" id="toc-plotting-results-conversation-level-aggregation" class="nav-link" data-scroll-target="#plotting-results-conversation-level-aggregation">Plotting Results (Conversation Level Aggregation)</a></li>
  <li><a href="#saving-experiment-1" id="toc-saving-experiment-1" class="nav-link" data-scroll-target="#saving-experiment-1">Saving Experiment</a></li>
  </ul></li>
  <li><a href="#fine-tuning-downsampling-successful-disputes" id="toc-fine-tuning-downsampling-successful-disputes" class="nav-link" data-scroll-target="#fine-tuning-downsampling-successful-disputes">Fine-tuning: Downsampling Successful Disputes</a>
  <ul class="collapse">
  <li><a href="#downsampling-logic" id="toc-downsampling-logic" class="nav-link" data-scroll-target="#downsampling-logic">Downsampling Logic</a></li>
  <li><a href="#model-configuration" id="toc-model-configuration" class="nav-link" data-scroll-target="#model-configuration">Model Configuration</a></li>
  <li><a href="#reset-runner.py" id="toc-reset-runner.py" class="nav-link" data-scroll-target="#reset-runner.py">Reset runner.py</a></li>
  <li><a href="#average-length-of-convo-in-each-split" id="toc-average-length-of-convo-in-each-split" class="nav-link" data-scroll-target="#average-length-of-convo-in-each-split">Average Length of Convo in each split</a></li>
  <li><a href="#downsample-successful-disputes-train-split-only" id="toc-downsample-successful-disputes-train-split-only" class="nav-link" data-scroll-target="#downsample-successful-disputes-train-split-only">Downsample Successful Disputes (Train Split Only)</a></li>
  <li><a href="#full-training-pipeline-1" id="toc-full-training-pipeline-1" class="nav-link" data-scroll-target="#full-training-pipeline-1">Full Training Pipeline</a></li>
  <li><a href="#saving-results" id="toc-saving-results" class="nav-link" data-scroll-target="#saving-results">Saving Results</a></li>
  <li><a href="#plotting-results-conversation-level-aggregation-1" id="toc-plotting-results-conversation-level-aggregation-1" class="nav-link" data-scroll-target="#plotting-results-conversation-level-aggregation-1">Plotting Results (Conversation Level Aggregation)</a></li>
  </ul></li>
  <li><a href="#testing-on-fine-tuned-wiki-model" id="toc-testing-on-fine-tuned-wiki-model" class="nav-link" data-scroll-target="#testing-on-fine-tuned-wiki-model">Testing on Fine-Tuned Wiki Model</a>
  <ul class="collapse">
  <li><a href="#plotting-results-1" id="toc-plotting-results-1" class="nav-link" data-scroll-target="#plotting-results-1">Plotting Results</a></li>
  </ul></li>
  <li><a href="#analysis-across-all-experiments" id="toc-analysis-across-all-experiments" class="nav-link" data-scroll-target="#analysis-across-all-experiments">Analysis Across All Experiments</a>
  <ul class="collapse">
  <li><a href="#ground-model-performance-comparison-across-default-weighteddownsampled-variants" id="toc-ground-model-performance-comparison-across-default-weighteddownsampled-variants" class="nav-link" data-scroll-target="#ground-model-performance-comparison-across-default-weighteddownsampled-variants">Ground Model Performance Comparison Across Default, Weighted,Downsampled Variants</a>
  <ul class="collapse">
  <li><a href="#best-threshold-performance-comparison" id="toc-best-threshold-performance-comparison" class="nav-link" data-scroll-target="#best-threshold-performance-comparison">Best Threshold Performance Comparison</a></li>
  </ul></li>
  <li><a href="#no-last-utterance-model-performance-comparison-across-default-weighteddownsampled-variants" id="toc-no-last-utterance-model-performance-comparison-across-default-weighteddownsampled-variants" class="nav-link" data-scroll-target="#no-last-utterance-model-performance-comparison-across-default-weighteddownsampled-variants">No Last Utterance Model Performance Comparison Across Default, Weighted,Downsampled Variants</a>
  <ul class="collapse">
  <li><a href="#best-threshold-performance-comparison-1" id="toc-best-threshold-performance-comparison-1" class="nav-link" data-scroll-target="#best-threshold-performance-comparison-1">Best Threshold Performance Comparison</a></li>
  </ul></li>
  <li><a href="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</a>
  <ul class="collapse">
  <li><a href="#best-threshold-model-performance-comparison" id="toc-best-threshold-model-performance-comparison" class="nav-link" data-scroll-target="#best-threshold-model-performance-comparison">Best Threshold Model Performance Comparison</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conversation-forecasting-trends" id="toc-conversation-forecasting-trends" class="nav-link" data-scroll-target="#conversation-forecasting-trends">Conversation Forecasting Trends</a>
  <ul class="collapse">
  <li><a href="#ground-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" id="toc-no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="nav-link" data-scroll-target="#no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  <li><a href="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants-1" id="toc-no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants-1" class="nav-link" data-scroll-target="#no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants-1">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</a></li>
  </ul></li>
  <li><a href="#analysis-with-fine-tuned-craft" id="toc-analysis-with-fine-tuned-craft" class="nav-link" data-scroll-target="#analysis-with-fine-tuned-craft">Analysis with fine-tuned CRAFT</a></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions">Utility Functions</a>
  <ul class="collapse">
  <li><a href="#test-conversation-helpers" id="toc-test-conversation-helpers" class="nav-link" data-scroll-target="#test-conversation-helpers">Test Conversation Helpers</a></li>
  <li><a href="#save-helpers" id="toc-save-helpers" class="nav-link" data-scroll-target="#save-helpers">Save Helpers</a></li>
  <li><a href="#conversation-level-metrics-plotting-utility" id="toc-conversation-level-metrics-plotting-utility" class="nav-link" data-scroll-target="#conversation-level-metrics-plotting-utility">Conversation-Level Metrics Plotting Utility</a></li>
  <li><a href="#forecast-probability-trends" id="toc-forecast-probability-trends" class="nav-link" data-scroll-target="#forecast-probability-trends">Forecast Probability Trends</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load Data</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fine-Tuning Kodis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michelle Gelman </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="initial-performance-impressions-in-progress" class="level1">
<h1>Initial Performance Impressions (In progress)</h1>
<ul>
<li>I spent a lot of time looking at CRAFT under the hood this week to see possible modifications. This initial “exploratory” fine-tuning notebook ended up necessitating using cloud compute(used <a href="www.deepnote.com">deepnote</a>) for fine-tuning (GP4 -L4 $1.56/hr) to get some initial results, as each run for fine-tuning one model with training size (1264) was taking 40 min to train on my machine. To really improve results, I would look into setting up full end-to-end with python scripts to manage experiment runs better. I did a couple this week (1-3 for each model variant) in this notebook, and there is still randomness that is not reproducible across experiment runs. There is a lot fo room to modify the “model_config” for CRAFT and perhaps do dynamic adjustments to the learning rate for each batch, as I had issues with overfitting, but this notebook is not generalizble to test at this level.</li>
<li>What does “doing better” mean to know if we should continue? Pivot to analysis with self-report scores?
<ul>
<li><strong>It is pretty ineffecient to continue workin in jupyter notebook for fine-tuning as this is no way a robust training pipeline, but I wanted to touch base to see if the above would make sense to continue trying</strong></li>
</ul></li>
<li>The few downsampling training runs had high accuracy variablitiy (27% to 80%)</li>
<li>There are some clear upward patterns in the prediciton scores broken out by success/impasse’s emerging</li>
<li>downsampling does affect the accuracy quite a bit</li>
<li>AUC/PR curves look promising. I also chose the best threshold and plotted metric comparisons as well as the Confusion Matrix across each variant.</li>
</ul>
</section>
<section id="experiment-set-ups" class="level1">
<h1>Experiment set ups:</h1>
<ul>
<li>Use wiki-pretrained model params as base</li>
<li>model default forecast threshold is .54.</li>
<li>Use fine-tuned wiki model as base comparison for all fine-tuning results</li>
<li>fine-tune model varitions with:
<ul>
<li>conversations with all utterances (ground)</li>
<li>conversations with no last utterance (no_last)</li>
<li>conversations with no last no submit agreement box (no last no submit) (note that there are left over “chains of agree/disgree as response after agreement submission, which I did leave)</li>
</ul></li>
</ul>
<p>Model Improvement Considerations: - In craft, changed the Binary cross entropy loss to weighted Binary cross entropy loss in train.py based on class imbalance. Created Cost Sensitive CRAFT model - Downsampled from training set to get even impassee/success training split - default</p>
</section>
<section id="development-notes" class="level1">
<h1>Development Notes</h1>
<ul>
<li>According to craft paper, only context prior to derailment comment is used in training.
<ul>
<li><p>“Note that by construction, the last comment of each conversation is the one marked as derailment, and that our earlier code was therefore set up to not look at the last comment, meaning that all forecasts we obtained are forecasts made prior to derailment. This simplifies the computation of forecast accuracy as we now do not need to explicitly consider when a forecast was made.”</p></li>
<li><p><a href="https://colab.research.google.com/drive/1GvICZN0VwZQSWw3pJaEVY-EQGoO-L5lH#scrollTo=FYxW_AuWszqX">Reproducible code for CMV data</a></p></li>
<li><p><a href="https://github.com/jpwchang/CRAFT/blob/main/fine_tuning_demo.ipynb">Reproducible code for WIKI data (fine-tuning + inference)</a></p></li>
<li><p><a href="https://github.com/CornellNLP/ConvoKit/blob/master/examples/forecaster/CRAFT%20Forecaster%20demo.ipynb">New Forecaster Framework says to follow training on last_only context tuple (all commens up to final)</a></p></li>
<li><p>Claim all samples in train/val set for CMV/WIKI use “last only” context (entire convo up to last comment) for training– therefor assume that last comment has the derailed event in train set. <strong>However, my plot for utterances after derailment comment for wiki test set says otherwise? There are comments after the derailment comment in test set</strong></p></li>
<li><p>In Horizon paper, explicity stated ” if cₑ is the first toxic utterance at index e, we generate tuples for n=1…e–1 otherwise (a non-derailing convo), for n=1…N–1. Only WIKI was annotated at comment using “comment_has_personal_attack” meta data for each utterance.</p></li>
<li><p>Can we assume that an “impasse” is a derailed conversation? # Main Resources to Consider</p></li>
</ul></li>
<li><a href="https://www.cs.cornell.edu/~cristian/Thread_With_Caution.html">Paper on experiements in 2022 to de-escalate convo by intervention to inform users of tension (same authors as Horizon)</a></li>
<li><a href="https://www.cs.cornell.edu/~cristian/papers/chang_thesis.pdf">Jonathan Change PhD Thesis on Conversational Forecasting, “TOWARDS COMPUTATIONAL METHODS FOR PROACTIVELY SUPPORTING HEALTHIER ONLINE DISCUSSIONS”</a> # Todo:</li>
<li><label><input type="checkbox">A <a href="https://arxiv.org/pdf/1805.05345">paper</a> from paper from Jonathan P. Cheng (Horizon paper) that preceeeds the CRAFT model defines pragmatic devices—such as politeness strategies and rhetorical prompts—used to start a conversation, and analyze their relation to its future trajectory.</label>
<ul class="task-list">
<li><label><input type="checkbox">Convokit has a <a href="https://github.com/CornellNLP/ConvoKit/blob/master/examples/conversations-gone-awry/Conversations_Gone_Awry_Prediction.ipynb">notebook</a> (very recent-2025) that creates Prompt Types/politeness strategy labels for paired utterances to make derailement predicitons</label></li>
</ul></li>
<li><label><input type="checkbox" checked="">Plot utterances frequenices across context length dimension (averaged across all conversations)</label></li>
</ul>
</section>
<section id="corpus-pre-processing" class="level1">
<h1>Corpus Pre-processing</h1>
<div id="cell-3" class="cell" data-cell_id="0fbab2490b8e41fc9a06a23b518d50df" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="6123" data-execution_start="1746805774636" data-source_hash="6d00d07e">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install convokit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-4" class="cell" data-cell_id="ee8f15b2fe364f4897b883948d50ba4c" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="372" data-execution_start="1746805780826" data-source_hash="3c7a9d0">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint <span class="im">as</span> pp</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> entropy</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    roc_curve,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    roc_auc_score,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    average_precision_score,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> DataPreprocesser <span class="im">as</span> dp</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> CorpusUtils <span class="im">as</span> corp</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>importlib.<span class="bu">reload</span>(dp)  <span class="co"># Reload using the alias</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>importlib.<span class="bu">reload</span>(corp)  <span class="co"># Reload using the alias</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-5" class="cell" data-cell_id="a9484a8c43974faeaddd00e0329156f0" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1" data-execution_start="1746805716126" data-source_hash="5b47df14" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Convokit Imports</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.CRAFTModel <span class="im">import</span> CRAFTModel</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.forecaster.forecaster <span class="im">import</span> Forecaster</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> download, Corpus</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> Corpus, Speaker, Utterance, Conversation</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.convokitConfig <span class="im">import</span> ConvoKitConfig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="corpus-imports" class="level3">
<h3 class="anchored" data-anchor-id="corpus-imports">Corpus Imports</h3>
<div id="cell-7" class="cell" data-cell_id="40d4dbe93d514853a56e38b532f005b4" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="14852" data-execution_start="1746805716186" data-source_hash="c82c50a2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>corpus <span class="op">=</span> Corpus(filename<span class="op">=</span>download(<span class="st">"conversations-gone-awry-corpus"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell" data-cell_id="7ba3ec6aea0546e9b61dcbc035c1a10d" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="13555" data-execution_start="1746805785425" data-source_hash="b948a0b">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>filepath <span class="op">=</span> <span class="st">"/work/preprocessed_dyads.csv"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>filepath_no_last <span class="op">=</span> <span class="st">'/work/convos_exclude_last_utt.csv'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>filepath_no_submit_last <span class="op">=</span> <span class="st">'/work/convos_exclude_submit_and_last.csv'</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp <span class="op">=</span> Path(<span class="st">"/data/fine_tuning_results/nosampling/"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>results_filepath_no_samp_weighted <span class="op">=</span> Path(<span class="st">"/data/fine_tuning_results/nosampling_weighted/"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>results_filepath_downsampled <span class="op">=</span> Path(<span class="st">"/data/fine_tuning_results/downsampled/"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>final_data <span class="op">=</span> dp.DataPreprocesser(filepath)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>final_data_no_last <span class="op">=</span> dp.DataPreprocesser(filepath_no_last)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>final_data_no_submit_last <span class="op">=</span> dp.DataPreprocesser(filepath_no_submit_last)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> makeCleanCorpora():</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    final_data <span class="op">=</span> dp.DataPreprocesser(filepath)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    final_data_no_last <span class="op">=</span> dp.DataPreprocesser(filepath_no_last)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    final_data_no_submit_last <span class="op">=</span> dp.DataPreprocesser(filepath_no_submit_last)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground <span class="op">=</span> corp.corpusBuilder(final_data)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last <span class="op">=</span> corp.corpusBuilder(final_data_no_last)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last <span class="op">=</span> corp.corpusBuilder(final_data_no_submit_last)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus_kodis_ground, corpus_kodis_no_last, corpus_kodis_no_submit_last</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground, corpus_kodis_no_last, corpus_kodis_no_submit_last <span class="op">=</span> makeCleanCorpora()</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># display(corpus_kodis_ground.get_utterances_dataframe())</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># display(corpus_kodis_no_last.get_utterances_dataframe())</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># display(corpus_kodis_no_submit_last.get_utterances_dataframe())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="adding-conversation-labels" class="level3">
<h3 class="anchored" data-anchor-id="adding-conversation-labels">Adding Conversation Labels</h3>
<div id="cell-10" class="cell" data-cell_id="4fff0d93d9874db8be31fcf90259e1bb" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="262" data-execution_start="1746805805637" data-source_hash="37018e49" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_convo_labels(corpus, final_data):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> final_data.getDataframe().iterrows():</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        convo_id <span class="op">=</span> <span class="ss">f"utt0_con</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>  <span class="co"># generate conversation_id format from index</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> row[<span class="st">"dispute_outcome"</span>]  <span class="co"># update if your label column is named differently</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo_id <span class="kw">in</span> corpus.conversations:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            corpus.get_conversation(convo_id).meta[<span class="st">"label"</span>] <span class="op">=</span> label</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>add_convo_labels(corpus_kodis_ground, final_data)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>add_convo_labels(corpus_kodis_no_last, final_data_no_last)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>add_convo_labels(corpus_kodis_no_submit_last, final_data_no_submit_last)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-11" class="cell" data-cell_id="71e9e33f19da4852b76d77dff6bdf025" data-deepnote_cell_type="code" data-deepnote_table_loading="false" data-deepnote_table_state="{&quot;cellFormattingRules&quot;:[],&quot;columnDisplayNames&quot;:[],&quot;columnOrder&quot;:[&quot;vectors&quot;,&quot;meta.label&quot;],&quot;conditionalFilters&quot;:[],&quot;filters&quot;:[],&quot;hiddenColumnIds&quot;:[],&quot;pageIndex&quot;:8,&quot;pageSize&quot;:10,&quot;sortBy&quot;:[],&quot;wrappedTextColumnIds&quot;:[]}" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="52" data-execution_start="1746805807625" data-source_hash="6ed1630f">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground.get_conversations_dataframe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="weighted-model-class" class="level3">
<h3 class="anchored" data-anchor-id="weighted-model-class">Weighted Model Class</h3>
<div id="cell-13" class="cell" data-cell_id="1c000bf58c754e9d85904d39c43fad30" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="1" data-execution_start="1746794621893" data-source_hash="818db1a8" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CostSensitiveCRAFTModel(CRAFTModel):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, contexts, val_contexts<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        contexts <span class="op">=</span> <span class="bu">list</span>(contexts)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> val_contexts <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            val_contexts <span class="op">=</span> <span class="bu">list</span>(val_contexts)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># count labels</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        train_pairs <span class="op">=</span> <span class="va">self</span>._context_to_craft_data(<span class="bu">iter</span>(contexts))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [label <span class="cf">for</span> (_ctx, _utt, label, _id) <span class="kw">in</span> train_pairs]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        num_pos <span class="op">=</span> <span class="bu">sum</span>(labels)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        num_neg <span class="op">=</span> <span class="bu">len</span>(labels) <span class="op">-</span> num_pos</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pos_weight <span class="op">=</span> torch.tensor(num_neg <span class="op">/</span> num_pos, device<span class="op">=</span><span class="va">self</span>._device)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#original CRAFTModel.fit with the ORIGINAL ContextTuple streams</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().fit(<span class="bu">iter</span>(contexts), <span class="va">None</span> <span class="cf">if</span> val_contexts <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> <span class="bu">iter</span>(val_contexts))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_craft(<span class="va">self</span>):</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        emb, enc, ctx_enc, clf <span class="op">=</span> <span class="bu">super</span>()._init_craft()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># inject your pos_weight into the classifier</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        clf.pos_weight <span class="op">=</span> <span class="va">self</span>._pos_weight</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> emb, enc, ctx_enc, clf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-pre-trained-models" class="level3">
<h3 class="anchored" data-anchor-id="download-pre-trained-models">Download Pre-Trained Models</h3>
<div id="cell-15" class="cell" data-cell_id="7fd1635416594d1e98141f277c4f9f63" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="15221" data-execution_start="1746803704536" data-source_hash="225dd3bb">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>DEVICE <span class="op">=</span> <span class="st">"cuda"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>cfg <span class="op">=</span> ConvoKitConfig()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>download_dir <span class="op">=</span> cfg.model_directory</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>base_path <span class="op">=</span> download(<span class="st">"craft-wiki-pretrained"</span>, data_dir<span class="op">=</span>download_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-16" class="cell" data-cell_id="804042cb299148edbc9ec6c62796bf90" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="0" data-execution_start="1746794636223" data-source_hash="2ecd7ab1" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>model       <span class="op">=</span> os.path.join(base_path, <span class="st">"craft_pretrained.tar"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>vocab_i2w        <span class="op">=</span> os.path.join(base_path, <span class="st">"index2word.json"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>vocab_w2i        <span class="op">=</span> os.path.join(base_path, <span class="st">"word2index.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="splitting-kodis-trainingtest-set" class="level1">
<h1>Splitting KODIS: Training/Test Set</h1>
<div id="cell-18" class="cell" data-cell_id="11af6af8bcce4a078c291cdb49b64c1f" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1" data-execution_start="1746805801366" data-source_hash="f0521b15" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corpus_train_test_split(corpus, seed <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    random.seed(<span class="dv">42</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get all conversation IDs</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    all_convo_ids <span class="op">=</span> <span class="bu">list</span>(corpus.get_conversation_ids())</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Shuffle the conversation IDs</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    random.shuffle(all_convo_ids)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Define proportions</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(all_convo_ids)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.6</span> <span class="op">*</span> n_total)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.2</span> <span class="op">*</span> n_total)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    n_test <span class="op">=</span> n_total <span class="op">-</span> n_train <span class="op">-</span> n_val </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Split into train/val/test</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    train_convos <span class="op">=</span> all_convo_ids[:n_train]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    val_convos <span class="op">=</span> all_convo_ids[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    test_convos <span class="op">=</span> all_convo_ids[n_train<span class="op">+</span>n_val:]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Mark conversations with a split tag</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> train_convos:</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> val_convos:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"val"</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo_id <span class="kw">in</span> test_convos:</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        corpus.get_conversation(convo_id).meta[<span class="st">"split"</span>] <span class="op">=</span> <span class="st">"test"</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(corpus_kodis_ground)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(corpus_kodis_no_last)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(corpus_kodis_no_submit_last)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="context-tuple-selector" class="level3">
<h3 class="anchored" data-anchor-id="context-tuple-selector">Context Tuple Selector</h3>
<div id="cell-20" class="cell" data-cell_id="009ebff5e79a4885a21ce7a9d3698ede" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="0" data-execution_start="1746805960696" data-source_hash="664ead3e" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_selector(context_tuple, split):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Select only contexts in the given split, at the end of the conversation,</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and skip any utterance that’s been tagged exclude=True.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the desired split</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    matches_split <span class="op">=</span> (</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        context_tuple.current_utterance</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            .get_conversation()</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            .meta[<span class="st">"split"</span>]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> split</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only keep the final context in each convo</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    is_end <span class="op">=</span> (<span class="bu">len</span>(context_tuple.future_context) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # skip if the current utterance was marked exclude=True</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not_excluded = not context_tuple.current_utterance.meta.get("exclude", False)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matches_split <span class="kw">and</span> is_end </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_selector(context_tuple):</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co">    For transform we only need to check that the conversation is in the test split</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (context_tuple.current_utterance.get_conversation().meta[<span class="st">"split"</span>] <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co"># selector for summarize: takes a Conversation</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convo_selector(convo: Conversation):</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="finetuning--no-imbalance-correction" class="level1">
<h1>Finetuning- No Imbalance Correction</h1>
<section id="full-training-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="full-training-pipeline">Full Training Pipeline</h3>
<div id="cell-23" class="cell" data-cell_id="a7f3ef58946e4c28808bafa74c21f679" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="125394" data-execution_start="1746794636393" data-source_hash="68cc3e4a">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ground2<span class="op">=</span> corp.corpusBuilder(final_data)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ground3<span class="op">=</span>corp.corpusBuilder(final_data)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># runners.train = _original_train</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># assert runners.train is _original_train</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">""" CRAFT MODEL INSTANCES """</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>model_ground_default <span class="op">=</span> CRAFTModel(</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>model_no_last_default <span class="op">=</span> CRAFTModel(</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>model_no_submit_last_default <span class="op">=</span> CRAFTModel(</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">""" FORECASTER MODEL INSTANCES """</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground <span class="op">=</span> Forecaster(</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span>model_ground_default,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit <span class="op">=</span> Forecaster(</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span>model_no_last_default,</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last <span class="op">=</span> Forecaster(</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span>model_no_submit_last_default,</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co">""" Fine-Tuning Models"""</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground.fit(</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground, </span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last.fit(</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last, </span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit.fit(</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last, </span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="co">""" Testing (Original Corpus)"""</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_orig <span class="op">=</span> forecaster_kodis_ground.transform(ground1, transform_selector)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>ground_default_df, ground_default_metrics <span class="op">=</span> forecaster_kodis_ground.summarize(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>ground_default_horizon <span class="op">=</span> forecaster_kodis_ground._draw_horizon_plot(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_no_last.transform(ground2, transform_selector)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>no_last_default_df, no_last_default_metrics <span class="op">=</span> forecaster_kodis_no_last.summarize(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>no_last_default_horizon <span class="op">=</span> forecaster_kodis_no_last._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>corpus_kodis_no_ground_nls <span class="op">=</span> forecaster_kodis_no_last_submit.transform(ground3, transform_selector)</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>no_last_submit_default_df, no_last_submit_default_metrics <span class="op">=</span> forecaster_kodis_no_last_submit.summarize(corpus_kodis_no_ground_nls, convo_selector)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>no_last_submit_default_horizon <span class="op">=</span> forecaster_kodis_no_last_submit._draw_horizon_plot(corpus_kodis_no_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="plotting-results" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results">Plotting Results</h3>
<div id="cell-25" class="cell" data-cell_id="04b02f5e85414a4f995b78424208acb6" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="a63e91cf-e840-4b19-98a0-e3776d9efaa9" data-execution_millis="1165" data-execution_start="1746781042151" data-source_hash="7bb3a359">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace these with your actual variables</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>corpora_info <span class="op">=</span> [</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST_SUBMIT"</span>, corpus_kodis_ground, no_last_submit_default_metrics, no_last_submit_default_df, no_last_submit_default_horizon),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST"</span>,         corpus_kodis_ground, no_last_default_metrics,  no_last_default_df, no_last_default_horizon),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_GROUND"</span>,          corpus_kodis_ground, ground_default_metrics, ground_default_df, ground_default_horizon),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>compare_craft_models(corpora_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="saving-experiment" class="level3">
<h3 class="anchored" data-anchor-id="saving-experiment">Saving Experiment</h3>
<div id="cell-27" class="cell" data-cell_id="4e131a7d307e4f2da39aa224f4450e3c" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="a63e91cf-e840-4b19-98a0-e3776d9efaa9" data-execution_millis="25680" data-execution_start="1746781259591" data-source_hash="2055b6d5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>save_default()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="fine-tuning-class-imbalance-handling-with-class-weighted-loss" class="level1">
<h1>Fine-Tuning: Class Imbalance Handling with Class-Weighted Loss</h1>
<section id="modifying-runners.py-code-for-bce-with-weighted-loss" class="level3">
<h3 class="anchored" data-anchor-id="modifying-runners.py-code-for-bce-with-weighted-loss">Modifying runners.py code for BCE with weighted loss</h3>
<div id="cell-30" class="cell" data-cell_id="24d39691e2384c1483c09fdfea48e2c4" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="0" data-execution_start="1746754627064" data-source_hash="feb091d1" data-execution_count="244">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span>  convokit.forecaster.CRAFT <span class="im">import</span> runners</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>_original_train <span class="op">=</span> runners.train</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">"Copied from runner.py"</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _cost_sensitive_train(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    input_variable, dialog_lengths, dialog_lengths_list, utt_lengths,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    batch_indices, dialog_indices, labels,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    encoder, context_encoder, attack_clf,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    encoder_optimizer, context_encoder_optimizer, attack_clf_optimizer,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    batch_size, clip, device</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Zero gradients</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    encoder_optimizer.zero_grad()</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    context_encoder_optimizer.zero_grad()</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    attack_clf_optimizer.zero_grad()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set device options</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    input_variable <span class="op">=</span> input_variable.to(device)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    dialog_lengths <span class="op">=</span> dialog_lengths.to(device)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    utt_lengths <span class="op">=</span> utt_lengths.to(device)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> labels.to(device)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward pass through utterance encoder</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    _, utt_encoder_hidden <span class="op">=</span> encoder(input_variable, utt_lengths)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert utterance encoder final states to batched dialogs for use by context encoder</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    context_encoder_input <span class="op">=</span> runners.makeContextEncoderInput(</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    utt_encoder_hidden, dialog_lengths_list, batch_size, batch_indices, dialog_indices</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward pass through context encoder</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    context_encoder_outputs, _ <span class="op">=</span> context_encoder(context_encoder_input, dialog_lengths)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward pass through classifier to get prediction logits</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> attack_clf(context_encoder_outputs, dialog_lengths)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate loss</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#loss = F.binary_cross_entropy_with_logits(logits, labels)</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Modified to use BCEWithLogitsLoss"</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    loss_fn <span class="op">=</span> nn.BCEWithLogitsLoss(pos_weight<span class="op">=</span>attack_clf.pos_weight)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    loss    <span class="op">=</span> loss_fn(logits, labels)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform backpropatation</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip gradients: gradients are modified in place</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> torch.nn.utils.clip_grad_norm_(encoder.parameters(), clip)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> torch.nn.utils.clip_grad_norm_(context_encoder.parameters(), clip)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> torch.nn.utils.clip_grad_norm_(attack_clf.parameters(), clip)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust model weights</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    encoder_optimizer.step()</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    context_encoder_optimizer.step()</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    attack_clf_optimizer.step()</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Using cost sensitive train"</span>)</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss.item()</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>runners.train <span class="op">=</span> _cost_sensitive_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-31" class="cell" data-cell_id="89cab9ea93ab4886826cb7095f343c5f" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="1" data-execution_start="1746754630851" data-source_hash="3eecc245" data-execution_count="247">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> runners.train <span class="kw">is</span> _cost_sensitive_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="full-training-pipeline-weighted-loss" class="level3">
<h3 class="anchored" data-anchor-id="full-training-pipeline-weighted-loss">Full Training Pipeline: Weighted Loss</h3>
<div id="cell-33" class="cell" data-cell_id="674edf39faad4805a263bbdcdf883af2" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="92113" data-execution_start="1746755123453" data-source_hash="842d5caa">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ground2 <span class="op">=</span> corp.corpusBuilder(final_data)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>ground3 <span class="op">=</span>corp.corpusBuilder(final_data)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">""" Fresh weightedCRAFT Model Instances """</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>model_ground_weighted <span class="op">=</span> CostSensitiveCRAFTModel(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>model_no_last_weighted <span class="op">=</span> CostSensitiveCRAFTModel(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>model_no_submit_last_weighted <span class="op">=</span> CostSensitiveCRAFTModel(</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">"""Forecaster Model Creation"""</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground_weighted_loss <span class="op">=</span> Forecaster(</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_ground_weighted,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_weighted_loss <span class="op">=</span> Forecaster(</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_no_last_weighted,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit_weighted_loss <span class="op">=</span> Forecaster(</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_no_submit_last_weighted,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="co">""" Training """</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground_weighted_loss.fit(</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground, </span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_weighted_loss.fit(</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last, </span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit_weighted_loss.fit(</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last, </span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="co">""" Testing """</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground <span class="op">=</span> forecaster_kodis_ground_weighted_loss.transform(ground1, transform_selector)</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>ground_weight_df, ground_weight_metrics <span class="op">=</span> forecaster_kodis_ground_weighted_loss.summarize(corpus_kodis_ground, convo_selector)</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>ground_weight_horizon <span class="op">=</span> forecaster_kodis_ground_weighted_loss._draw_horizon_plot(corpus_kodis_ground, convo_selector)</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_no_last_weighted_loss.transform(ground2, transform_selector)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>no_last_weight_df, no_last_weight_metrics <span class="op">=</span> forecaster_kodis_no_last_weighted_loss.summarize(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>no_last_weight_horizon <span class="op">=</span> forecaster_kodis_no_last_weighted_loss._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>corpus_kodis_no_ground_nls <span class="op">=</span> forecaster_kodis_no_last_submit_weighted_loss.transform(ground3, transform_selector)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>no_last_submit_weight_df, no_last_submit_weight_metrics <span class="op">=</span> forecaster_kodis_no_last_submit_weighted_loss.summarize(corpus_kodis_no_ground_nls, convo_selector)</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>no_last_submit_weight_horizon <span class="op">=</span> forecaster_kodis_no_last_submit_weighted_loss._draw_horizon_plot(corpus_kodis_no_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="plotting-results-conversation-level-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results-conversation-level-aggregation">Plotting Results (Conversation Level Aggregation)</h3>
<div id="cell-35" class="cell" data-cell_id="6f3d739c406e4af4bdf1ca91d03f1787" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="1151" data-execution_start="1746755317193" data-source_hash="2d8b83ed">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>corpora_info_weighted <span class="op">=</span> [</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST_SUBMIT"</span>, corpus_kodis_ground, no_last_submit_weight_metrics, no_last_submit_weight_df, no_last_submit_weight_horizon),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST"</span>,         corpus_kodis_ground, no_last_weight_metrics,  no_last_weight_df, no_last_weight_horizon),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_GROUND"</span>,          corpus_kodis_ground, ground_weight_metrics, ground_weight_df, ground_weight_horizon)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>compare_craft_models(corpora_info_weighted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="saving-experiment-1" class="level3">
<h3 class="anchored" data-anchor-id="saving-experiment-1">Saving Experiment</h3>
<div id="cell-37" class="cell" data-cell_id="c6be44f7f1414e2d829b74212847f041" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="16110" data-execution_start="1746755448063" data-source_hash="87f0a76b" data-execution_count="265">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> save_helpers</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>save_helpers.save_weighted()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="fine-tuning-downsampling-successful-disputes" class="level1">
<h1>Fine-tuning: Downsampling Successful Disputes</h1>
<section id="downsampling-logic" class="level3">
<h3 class="anchored" data-anchor-id="downsampling-logic">Downsampling Logic</h3>
<ul>
<li>Paper controls for topic and length. Check differences in conversation length from each corpus</li>
<li>Original fine-tuning size (after crowdsourcing extra long examples in Wiki data):
<ul>
<li>4188 conversations total (≈ 2 094 derail + 2 094 clean).</li>
<li>Train/dev/test split: 60/20/20 → Train ≈ 2512, Dev ≈ 420, Test ≈ 420</li>
</ul></li>
<li>Our fine-tuning size:
<ul>
<li>2107 conversations total (≈ 371 derail + 1734 clean).</li>
<li>Train/dev/test split: 60/20/20 → Train ≈1264, Dev ≈ 421, Test ≈ 421</li>
</ul></li>
</ul>
</section>
<section id="model-configuration" class="level3">
<h3 class="anchored" data-anchor-id="model-configuration">Model Configuration</h3>
<ul>
<li>increased fine-tune epochs (30 -&gt; 35) in configuration to get better loss convergence. Stopped at ~ .306 with 210 iterations. Trains for 350 iterations now</li>
</ul>
</section>
<section id="reset-runner.py" class="level3">
<h3 class="anchored" data-anchor-id="reset-runner.py">Reset runner.py</h3>
<div id="cell-42" class="cell" data-cell_id="8205cc3bac5941d0a03d25e95ff21600" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="846797f6-f8a0-4c1a-876f-fa1142ed4414" data-execution_millis="1" data-execution_start="1746748040229" data-source_hash="6e88fe41" data-execution_count="200">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>runners.train <span class="op">=</span> _original_train</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> runners.train <span class="kw">is</span> _original_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="average-length-of-convo-in-each-split" class="level3">
<h3 class="anchored" data-anchor-id="average-length-of-convo-in-each-split">Average Length of Convo in each split</h3>
<div id="cell-44" class="cell" data-cell_id="ecb2a7fcbe7e46da9d9f71fb0f2c803c" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="a63e91cf-e840-4b19-98a0-e3776d9efaa9" data-execution_millis="4746" data-execution_start="1746781310525" data-source_hash="a23d08fd" data-execution_count="65">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_lengths_by_split(corpus_list, split_key<span class="op">=</span><span class="st">"meta.split"</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    For each (name, corpus) in corpus_list, make one subplot that shows</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    the average conversation length (in # utterances) for each split × label.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    - split_key: the column in get_conversations_dataframe() holding your split</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(corpus_list)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n, figsize<span class="op">=</span>(<span class="dv">6</span><span class="op">*</span>n, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, (name, corpus) <span class="kw">in</span> <span class="bu">zip</span>(axes, corpus_list):</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1) utterance counts per conversation</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        utts <span class="op">=</span> corpus.get_utterances_dataframe()</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        lengths_df <span class="op">=</span> (</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            utts</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">"conversation_id"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>            .size()</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            .reset_index(name<span class="op">=</span><span class="st">"length"</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2) get split + label</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        conv_meta <span class="op">=</span> corpus.get_conversations_dataframe()</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        conv_labels <span class="op">=</span> (</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            conv_meta</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>            .rename(columns<span class="op">=</span>{</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"id"</span>: <span class="st">"conversation_id"</span>,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"meta.label"</span>: <span class="st">"label"</span>,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>                split_key: <span class="st">"split"</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            })[[<span class="st">"conversation_id"</span>, <span class="st">"label"</span>, <span class="st">"split"</span>]]</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3) merge and compute mean length by split × label</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> lengths_df.merge(conv_labels, on<span class="op">=</span><span class="st">"conversation_id"</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        mean_by <span class="op">=</span> (</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            merged</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            .groupby([<span class="st">"split"</span>, <span class="st">"label"</span>])[<span class="st">"length"</span>]</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>            .mean()</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"Unsuccessful"</span>, <span class="dv">1</span>: <span class="st">"Successful"</span>})</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4) plot grouped bar chart</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        mean_by.plot(</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>            kind<span class="op">=</span><span class="st">"bar"</span>,</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>            rot<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span>name</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Data Split"</span>)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Avg. # Utterances"</span>)</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># move legend to lower right</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">"lower right"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5) annotate numeric values atop each bar</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> p.get_height()</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>            ax.text(</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>                p.get_x() <span class="op">+</span> p.get_width()<span class="op">/</span><span class="dv">2</span>,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>                h <span class="op">+</span> <span class="fl">0.05</span>,</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>h<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>                va<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">8</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">"Avg. Conversation Length by Split &amp; Outcome"</span>, y<span class="op">=</span><span class="fl">1.02</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_lengths_by_label(corpus_list):</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a><span class="co">    For each (name, corpus) in corpus_list, plot a bar chart of</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="co">    average conversation length (#utterances) for Successful (label=1)</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="co">    vs Unsuccessful (label=0).</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(corpus_list)</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n, figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span>n, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, (name, corpus) <span class="kw">in</span> <span class="bu">zip</span>(axes, corpus_list):</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1) get number of utterances per convo</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>        utts <span class="op">=</span> corpus.get_utterances_dataframe()</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>        lengths <span class="op">=</span> (</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>            utts</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">"conversation_id"</span>)</span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>            .size()</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>            .reset_index(name<span class="op">=</span><span class="st">"length"</span>)</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2) pull labels</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>        conv_meta <span class="op">=</span> corpus.get_conversations_dataframe()</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> (</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>            conv_meta</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>            .loc[:, [<span class="st">"id"</span>, <span class="st">"meta.label"</span>]]</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>            .rename(columns<span class="op">=</span>{<span class="st">"id"</span>:<span class="st">"conversation_id"</span>,<span class="st">"meta.label"</span>:<span class="st">"label"</span>})</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3) merge and take mean by label</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> lengths.merge(labels, on<span class="op">=</span><span class="st">"conversation_id"</span>)</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>        avg_by_label <span class="op">=</span> df.groupby(<span class="st">"label"</span>)[<span class="st">"length"</span>].mean().rename({<span class="dv">0</span>:<span class="st">"Unsuccessful"</span>,<span class="dv">1</span>:<span class="st">"Successful"</span>})</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4) plot</span></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>        avg_by_label.plot(kind<span class="op">=</span><span class="st">"bar"</span>, ax<span class="op">=</span>ax, rot<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span>[<span class="st">"C0"</span>,<span class="st">"C1"</span>])</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Outcome"</span>)</span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Avg. # Utterances"</span>)</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># annotate</span></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>            ax.text(</span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a>                p.get_x()<span class="op">+</span>p.get_width()<span class="op">/</span><span class="dv">2</span>,</span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>                p.get_height()<span class="op">+</span><span class="fl">0.1</span>,</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">.</span>get_height()<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span>, fontsize<span class="op">=</span><span class="dv">9</span></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">"Average Conversation Length by Outcome"</span>, y<span class="op">=</span><span class="fl">1.05</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a>compare_lengths_by_split([</span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Ground Truth"</span>, corpus_kodis_ground),</span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last Utterance"</span>, corpus_kodis_no_last),</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last or Submit"</span>, corpus_kodis_no_submit_last)</span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>compare_lengths_by_label([</span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Ground Truth"</span>, corpus_kodis_ground),</span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last Utterance"</span>, corpus_kodis_no_last),</span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last or Submit"</span>, corpus_kodis_no_submit_last)</span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-23-output-1.png" width="1790" height="413" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-23-output-2.png" width="1489" height="425" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="downsample-successful-disputes-train-split-only" class="level3">
<h3 class="anchored" data-anchor-id="downsample-successful-disputes-train-split-only">Downsample Successful Disputes (Train Split Only)</h3>
<div id="cell-46" class="cell" data-cell_id="5a28fcdf51cd45c1852861cad5c88113" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="272" data-execution_start="1746785546746" data-source_hash="867a07d0" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> downsample_train_to_balance(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    corpus: Corpus,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    split_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"split"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    label_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">"label"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    seed: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Corpus:</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Within the TRAIN split only, randomly remove conversations from the majority</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    label until train has the same number of examples of each label.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Val/test splits are left untouched.</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    :param corpus:     your ConvoKit Corpus</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    :param split_key:  conversation.meta field that holds your split tags</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">    :param label_key:  conversation.meta field that holds 0/1 labels</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    :param seed:       for reproducibility</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">    :returns:          a filtered Corpus (in place) with a balanced train split</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        random.seed(seed)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect train IDs by label</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    train_ids <span class="op">=</span> {<span class="dv">0</span>: [], <span class="dv">1</span>: []}</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>            lbl <span class="op">=</span> convo.meta.get(label_key)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> lbl <span class="kw">in</span> train_ids:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                train_ids[lbl].append(convo.<span class="bu">id</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine Minority in current split</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> {lbl: <span class="bu">len</span>(ids) <span class="cf">for</span> lbl, ids <span class="kw">in</span> train_ids.items()}</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    minority_lbl, majority_lbl <span class="op">=</span> <span class="bu">min</span>(counts, key<span class="op">=</span>counts.get), <span class="bu">max</span>(counts, key<span class="op">=</span>counts.get)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    target_n <span class="op">=</span> counts[minority_lbl]</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random sampling majority class</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    keep_majority <span class="op">=</span> <span class="bu">set</span>(random.sample(train_ids[majority_lbl], target_n))</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    keep_minority <span class="op">=</span> <span class="bu">set</span>(train_ids[minority_lbl])</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    keep_train_ids <span class="op">=</span> keep_minority <span class="op">|</span> keep_majority</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Selector Helper</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> selector(convo):</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> <span class="st">"train"</span>:</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> convo.<span class="bu">id</span> <span class="kw">in</span> keep_train_ids</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5) filter (in place) and return</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corpus.filter_conversations_by(selector)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_downsampled <span class="op">=</span> downsample_train_to_balance(corpus_kodis_ground,seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>corpus_kodis_no_last_downsampled <span class="op">=</span> downsample_train_to_balance(corpus_kodis_no_last, seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>corpus_kodis_no_submit_last_downsampled <span class="op">=</span> downsample_train_to_balance(corpus_kodis_no_submit_last,seed<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-47" class="cell" data-cell_id="8af449ff5fb04061b03161e6c215b229" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="4484" data-execution_start="1746785555359" data-source_hash="bdb6420" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>corpus_list <span class="op">=</span> [</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Ground Truth"</span>, corpus_kodis_ground),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last Utterance"</span>, corpus_kodis_no_last),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"No Last or Submit"</span>, corpus_kodis_no_submit_last)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_counts_and_avg_lengths(corpus_list, split_key<span class="op">=</span><span class="st">"split"</span>, length_func<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Stack two vertically:</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">      1) Counts by split &amp; outcome</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">      2) Avg. length by split &amp; outcome</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">    - No extra spacing between each Impasse/Success pair.</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">    - Each plot has its own x‑axis label.</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">    - Only one legend (on the top chart).</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">    - Now: label==1 → Impasse (red), label==0 → Success (green).</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> length_func <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        length_func <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="bu">len</span>(convo.get_utterances_dataframe())</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) discover splits</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    all_splits <span class="op">=</span> []</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, corpus <span class="kw">in</span> corpus_list:</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        all_splits <span class="op">+=</span> [c.meta.get(split_key) <span class="cf">for</span> c <span class="kw">in</span> corpus.iter_conversations()]</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    preferred <span class="op">=</span> [<span class="st">"train"</span>, <span class="st">"val"</span>, <span class="st">"test"</span>]</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    splits <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> preferred <span class="cf">if</span> s <span class="kw">in</span> all_splits] <span class="op">+</span> <span class="bu">sorted</span>(<span class="bu">set</span>(all_splits) <span class="op">-</span> <span class="bu">set</span>(preferred))</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    n_splits <span class="op">=</span> <span class="bu">len</span>(splits)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    n_corpi <span class="op">=</span> <span class="bu">len</span>(corpus_list)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    labels  <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">1</span>]  <span class="co"># 0=Success, 1=Impasse</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) bar geometry: no intra‑pair gap</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    width     <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    block_w   <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> width     <span class="co"># Success + Impasse</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    split_gap <span class="op">=</span> width <span class="op">*</span> <span class="fl">1.5</span>    <span class="co"># gap between blocks</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    group_step <span class="op">=</span> n_corpi <span class="op">*</span> block_w <span class="op">+</span> split_gap</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    group_centers <span class="op">=</span> np.arange(n_splits) <span class="op">*</span> group_step</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) compute counts &amp; avg lengths</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> np.zeros((n_corpi, n_splits, <span class="dv">2</span>), <span class="bu">int</span>)</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    avglen <span class="op">=</span> np.zeros((n_corpi, n_splits, <span class="dv">2</span>), <span class="bu">float</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (_, corpus) <span class="kw">in</span> <span class="bu">enumerate</span>(corpus_list):</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>        buckets <span class="op">=</span> {(sp,lab): [] <span class="cf">for</span> sp <span class="kw">in</span> splits <span class="cf">for</span> lab <span class="kw">in</span> labels}</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>            sp, lab <span class="op">=</span> convo.meta.get(split_key), convo.meta.get(<span class="st">"label"</span>)</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sp <span class="kw">in</span> splits <span class="kw">and</span> lab <span class="kw">in</span> labels:</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>                buckets[(sp,lab)].append(convo)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> si, sp <span class="kw">in</span> <span class="bu">enumerate</span>(splits):</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> li, lab <span class="kw">in</span> <span class="bu">enumerate</span>(labels):</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>                convs <span class="op">=</span> buckets[(sp,lab)]</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>                counts[i,si,li] <span class="op">=</span> <span class="bu">len</span>(convs)</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>                avglen[i,si,li] <span class="op">=</span> np.mean([length_func(c) <span class="cf">for</span> c <span class="kw">in</span> convs]) <span class="cf">if</span> convs <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) create subplots</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>), sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5) draw bars</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (name, _) <span class="kw">in</span> <span class="bu">enumerate</span>(corpus_list):</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        block_center <span class="op">=</span> group_centers <span class="op">+</span> (i <span class="op">-</span> (n_corpi<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> block_w</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> li, lab <span class="kw">in</span> <span class="bu">enumerate</span>(labels):</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># now lab==1 → impasse → Reds, lab==0 → success → Greens</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>            cmap <span class="op">=</span> plt.get_cmap(<span class="st">"Reds"</span>)   <span class="cf">if</span> lab<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> plt.get_cmap(<span class="st">"Greens"</span>)</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> cmap((i<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>(n_corpi<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># offset: success left, impasse right</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">=</span> block_center <span class="op">+</span> (li<span class="op">*</span>width <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># top: counts</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>            ax1.bar(offset, counts[i,:,lab], width, color<span class="op">=</span>color)</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> si <span class="kw">in</span> <span class="bu">range</span>(n_splits):</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> counts[i,si,lab]</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>                ax1.text(offset[si], h<span class="op">+</span><span class="dv">1</span>, <span class="bu">str</span>(h),</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>                         ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># bottom: avg length</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>            ax2.bar(offset, avglen[i,:,lab], width, color<span class="op">=</span>color)</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> si <span class="kw">in</span> <span class="bu">range</span>(n_splits):</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>                h2 <span class="op">=</span> avglen[i,si,lab]</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>                ax2.text(offset[si], h2<span class="op">+</span><span class="fl">0.3</span>, <span class="ss">f"</span><span class="sc">{</span>h2<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>                         ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) legend: one entry per corpus×outcome</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>    legend_handles <span class="op">=</span> []</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>    legend_labels  <span class="op">=</span> []</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (name, _) <span class="kw">in</span> <span class="bu">enumerate</span>(corpus_list):</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> lab <span class="kw">in</span> labels:</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>            cmap <span class="op">=</span> plt.get_cmap(<span class="st">"Reds"</span>)   <span class="cf">if</span> lab<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> plt.get_cmap(<span class="st">"Greens"</span>)</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> cmap((i<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>(n_corpi<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> – </span><span class="sc">{</span><span class="st">'Impasse'</span> <span class="cf">if</span> lab<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> <span class="st">'Success'</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>            legend_handles.append(Patch(color<span class="op">=</span>color))</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>            legend_labels.append(label)</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    ax1.legend(legend_handles, legend_labels,</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">10</span>, frameon<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>               bbox_to_anchor<span class="op">=</span>(<span class="fl">1.02</span>, <span class="fl">0.5</span>), loc<span class="op">=</span><span class="st">"center left"</span>)</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7) format top</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">"Number of Conversations by Split &amp; Outcome"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">"Count"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticks(group_centers)</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticklabels([])             <span class="co"># no x‑labels on top</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">""</span>)                  <span class="co"># clear x‑label</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8) format bottom</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">"Average Conversation Length by Split &amp; Outcome"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">"Avg. # Utterances"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticks(group_centers)</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticklabels(splits, fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">"Split"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>plot_counts_and_avg_lengths(corpus_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-25-output-1.png" width="1188" height="1189" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="full-training-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="full-training-pipeline-1">Full Training Pipeline</h3>
<div id="cell-49" class="cell" data-cell_id="4f5a8ff3579a41fca6736856be4bb7d1" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="110902" data-execution_start="1746785886922" data-source_hash="182a394d">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ground2<span class="op">=</span> corp.corpusBuilder(final_data)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>ground3<span class="op">=</span>corp.corpusBuilder(final_data)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>DEFAULT_CONFIG_downsampled <span class="op">=</span> {</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dropout"</span>: <span class="fl">0.1</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: <span class="dv">64</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clip"</span>: <span class="fl">50.0</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="fl">1e-5</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"print_every"</span>: <span class="dv">10</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"finetune_epochs"</span>:<span class="dv">35</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"validation_size"</span>: <span class="fl">0.2</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co">""" Model Creation """</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>model_ground_downsampled <span class="op">=</span> CRAFTModel(</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> DEFAULT_CONFIG_downsampled</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>model_no_last_downsampled <span class="op">=</span> CRAFTModel(</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i, </span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    config<span class="op">=</span>DEFAULT_CONFIG_downsampled</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>model_no_submit_last_downsampled <span class="op">=</span> CRAFTModel(</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span>model,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span>DEVICE,</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    vocab_index2word<span class="op">=</span>vocab_i2w,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    vocab_word2index<span class="op">=</span>vocab_w2i,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    config<span class="op">=</span>DEFAULT_CONFIG_downsampled</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co">"""Forecaster Model Creation """</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground_downsampled <span class="op">=</span> Forecaster(</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span>model_ground_downsampled,</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_downsampled <span class="op">=</span> Forecaster(</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_no_last_downsampled,</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit_downsampled <span class="op">=</span> Forecaster(</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_no_submit_last_downsampled,</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="co">"""Training """</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_ground_downsampled.fit(</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_downsampled, </span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_downsampled.fit(</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last_downsampled, </span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_no_last_submit_downsampled.fit(</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last_downsampled, </span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>    context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"train"</span>), </span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    val_context_selector<span class="op">=</span>partial(fit_selector, split<span class="op">=</span><span class="st">"val"</span>))</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="co">"""Testing"""</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_orig <span class="op">=</span> forecaster_kodis_ground_downsampled.transform(ground1, transform_selector)</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>ground_downsampled_df, ground_downsampled_metrics <span class="op">=</span> forecaster_kodis_ground_downsampled.summarize(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>groun_horizon_downsampled <span class="op">=</span> forecaster_kodis_ground_downsampled._draw_horizon_plot(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_no_last_downsampled.transform(ground2, transform_selector)</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>no_last_downsampled_df, no_last_downsampled_metrics <span class="op">=</span> forecaster_kodis_no_last_downsampled.summarize(corpus_kodis_ground_nl , convo_selector)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>no_last_horizon_downsampled <span class="op">=</span> forecaster_kodis_no_last_downsampled._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nls <span class="op">=</span> forecaster_kodis_no_last_submit_downsampled.transform(ground3, transform_selector)</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>no_last_submit_downsampled_df, no_last_submit_downsampled_metrics <span class="op">=</span> forecaster_kodis_no_last_submit_downsampled.summarize(corpus_kodis_ground_nls,convo_selector)</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>no_last_submit_horizon_downsampled <span class="op">=</span> forecaster_kodis_no_last_submit_downsampled._draw_horizon_plot(corpus_kodis_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="saving-results" class="level3">
<h3 class="anchored" data-anchor-id="saving-results">Saving Results</h3>
<div id="cell-51" class="cell" data-cell_id="78c132b79d204e03a1fa55f178a6c17a" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="23020" data-execution_start="1746786090283" data-source_hash="12a9478d">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>save_downsampled()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="plotting-results-conversation-level-aggregation-1" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results-conversation-level-aggregation-1">Plotting Results (Conversation Level Aggregation)</h3>
<div id="cell-53" class="cell" data-cell_id="a4635ad3673d4976b41912b021c81687" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true" data-execution_context_id="2558b8e1-9529-4158-82be-9bd268bd79d2" data-execution_millis="1216" data-execution_start="1746786058673" data-source_hash="59370e8e">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>corpora_info_downsampled <span class="op">=</span> [</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST_SUBMIT"</span>, corpus_kodis_ground, no_last_submit_downsampled_metrics, no_last_submit_downsampled_df, no_last_submit_horizon_downsampled),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_NO_LAST"</span>,         corpus_kodis_ground, no_last_downsampled_metrics,  no_last_downsampled_df,  no_last_horizon_downsampled),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"KODIS_GROUND"</span>,          corpus_kodis_ground, ground_downsampled_metrics, ground_downsampled_df, groun_horizon_downsampled)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>compare_craft_models(corpora_info_downsampled)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="testing-on-fine-tuned-wiki-model" class="level1">
<h1>Testing on Fine-Tuned Wiki Model</h1>
<div id="cell-55" class="cell" data-cell_id="6cc5c49adc9542298bf3d40693af649b" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="38601" data-execution_start="1746806081545" data-source_hash="cdf4fb33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">""" New Testing Corpus """</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ground1 <span class="op">=</span> corp.corpusBuilder(final_data) </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>ground2<span class="op">=</span> corp.corpusBuilder(final_data_no_last)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>ground3<span class="op">=</span>corp.corpusBuilder(final_data_no_submit_last)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground1, final_data)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground2, final_data)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>add_convo_labels(ground3, final_data)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground1)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground2)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>corpus_train_test_split(ground3)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">""" CRAFT MODEL INSTANCES """</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>model_wiki <span class="op">=</span> CRAFTModel(</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span> <span class="st">"craft-wiki-finetuned"</span>,  <span class="co"># or "craft-wiki-finetuned"</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span><span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co">""" FORECASTER MODEL INSTANCE """</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>forecaster_kodis_wiki <span class="op">=</span> Forecaster(</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    forecaster_model<span class="op">=</span> model_wiki,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    labeler<span class="op">=</span><span class="st">"label"</span>,  <span class="co"># uses conversation.meta["label"]</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    forecast_attribute_name<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    forecast_prob_attribute_name<span class="op">=</span><span class="st">"pred_score"</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co">"""Testing"""</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_orig <span class="op">=</span> forecaster_kodis_wiki.transform(ground1, transform_selector)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>ground_wiki_df, ground_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>ground_wiki_horizon <span class="op">=</span>forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_orig, convo_selector)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nl <span class="op">=</span> forecaster_kodis_wiki.transform(ground2, transform_selector)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>no_last_wiki_df, no_last_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nl , convo_selector)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>no_last_wiki_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nl, convo_selector)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>corpus_kodis_ground_nls <span class="op">=</span> forecaster_kodis_wiki.transform(ground3, transform_selector)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>no_last_submit_wiki_df, no_last_submit_wiki_metrics <span class="op">=</span> forecaster_kodis_wiki.summarize(corpus_kodis_ground_nls,convo_selector)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>no_last_submit_horizon <span class="op">=</span> forecaster_kodis_wiki._draw_horizon_plot(corpus_kodis_ground_nls, convo_selector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="plotting-results-1" class="level3">
<h3 class="anchored" data-anchor-id="plotting-results-1">Plotting Results</h3>
<div id="cell-57" class="cell" data-cell_id="08639a469f3548e58fbfeb423a411711" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2803" data-execution_start="1746806175776" data-source_hash="f9333b7f">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>best_thresholds_wiki, best_metrics_wiki, best_corpora_wiki <span class="op">=</span>compare_craft_models(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"KODIS_NO_LAST_SUBMIT"</span>, corpus_kodis_ground_orig, no_last_submit_wiki_metrics, no_last_submit_wiki_df, no_last_submit_horizon),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"KODIS_NO_LAST"</span>,         corpus_kodis_ground_nl, no_last_wiki_metrics,  no_last_wiki_df,  no_last_wiki_horizon),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"KODIS_WIKI"</span>,          corpus_kodis_ground_nls, ground_wiki_metrics, ground_wiki_df, ground_wiki_horizon),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>compare_best_models(best_thresholds_wiki, best_metrics_wiki, best_corpora_wiki)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>wiki <span class="op">=</span>{}</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_orig</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_metrics"</span>] <span class="op">=</span> ground_wiki_metrics</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_df"</span>] <span class="op">=</span>  ground_wiki_df</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"ground_horizon"</span>] <span class="op">=</span> ground_wiki_horizon</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nl</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_metrics"</span>] <span class="op">=</span> no_last_wiki_metrics</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_df"</span>] <span class="op">=</span>  no_last_wiki_df</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_horizon"</span>] <span class="op">=</span> no_last_wiki_horizon</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_corpus"</span>] <span class="op">=</span> corpus_kodis_ground_nls</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_metrics"</span>] <span class="op">=</span> no_last_submit_wiki_metrics</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_df"</span>] <span class="op">=</span>  no_last_submit_wiki_df</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>wiki[<span class="st">"no_last_submit_horizon"</span>] <span class="op">=</span> no_last_submit_horizon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="analysis-across-all-experiments" class="level1">
<h1>Analysis Across All Experiments</h1>
<section id="ground-model-performance-comparison-across-default-weighteddownsampled-variants" class="level2">
<h2 class="anchored" data-anchor-id="ground-model-performance-comparison-across-default-weighteddownsampled-variants">Ground Model Performance Comparison Across Default, Weighted,Downsampled Variants</h2>
<div id="cell-60" class="cell" data-cell_id="3ad794368af74ed2b90a93e29d331c97" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2171" data-execution_start="1746807576016" data-source_hash="92a129e9" data-execution_count="128">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>corpora_info_ground <span class="op">=</span> [</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DEFAULT"</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_corpus"</span>],</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_metrics"</span>],</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_df"</span>],</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        no_samp   [<span class="st">"ground_horizon"</span>],</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WEIGHTED"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_corpus"</span>],</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_metrics"</span>],</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_df"</span>],</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        wt        [<span class="st">"ground_horizon"</span>],</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_DOWNSAMPLED"</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_df"</span>],</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        down      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>best_thresholds_ground, best_metrics_ground, best_corpora_ground <span class="op">=</span> compare_craft_models(corpora_info_ground)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Avg. Conversation Length ==
  GROUND_DEFAULT        train=13.0  test=13.1
  GROUND_WEIGHTED       train=13.1  test=13.1
  GROUND_DOWNSAMPLED    train=13.0  test=13.1
  GROUND_WIKI           train=13.0  test=13.1

== Conversation‑level Test Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DEFAULT</td>
<td>0.303318</td>
<td>0.198910</td>
<td>1.000000</td>
<td>0.842407</td>
<td>0.331818</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WEIGHTED</td>
<td>0.175355</td>
<td>0.173397</td>
<td>1.000000</td>
<td>0.997135</td>
<td>0.295547</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED</td>
<td>0.172986</td>
<td>0.172986</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.294949</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.443128</td>
<td>0.228188</td>
<td>0.931507</td>
<td>0.659026</td>
<td>0.366577</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-31-output-3.png" width="1990" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-31-output-4.png" width="1189" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-31-output-5.png" width="1590" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GROUND_DEFAULT       best thr=0.541, TPR=1.000, FPR=0.000, J=1.000
GROUND_WEIGHTED      best thr=0.575, TPR=0.699, FPR=0.072, J=0.627
GROUND_DOWNSAMPLED   best thr=0.581, TPR=0.671, FPR=0.112, J=0.559
GROUND_WIKI          best thr=0.872, TPR=0.740, FPR=0.264, J=0.476</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-31-output-7.png" width="1189" height="490" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== Summary of Convo Acc &amp; Avg Prob ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">GROUND_DEFAULT_acc</th>
<th data-quarto-table-cell-role="th">GROUND_WEIGHTED_acc</th>
<th data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED_acc</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_acc</th>
<th data-quarto-table-cell-role="th">GROUND_DEFAULT_avg_prob</th>
<th data-quarto-table-cell-role="th">GROUND_WEIGHTED_avg_prob</th>
<th data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED_avg_prob</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_avg_prob</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">conversation_level</td>
<td>0.303318</td>
<td>0.175355</td>
<td>0.172986</td>
<td>0.443128</td>
<td>0.519425</td>
<td>0.560313</td>
<td>0.56887</td>
<td>0.712573</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="best-threshold-performance-comparison" class="level3">
<h3 class="anchored" data-anchor-id="best-threshold-performance-comparison">Best Threshold Performance Comparison</h3>
<div id="cell-62" class="cell" data-cell_id="6f55303abf884a0e9f3ecc03da16fe05" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1287" data-execution_start="1746807594538" data-source_hash="a10bb788" data-execution_count="131">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>compare_best_models(best_thresholds_ground, best_metrics_ground, best_corpora_ground)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Conversation‑level Best Threshold Test Set Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
<th data-quarto-table-cell-role="th">Threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DEFAULT</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.541032</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.575249</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">GROUND_DOWNSAMPLED</td>
<td>0.850711</td>
<td>0.556818</td>
<td>0.671233</td>
<td>0.111748</td>
<td>0.608696</td>
<td>0.580783</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.736967</td>
<td>0.369863</td>
<td>0.739726</td>
<td>0.263610</td>
<td>0.493151</td>
<td>0.871697</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-32-output-3.png" width="1590" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/root/venv/lib/python3.11/site-packages/numpy/lib/_histograms_impl.py:902: RuntimeWarning: invalid value encountered in divide
  return n/db/n.sum(), bin_edges</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-32-output-5.png" width="1990" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="no-last-utterance-model-performance-comparison-across-default-weighteddownsampled-variants" class="level2">
<h2 class="anchored" data-anchor-id="no-last-utterance-model-performance-comparison-across-default-weighteddownsampled-variants">No Last Utterance Model Performance Comparison Across Default, Weighted,Downsampled Variants</h2>
<div id="cell-64" class="cell" data-cell_id="23de4ba4c4074fc287256da4a3fc104d" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2198" data-execution_start="1746807841076" data-source_hash="b9c284af" data-execution_count="134">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>corpora_info_no_last <span class="op">=</span> [</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DEFAULT"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_df"</span>],</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_WEIGHTED"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_df"</span>],</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_DOWNSAMPLED"</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_corpus"</span>],</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_metrics"</span>],</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_df"</span>],</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_last_horizon"</span>],</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>best_thresholds_no_last, best_metrics_no_last, best_corpora_no_last <span class="op">=</span> compare_craft_models(corpora_info_no_last)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Avg. Conversation Length ==
  NO_LAST_DEFAULT       train=13.0  test=13.1
  NO_LAST_WEIGHTED      train=13.1  test=13.1
  NO_LAST_DOWNSAMPLED   train=13.0  test=13.1
  GROUND_WIKI           train=13.0  test=13.1

== Conversation‑level Test Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DEFAULT</td>
<td>0.175355</td>
<td>0.173397</td>
<td>1.000000</td>
<td>0.997135</td>
<td>0.295547</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_WEIGHTED</td>
<td>0.172986</td>
<td>0.172986</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.294949</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED</td>
<td>0.172986</td>
<td>0.172986</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.294949</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.443128</td>
<td>0.228188</td>
<td>0.931507</td>
<td>0.659026</td>
<td>0.366577</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-33-output-3.png" width="1990" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-33-output-4.png" width="1189" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-33-output-5.png" width="1590" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NO_LAST_DEFAULT      best thr=0.555, TPR=0.699, FPR=0.499, J=0.200
NO_LAST_WEIGHTED     best thr=0.577, TPR=0.630, FPR=0.441, J=0.189
NO_LAST_DOWNSAMPLED  best thr=0.560, TPR=0.890, FPR=0.665, J=0.226
GROUND_WIKI          best thr=0.872, TPR=0.740, FPR=0.264, J=0.476</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-33-output-7.png" width="1189" height="490" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== Summary of Convo Acc &amp; Avg Prob ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NO_LAST_DEFAULT_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_WEIGHTED_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED_acc</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_DEFAULT_avg_prob</th>
<th data-quarto-table-cell-role="th">NO_LAST_WEIGHTED_avg_prob</th>
<th data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED_avg_prob</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_avg_prob</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">conversation_level</td>
<td>0.175355</td>
<td>0.172986</td>
<td>0.172986</td>
<td>0.443128</td>
<td>0.557905</td>
<td>0.574563</td>
<td>0.568332</td>
<td>0.712573</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="best-threshold-performance-comparison-1" class="level3">
<h3 class="anchored" data-anchor-id="best-threshold-performance-comparison-1">Best Threshold Performance Comparison</h3>
<div id="cell-66" class="cell" data-cell_id="1b888374abde49a880c0f8c810b93605" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1360" data-execution_start="1746807891266" data-source_hash="4c48aee8" data-execution_count="137">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>compare_best_models(best_thresholds_no_last, best_metrics_no_last, best_corpora_no_last)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Conversation‑level Best Threshold Test Set Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
<th data-quarto-table-cell-role="th">Threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DEFAULT</td>
<td>0.535545</td>
<td>0.226667</td>
<td>0.698630</td>
<td>0.498567</td>
<td>0.342282</td>
<td>0.555385</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_WEIGHTED</td>
<td>0.827014</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.576696</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_DOWNSAMPLED</td>
<td>0.431280</td>
<td>0.218855</td>
<td>0.890411</td>
<td>0.664756</td>
<td>0.351351</td>
<td>0.559719</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.736967</td>
<td>0.369863</td>
<td>0.739726</td>
<td>0.263610</td>
<td>0.493151</td>
<td>0.871697</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-34-output-3.png" width="1590" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/root/venv/lib/python3.11/site-packages/numpy/lib/_histograms_impl.py:902: RuntimeWarning: invalid value encountered in divide
  return n/db/n.sum(), bin_edges</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-34-output-5.png" width="1989" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants" class="level2">
<h2 class="anchored" data-anchor-id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</h2>
<div id="cell-68" class="cell" data-cell_id="cc9914ffd146479ab128cf342a8584b5" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2155" data-execution_start="1746807959546" data-source_hash="f8dd4366" data-execution_count="140">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>corpora_info_no_subm <span class="op">=</span> [</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DEFAULT"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_df"</span>],</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        no_samp[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_WEIGHTED"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_df"</span>],</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        wt[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NO_LAST_SUBMIT_DOWNSAMPLED"</span>,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_corpus"</span>],</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_metrics"</span>],</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_df"</span>],</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        down[<span class="st">"no_subm_horizon"</span>],</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    ), (</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GROUND_WIKI"</span>,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_corpus"</span>],</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_metrics"</span>],</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_df"</span>],</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        wiki      [<span class="st">"ground_horizon"</span>],</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>no_last_submit_thresholds, no_last_submit_metrics, no_last_submit_corpora <span class="op">=</span> compare_craft_models(corpora_info_no_subm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Avg. Conversation Length ==
  NO_LAST_SUBMIT_DEFAULT  train=13.0  test=13.1
  NO_LAST_SUBMIT_WEIGHTED  train=13.1  test=13.1
  NO_LAST_SUBMIT_DOWNSAMPLED  train=13.0  test=13.1
  GROUND_WIKI           train=13.0  test=13.1

== Conversation‑level Test Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT</td>
<td>0.670616</td>
<td>0.318681</td>
<td>0.794521</td>
<td>0.355301</td>
<td>0.454902</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED</td>
<td>0.777251</td>
<td>0.370370</td>
<td>0.410959</td>
<td>0.146132</td>
<td>0.389610</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED</td>
<td>0.255924</td>
<td>0.188630</td>
<td>1.000000</td>
<td>0.899713</td>
<td>0.317391</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.443128</td>
<td>0.228188</td>
<td>0.931507</td>
<td>0.659026</td>
<td>0.366577</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-35-output-3.png" width="1989" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-35-output-4.png" width="1189" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-35-output-5.png" width="1590" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NO_LAST_SUBMIT_DEFAULT best thr=0.521, TPR=0.781, FPR=0.321, J=0.460
NO_LAST_SUBMIT_WEIGHTED best thr=0.497, TPR=0.699, FPR=0.252, J=0.446
NO_LAST_SUBMIT_DOWNSAMPLED best thr=0.758, TPR=0.753, FPR=0.232, J=0.521
GROUND_WIKI          best thr=0.872, TPR=0.740, FPR=0.264, J=0.476</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-35-output-7.png" width="1189" height="490" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== Summary of Convo Acc &amp; Avg Prob ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED_acc</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_acc</th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT_avg_prob</th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED_avg_prob</th>
<th data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED_avg_prob</th>
<th data-quarto-table-cell-role="th">GROUND_WIKI_avg_prob</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">conversation_level</td>
<td>0.670616</td>
<td>0.777251</td>
<td>0.255924</td>
<td>0.443128</td>
<td>0.508492</td>
<td>0.495041</td>
<td>0.677392</td>
<td>0.712573</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="best-threshold-model-performance-comparison" class="level3">
<h3 class="anchored" data-anchor-id="best-threshold-model-performance-comparison">Best Threshold Model Performance Comparison</h3>
<div id="cell-70" class="cell" data-cell_id="a353b984027449fe8bba3a8774a610fb" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1356" data-execution_start="1746807977002" data-source_hash="c09b631e" data-execution_count="143">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>compare_best_models(no_last_submit_thresholds, no_last_submit_metrics, no_last_submit_corpora)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>== Conversation‑level Best Threshold Test Set Metrics ==</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">Precision</th>
<th data-quarto-table-cell-role="th">Recall</th>
<th data-quarto-table-cell-role="th">FPR</th>
<th data-quarto-table-cell-role="th">F1</th>
<th data-quarto-table-cell-role="th">Threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DEFAULT</td>
<td>0.696682</td>
<td>0.337278</td>
<td>0.780822</td>
<td>0.320917</td>
<td>0.471074</td>
<td>0.521406</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_WEIGHTED</td>
<td>0.739336</td>
<td>0.366906</td>
<td>0.698630</td>
<td>0.252149</td>
<td>0.481132</td>
<td>0.497068</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NO_LAST_SUBMIT_DOWNSAMPLED</td>
<td>0.765403</td>
<td>0.404412</td>
<td>0.753425</td>
<td>0.232092</td>
<td>0.526316</td>
<td>0.757998</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GROUND_WIKI</td>
<td>0.736967</td>
<td>0.369863</td>
<td>0.739726</td>
<td>0.263610</td>
<td>0.493151</td>
<td>0.871697</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-36-output-3.png" width="1591" height="390" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-36-output-4.png" width="1990" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conversation-forecasting-trends" class="level1">
<h1>Conversation Forecasting Trends</h1>
<section id="ground-model-performance-comparison-across-default-weighted-downsampled-variants" class="level2">
<h2 class="anchored" data-anchor-id="ground-model-performance-comparison-across-default-weighted-downsampled-variants">Ground Model Performance Comparison Across Default, Weighted, Downsampled Variants</h2>
<div id="cell-73" class="cell" data-cell_id="d6c10693f28849de807d43a5f2bcd9cd" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1617" data-execution_start="1746809674646" data-source_hash="31cf72cd" data-execution_count="230">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Default"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Downsampled"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Weighted"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-37-output-1.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-37-output-2.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-37-output-3.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-37-output-4.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants" class="level2">
<h2 class="anchored" data-anchor-id="no-last-utt-model-performance-comparison-across-default-weighted-downsampled-variants">No Last Utt Model Performance Comparison Across Default, Weighted, Downsampled Variants</h2>
<div id="cell-75" class="cell" data-cell_id="2309cf842bc0479d8b2807beb9443db6" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1626" data-execution_start="1746809690071" data-source_hash="a7674f59" data-execution_count="233">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Default"</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Downsampled"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_last_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last Weighted"</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-38-output-1.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-38-output-2.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-38-output-3.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-38-output-4.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants-1" class="level2">
<h2 class="anchored" data-anchor-id="no-lastno-submit-model-performance-comparison-across-default-weighted-downsampled-variants-1">No Last/No Submit Model Performance Comparison Across Default, Weighted, Downsampled Variants</h2>
<div id="cell-77" class="cell" data-cell_id="ca801bb70f8c4dc3ba79eac4eb9e3081" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1619" data-execution_start="1746809695396" data-source_hash="cb92eb89" data-execution_count="236">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(no_samp[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Default"</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(down[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Downsampled"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wt[<span class="st">"no_subm_corpus"</span>], name <span class="op">=</span> <span class="st">":No Last/No Submit Weighted"</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>plot_position_score_evolution_by_outcome(wiki[<span class="st">"ground_corpus"</span>], name <span class="op">=</span> <span class="st">"Ground Wiki"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-39-output-1.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-39-output-2.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-39-output-3.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fine-tuning_final_files/figure-html/cell-39-output-4.png" width="1177" height="522" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="analysis-with-fine-tuned-craft" class="level1">
<h1>Analysis with fine-tuned CRAFT</h1>
<div id="cell-79" class="cell" data-cell_id="b3127f82cffe495c85aedadf6a3a084d" data-deepnote_cell_type="code" data-deepnote_to_be_reexecuted="true">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>model_wiki <span class="op">=</span> CRAFTModel(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    initial_weights<span class="op">=</span> <span class="st">"craft-wiki-finetuned"</span>,  <span class="co"># or "craft-wiki-finetuned"</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    torch_device<span class="op">=</span><span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="utility-functions" class="level1">
<h1>Utility Functions</h1>
<section id="test-conversation-helpers" class="level3">
<h3 class="anchored" data-anchor-id="test-conversation-helpers">Test Conversation Helpers</h3>
<div id="cell-82" class="cell" data-cell_id="8618c0247a7042e985812ffc6aae05f5" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2032" data-execution_start="1746806136740" data-source_hash="7a70f2d6" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getTestUtterancesandConvos(corpus):</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. get utterances and conversations tables</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    utt_df <span class="op">=</span> corpus.get_utterances_dataframe()</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    conv_df <span class="op">=</span> corpus.get_conversations_dataframe()</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. find all conversation IDs in the 'test' split</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    test_convo_ids <span class="op">=</span> conv_df[conv_df[<span class="st">'meta.split'</span>] <span class="op">==</span> <span class="st">'test'</span>].index.tolist()</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. filter utterances whose conversation_id is in that list</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    test_utts <span class="op">=</span> utt_df[utt_df[<span class="st">'conversation_id'</span>].isin(test_convo_ids)]</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_utts, test_convo_ids</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getSuccessLengths(utts):</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Filter to only those rows where meta.prediction == 1</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    success_df <span class="op">=</span> utts[utts[<span class="st">'meta.prediction'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) compute length (count of utterances) per conversation</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    conversation_lengths <span class="op">=</span> (</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        utts</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'conversation_id'</span>)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        .size()</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">'length'</span>)</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) pick out only the conversations that appeared in pred1_df</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    lengths_df <span class="op">=</span> (</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        conversation_lengths</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>        .loc[success_df[<span class="st">'conversation_id'</span>].unique()]</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>        .reset_index()           <span class="co"># makes 'conversation_id' a column again</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lengths_df</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getSuccessUtterances(utts):</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Filter to only those rows where meta.prediction == 1</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    success_df <span class="op">=</span> utts[utts[<span class="st">'meta.prediction'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>ground_test_utt, ground_test_convos <span class="op">=</span> getTestUtterancesandConvos(corpus_kodis_ground)</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>no_last_test_utt, no_last_test_convos <span class="op">=</span> getTestUtterancesandConvos(corpus_kodis_no_last)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>no_submit_last_test_utt, no_submit_last_test_convos <span class="op">=</span> getTestUtterancesandConvos(corpus_kodis_no_submit_last)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_best_threshold(y_true, y_score):</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Given true labels and predicted scores, compute the ROC curve</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="co">    and return the threshold that maximizes TPR − FPR (Youden's J).</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="co">      threshold: float      — the optimal cutoff</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="co">      tpr:       float      — true positive rate at that cutoff</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="co">      fpr:       float      — false positive rate at that cutoff</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="co">      youden:    float      — J = tpr − fpr</span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>    youden <span class="op">=</span> tpr <span class="op">-</span> fpr</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>    idx    <span class="op">=</span> np.argmax(youden)</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresholds[idx], tpr[idx], fpr[idx], youden[idx]</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="save-helpers" class="level3">
<h3 class="anchored" data-anchor-id="save-helpers">Save Helpers</h3>
<div id="cell-84" class="cell" data-cell_id="3858ee6bcf194b8c99b745045a526441" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="2" data-execution_start="1746806139765" data-source_hash="c91ecda3" data-execution_count="49">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_default():</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># root directory for all experiments</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    results_root <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/nosampling'</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # make a new experiment folder, e.g. "run_20250506_153045"</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    stamp   <span class="op">=</span> datetime.now().strftime(<span class="st">"run_%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    exp_dir <span class="op">=</span> results_root <span class="op">/</span> stamp</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    exp_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each corpus into its own subfolder under this run</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_orig.dump(</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_default"</span>,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_nl.dump(</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_default"</span>,</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_ground_nls.dump(</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_submit_last_default"</span>,</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each corpus train</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground.dump(</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_default_train"</span>,</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last.dump(</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_default_train"</span>,</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last.dump(</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_submit_default_train"</span>,</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save your dataframes</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>    ground_default_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"ground_conv_default_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>    no_last_default_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"no_last_conv_df_default.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>    no_last_submit_default_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"no_last_submit_conv_default_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save your metrics.json into the same folder</span></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'ground_default_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>        json.dump(ground_default_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_default_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_default_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_submit_default_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_default_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># “horizon” dictionaries</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"ground_default_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>        json.dump(ground_default_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_default_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_default_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_submit_default_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_default_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save your checkpoints</span></span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>    checkpoint_ground_default       <span class="op">=</span> model_ground_default._model</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_last_default      <span class="op">=</span> model_no_last_default._model</span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_submit_last_default <span class="op">=</span> model_no_submit_last_default._model</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_ground_default,       exp_dir <span class="op">/</span> <span class="st">"ground_default.pt"</span>)</span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_last_default,      exp_dir <span class="op">/</span> <span class="st">"no_last_default.pt"</span>)</span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_submit_last_default, exp_dir <span class="op">/</span> <span class="st">"no_last_submit_last_default.pt"</span>)</span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Experiment saved to </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_weighted():</span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># root for all weighted‐loss experiments</span></span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>    results_root_weighted <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/nosampling_weighted'</span>)</span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make a new experiment folder, e.g. "run_20250506_154530"</span></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>    stamp <span class="op">=</span> datetime.now().strftime(<span class="st">"run_%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S"</span>)</span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a>    exp_dir <span class="op">=</span> results_root_weighted <span class="op">/</span> stamp</span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>    exp_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each weighted‐loss corpus test</span></span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground.dump(</span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_weighted_loss"</span>,</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_nl.dump(</span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_weighted_loss"</span>,</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_nls.dump(</span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_submit_weighted_loss"</span>,</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each  corpus train</span></span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground.dump(</span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_weighted_train"</span>,</span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last.dump(</span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_weighted_train"</span>,</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last.dump(</span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_submit_weighted_train"</span>,</span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write out the conversation‐length dataframes</span></span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a>    ground_weight_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"ground_weight_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>    no_last_weight_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"nolast_weight_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a>    no_last_submit_weight_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"no_submit_last_weight_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write out the JSON metrics</span></span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'ground_weighted_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>        json.dump(ground_weight_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_weighted_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_weight_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_submit_weighted_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-134"><a href="#cb55-134" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_weight_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-135"><a href="#cb55-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-136"><a href="#cb55-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"ground_weight_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-137"><a href="#cb55-137" aria-hidden="true" tabindex="-1"></a>        json.dump(ground_weight_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-138"><a href="#cb55-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_weight_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-139"><a href="#cb55-139" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_weight_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-140"><a href="#cb55-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_submit_weight_horizon.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-141"><a href="#cb55-141" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_weight_horizon, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-142"><a href="#cb55-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-143"><a href="#cb55-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save your trained checkpoints</span></span>
<span id="cb55-144"><a href="#cb55-144" aria-hidden="true" tabindex="-1"></a>    checkpoint_ground_weighted        <span class="op">=</span> model_ground_weighted._model</span>
<span id="cb55-145"><a href="#cb55-145" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_last_weighted       <span class="op">=</span> model_no_last_weighted._model</span>
<span id="cb55-146"><a href="#cb55-146" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_submit_last_weighted <span class="op">=</span> model_no_submit_last_weighted._model</span>
<span id="cb55-147"><a href="#cb55-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-148"><a href="#cb55-148" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_ground_weighted,        exp_dir <span class="op">/</span> <span class="st">"ground_weighted.pt"</span>)</span>
<span id="cb55-149"><a href="#cb55-149" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_last_weighted,       exp_dir <span class="op">/</span> <span class="st">"no_last_weighted.pt"</span>)</span>
<span id="cb55-150"><a href="#cb55-150" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_submit_last_weighted, exp_dir <span class="op">/</span> <span class="st">"no_submit_last_weighted.pt"</span>)</span>
<span id="cb55-151"><a href="#cb55-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Experiment saved to </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-152"><a href="#cb55-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-153"><a href="#cb55-153" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_downsampled():</span>
<span id="cb55-154"><a href="#cb55-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># root for all downsampled experiments</span></span>
<span id="cb55-155"><a href="#cb55-155" aria-hidden="true" tabindex="-1"></a>    results_root_downsampled <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/downsampled'</span>)</span>
<span id="cb55-156"><a href="#cb55-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-157"><a href="#cb55-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make a new experiment folder, e.g. "run_20250506_154530"</span></span>
<span id="cb55-158"><a href="#cb55-158" aria-hidden="true" tabindex="-1"></a>    stamp   <span class="op">=</span> datetime.now().strftime(<span class="st">"run_%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S"</span>)</span>
<span id="cb55-159"><a href="#cb55-159" aria-hidden="true" tabindex="-1"></a>    exp_dir <span class="op">=</span> results_root_downsampled <span class="op">/</span> stamp</span>
<span id="cb55-160"><a href="#cb55-160" aria-hidden="true" tabindex="-1"></a>    exp_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-161"><a href="#cb55-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-162"><a href="#cb55-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each downsampled corpus test</span></span>
<span id="cb55-163"><a href="#cb55-163" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_orig.dump(</span>
<span id="cb55-164"><a href="#cb55-164" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_downsampled"</span>,</span>
<span id="cb55-165"><a href="#cb55-165" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-166"><a href="#cb55-166" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-167"><a href="#cb55-167" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-168"><a href="#cb55-168" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_nl.dump(</span>
<span id="cb55-169"><a href="#cb55-169" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_downsampled"</span>,</span>
<span id="cb55-170"><a href="#cb55-170" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-171"><a href="#cb55-171" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-172"><a href="#cb55-172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-173"><a href="#cb55-173" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground_nls.dump(</span>
<span id="cb55-174"><a href="#cb55-174" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_submit_downsampled"</span>,</span>
<span id="cb55-175"><a href="#cb55-175" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-176"><a href="#cb55-176" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-177"><a href="#cb55-177" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-178"><a href="#cb55-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-179"><a href="#cb55-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dump each corpus train</span></span>
<span id="cb55-180"><a href="#cb55-180" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_ground.dump(</span>
<span id="cb55-181"><a href="#cb55-181" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_ground_downsampled_train"</span>,</span>
<span id="cb55-182"><a href="#cb55-182" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-183"><a href="#cb55-183" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-184"><a href="#cb55-184" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-185"><a href="#cb55-185" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_last.dump(</span>
<span id="cb55-186"><a href="#cb55-186" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_downsampled_train"</span>,</span>
<span id="cb55-187"><a href="#cb55-187" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-188"><a href="#cb55-188" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-189"><a href="#cb55-189" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-190"><a href="#cb55-190" aria-hidden="true" tabindex="-1"></a>    corpus_kodis_no_submit_last.dump(</span>
<span id="cb55-191"><a href="#cb55-191" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"corpus_kodis_no_last_submit_downsampled_train"</span>,</span>
<span id="cb55-192"><a href="#cb55-192" aria-hidden="true" tabindex="-1"></a>        base_path<span class="op">=</span>exp_dir,</span>
<span id="cb55-193"><a href="#cb55-193" aria-hidden="true" tabindex="-1"></a>        overwrite_existing_corpus<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-194"><a href="#cb55-194" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-195"><a href="#cb55-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-196"><a href="#cb55-196" aria-hidden="true" tabindex="-1"></a>    <span class="co">#write out the conversation‐length dataframes</span></span>
<span id="cb55-197"><a href="#cb55-197" aria-hidden="true" tabindex="-1"></a>    ground_downsampled_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"ground_downsampled_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-198"><a href="#cb55-198" aria-hidden="true" tabindex="-1"></a>    no_last_downsampled_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"nolast_downsampled_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-199"><a href="#cb55-199" aria-hidden="true" tabindex="-1"></a>    no_last_submit_downsampled_df.to_csv(exp_dir <span class="op">/</span> <span class="st">"no_submit_last_downsampled_conv_df.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb55-200"><a href="#cb55-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-201"><a href="#cb55-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write out the JSON metrics</span></span>
<span id="cb55-202"><a href="#cb55-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'ground_downsampled_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-203"><a href="#cb55-203" aria-hidden="true" tabindex="-1"></a>        json.dump(ground_downsampled_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-204"><a href="#cb55-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_downsampled_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-205"><a href="#cb55-205" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_downsampled_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-206"><a href="#cb55-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'no_last_submit_downsampled_metrics.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-207"><a href="#cb55-207" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_downsampled_metrics, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-208"><a href="#cb55-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">'model_config.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb55-209"><a href="#cb55-209" aria-hidden="true" tabindex="-1"></a>        json.dump(DEFAULT_CONFIG_downsampled, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-210"><a href="#cb55-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-211"><a href="#cb55-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the ground_horizon_utterances, no_last_horizon_utterances, and no_last_submit_horizon_utterances</span></span>
<span id="cb55-212"><a href="#cb55-212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"ground_horizon_utterances.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-213"><a href="#cb55-213" aria-hidden="true" tabindex="-1"></a>        json.dump(groun_horizon_downsampled, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-214"><a href="#cb55-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_horizon_utterances.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-215"><a href="#cb55-215" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_horizon_downsampled, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-216"><a href="#cb55-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(exp_dir <span class="op">/</span> <span class="st">"no_last_submit_horizon_utterances.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb55-217"><a href="#cb55-217" aria-hidden="true" tabindex="-1"></a>        json.dump(no_last_submit_horizon_downsampled, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb55-218"><a href="#cb55-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-219"><a href="#cb55-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # save your trained checkpoints</span></span>
<span id="cb55-220"><a href="#cb55-220" aria-hidden="true" tabindex="-1"></a>    checkpoint_ground_downsampled        <span class="op">=</span> model_ground_downsampled._model</span>
<span id="cb55-221"><a href="#cb55-221" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_last_downsampled       <span class="op">=</span> model_no_last_downsampled._model</span>
<span id="cb55-222"><a href="#cb55-222" aria-hidden="true" tabindex="-1"></a>    checkpoint_no_submit_last_downsampled <span class="op">=</span> model_no_submit_last_downsampled._model</span>
<span id="cb55-223"><a href="#cb55-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-224"><a href="#cb55-224" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_ground_downsampled,        exp_dir <span class="op">/</span> <span class="st">"ground_downsampled.pt"</span>)</span>
<span id="cb55-225"><a href="#cb55-225" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_last_downsampled,       exp_dir <span class="op">/</span> <span class="st">"no_last_downsampled.pt"</span>)</span>
<span id="cb55-226"><a href="#cb55-226" aria-hidden="true" tabindex="-1"></a>    torch.save(checkpoint_no_submit_last_downsampled,  exp_dir <span class="op">/</span> <span class="st">"no_submit_last_downsampled.pt"</span>)</span>
<span id="cb55-227"><a href="#cb55-227" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Experiment saved to </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="conversation-level-metrics-plotting-utility" class="level3">
<h3 class="anchored" data-anchor-id="conversation-level-metrics-plotting-utility">Conversation-Level Metrics Plotting Utility</h3>
<ul>
<li>(Derailment probability aggregated into 1 score for each conversation from all predicted utterances -&gt; assign forecast label)</li>
</ul>
<div id="cell-86" class="cell" data-cell_id="50877762813044fab0bc01746f915db7" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1" data-execution_start="1746807549676" data-source_hash="98402c51" data-execution_count="122">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Callable</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    roc_curve, roc_auc_score,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    precision_recall_curve, average_precision_score,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    ConfusionMatrixDisplay</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_best_threshold(y_true, y_score):</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the threshold that maximizes Youden's J = TPR − FPR.</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresh <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    youden <span class="op">=</span> tpr <span class="op">-</span> fpr</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    idx    <span class="op">=</span> np.argmax(youden)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresh[idx], tpr[idx], fpr[idx], youden[idx]</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_best_threshold(corpus, threshold,prob_key<span class="op">=</span> <span class="st">"pred_score"</span>, best_pred_key<span class="op">=</span> <span class="st">"best_prediction"</span>,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    best_label_key<span class="op">=</span> <span class="st">"best_forecast"</span>, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        any_pos <span class="op">=</span> <span class="va">False</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> convo.iter_utterances():</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key, <span class="fl">0.0</span>)</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>            pred  <span class="op">=</span> <span class="bu">int</span>(score <span class="op">&gt;=</span> threshold)</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>            utt.meta[best_pred_key] <span class="op">=</span> pred</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pred:</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>                any_pos <span class="op">=</span> <span class="va">True</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>        convo.meta[best_label_key] <span class="op">=</span> <span class="bu">int</span>(any_pos)</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> horizon(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>):</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>        comments_until_end <span class="op">=</span> {}</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations(selector):</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> selector(convo) <span class="kw">and</span> convo.meta[<span class="st">"best_forecast"</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.get_chronological_utterance_list()):</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>                    prediction <span class="op">=</span> utt.meta[<span class="st">"best_prediction"</span>]</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> prediction <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>                        comments_until_end[convo.<span class="bu">id</span>] <span class="op">=</span> (</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">len</span>(convo.get_chronological_utterance_list()) <span class="op">-</span> i</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> comments_until_end</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a><span class="co">"""Taken + modified from forecaster class"""</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize(corpus: Corpus, selector: Callable[[Conversation], <span class="bu">bool</span>] <span class="op">=</span> <span class="kw">lambda</span> convo: <span class="va">True</span>, threshold <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> corpus.get_conversations_dataframe(selector<span class="op">=</span>selector)</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>         <span class="co"># counts</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>        tp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>        fp <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">1</span>)).<span class="bu">sum</span>()</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>        tn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>        fn <span class="op">=</span> ((df[<span class="st">"meta.label"</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (df[<span class="st">"meta.best_forecast"</span>]<span class="op">==</span><span class="dv">0</span>)).<span class="bu">sum</span>()</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># accuracy is always well‑defined</span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>        acc <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precision, recall, fpr guard against zero‐denom</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>        recall    <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>        fpr       <span class="op">=</span> fp <span class="op">/</span> (fp <span class="op">+</span> tn) <span class="cf">if</span> (fp <span class="op">+</span> tn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># F1 = 2 * (precision * recall) / (precision + recall)</span></span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>        f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall) <span class="cf">if</span> (precision <span class="op">+</span> recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Accuracy"</span>:  acc,</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Precision"</span>: precision,</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Recall"</span>:    recall,</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FPR"</span>:       fpr,</span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"F1"</span>:        f1,</span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Threshold"</span>: threshold,}</span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_craft_models(corpora_info, split_key<span class="op">=</span><span class="st">"split"</span>, train_tag<span class="op">=</span><span class="st">"train"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>, best<span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a><span class="co">    corpora_info: list of (name, Corpus, metrics_dict, conv_df, horizon_dict)</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>    names, corpora, metrics_list, dfs, horizons <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>corpora_info)</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) avg lengths</span></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Avg. Conversation Length =="</span>)</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus <span class="kw">in</span> <span class="bu">zip</span>(names, corpora):</span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>        train_lens <span class="op">=</span> [</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>train_tag</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>        test_lens  <span class="op">=</span> [</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(conv.get_utterance_ids())</span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> conv <span class="kw">in</span> corpus.iter_conversations()</span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> conv.meta.get(split_key)<span class="op">==</span>test_tag</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss">  train=</span><span class="sc">{</span>np<span class="sc">.</span>mean(train_lens)<span class="sc">:.1f}</span><span class="ss">  test=</span><span class="sc">{</span>np<span class="sc">.</span>mean(test_lens)<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) metrics table</span></span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Test Metrics =="</span>)</span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics_list, index<span class="op">=</span>names)</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) horizon histograms</span></span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>    all_vals   <span class="op">=</span> np.concatenate([<span class="bu">list</span>(h.values()) <span class="cf">for</span> h <span class="kw">in</span> horizons])</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>    global_max <span class="op">=</span> <span class="bu">int</span>(all_vals.<span class="bu">max</span>()) <span class="cf">if</span> all_vals.size <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>    bins       <span class="op">=</span> np.arange(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>    fig, axes  <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name, hor <span class="kw">in</span> <span class="bu">zip</span>(axes, names, horizons):</span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(hor.values()))</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# comments after first+forecast"</span>)</span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, global_max<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>,<span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>vals<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>np<span class="sc">.</span>median(vals)<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) merge conversation‑level dfs</span></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> dfs[<span class="dv">0</span>][[<span class="st">'label'</span>,<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, df <span class="kw">in</span> <span class="bu">zip</span>(names[<span class="dv">1</span>:], dfs[<span class="dv">1</span>:]):</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merged.join(</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>            df[[<span class="st">'score'</span>,<span class="st">'forecast'</span>]].rename(</span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>{<span class="st">'score'</span>:<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>,<span class="st">'forecast'</span>:<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>            ), how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5) calibration + probability histogram</span></span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a>    fig, (ax_cal, ax_hist) <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a>        CalibrationDisplay.from_predictions(</span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>            y_prob<span class="op">=</span>merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>            n_bins<span class="op">=</span><span class="dv">10</span>, name<span class="op">=</span>name, ax<span class="op">=</span>ax_cal</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>    ax_cal.set_title(<span class="st">"Calibration Curves"</span>)<span class="op">;</span> ax_cal.grid(<span class="va">True</span>)</span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>    bins_prob <span class="op">=</span> np.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">11</span>)</span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>        ax_hist.hist(merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>], bins<span class="op">=</span>bins_prob,</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span>name, edgecolor<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_title(<span class="st">"Probability Histogram"</span>)</span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_xlabel(<span class="st">"Predicted probability"</span>)</span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a>    ax_hist.set_ylabel(<span class="st">"Count of convos"</span>)</span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a>    ax_hist.legend()<span class="op">;</span> ax_hist.grid(<span class="va">True</span>)</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6) confusion matrices</span></span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names),<span class="dv">4</span>))</span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>merged[<span class="st">'label'</span>],</span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Success"</span>,<span class="st">"Impasse"</span>],</span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7) ROC &amp; PR curves + find best thresholds</span></span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> {}</span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {}</span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a>    corpora <span class="op">=</span> {}</span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ROC</span></span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> merged[<span class="st">'label'</span>]</span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a>        y_score<span class="op">=</span> merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>        fpr, tpr, _ <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> roc_auc_score(y_true, y_score)</span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>        plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AUC=</span><span class="sc">{</span>auc<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>        thr, t, f, j <span class="op">=</span> find_best_threshold(y_true, y_score)</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a>        thresholds[name] <span class="op">=</span> thr</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:20s}</span><span class="ss"> best thr=</span><span class="sc">{</span>thr<span class="sc">:.3f}</span><span class="ss">, TPR=</span><span class="sc">{</span>t<span class="sc">:.3f}</span><span class="ss">, FPR=</span><span class="sc">{</span>f<span class="sc">:.3f}</span><span class="ss">, J=</span><span class="sc">{</span>j<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">'k--'</span>)</span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"ROC Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"FPR"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"TPR"</span>)<span class="op">;</span> plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-188"><a href="#cb56-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">#annotate corpora with best prediction:</span></span>
<span id="cb56-189"><a href="#cb56-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, corpus, <span class="op">*</span>_ <span class="kw">in</span> corpora_info:</span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">not</span> <span class="kw">in</span> thresholds:</span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"No threshold provided for model </span><span class="sc">{</span>name<span class="sc">!r}</span><span class="ss">"</span>)</span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>        apply_best_threshold(corpus, thresholds[name],  selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>)</span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create best metrics</span></span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a>        metrics[name] <span class="op">=</span> summarize(corpus, selector <span class="op">=</span><span class="kw">lambda</span> convo: convo.meta.get(<span class="st">"split"</span>) <span class="op">==</span> <span class="st">"test"</span>, threshold<span class="op">=</span>thresholds[name])</span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a>        corpora[name] <span class="op">=</span> corpus</span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PR</span></span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>        prec, rec, _ <span class="op">=</span> precision_recall_curve(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a>        ap <span class="op">=</span> average_precision_score(merged[<span class="st">'label'</span>], merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>])</span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a>        plt.plot(rec, prec, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (AP=</span><span class="sc">{</span>ap<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Precision–Recall Curves"</span>)<span class="op">;</span> plt.xlabel(<span class="st">"Recall"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"Precision"</span>)</span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a>    plt.legend()<span class="op">;</span> plt.grid(<span class="va">True</span>)</span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-208"><a href="#cb56-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8) summary table</span></span>
<span id="cb56-209"><a href="#cb56-209" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> {</span>
<span id="cb56-210"><a href="#cb56-210" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_acc"</span>:      (merged[<span class="st">'label'</span>]<span class="op">==</span>merged[<span class="ss">f'forecast_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>]).mean()</span>
<span id="cb56-211"><a href="#cb56-211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb56-212"><a href="#cb56-212" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-213"><a href="#cb56-213" aria-hidden="true" tabindex="-1"></a>    summary.update({</span>
<span id="cb56-214"><a href="#cb56-214" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_avg_prob"</span>: merged[<span class="ss">f'score_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">'</span>].mean()</span>
<span id="cb56-215"><a href="#cb56-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> names</span>
<span id="cb56-216"><a href="#cb56-216" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb56-217"><a href="#cb56-217" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Summary of Convo Acc &amp; Avg Prob =="</span>)</span>
<span id="cb56-218"><a href="#cb56-218" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame(summary, index<span class="op">=</span>[<span class="st">"conversation_level"</span>]))</span>
<span id="cb56-219"><a href="#cb56-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-220"><a href="#cb56-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> thresholds, metrics, corpora</span>
<span id="cb56-221"><a href="#cb56-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-222"><a href="#cb56-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-223"><a href="#cb56-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-224"><a href="#cb56-224" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_best_models(thresholds, metrics, corpora, split_key <span class="op">=</span> <span class="st">"split"</span>, test_tag <span class="op">=</span> <span class="st">"test"</span>):</span>
<span id="cb56-225"><a href="#cb56-225" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(corpora.keys())</span>
<span id="cb56-226"><a href="#cb56-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) metrics table</span></span>
<span id="cb56-227"><a href="#cb56-227" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"== Conversation‑level Best Threshold Test Set Metrics =="</span>)</span>
<span id="cb56-228"><a href="#cb56-228" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame(metrics, index<span class="op">=</span><span class="bu">list</span>(metrics.values())[<span class="dv">0</span>].keys()).T</span>
<span id="cb56-229"><a href="#cb56-229" aria-hidden="true" tabindex="-1"></a>    display(metrics_df)</span>
<span id="cb56-230"><a href="#cb56-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-231"><a href="#cb56-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) confusion matrices</span></span>
<span id="cb56-232"><a href="#cb56-232" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">4</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>))</span>
<span id="cb56-233"><a href="#cb56-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb56-234"><a href="#cb56-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-235"><a href="#cb56-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb56-236"><a href="#cb56-236" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-237"><a href="#cb56-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collect true/test only</span></span>
<span id="cb56-238"><a href="#cb56-238" aria-hidden="true" tabindex="-1"></a>        conv_df <span class="op">=</span> corpora[name].get_conversations_dataframe().reset_index()</span>
<span id="cb56-239"><a href="#cb56-239" aria-hidden="true" tabindex="-1"></a>        test_df <span class="op">=</span> conv_df[conv_df[<span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>] <span class="op">==</span> test_tag]</span>
<span id="cb56-240"><a href="#cb56-240" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> test_df[<span class="st">"meta.label"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb56-241"><a href="#cb56-241" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> test_df[<span class="st">"meta.best_forecast"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb56-242"><a href="#cb56-242" aria-hidden="true" tabindex="-1"></a>        ConfusionMatrixDisplay.from_predictions(</span>
<span id="cb56-243"><a href="#cb56-243" aria-hidden="true" tabindex="-1"></a>            y_true<span class="op">=</span>y_true,</span>
<span id="cb56-244"><a href="#cb56-244" aria-hidden="true" tabindex="-1"></a>            y_pred<span class="op">=</span>y_pred,</span>
<span id="cb56-245"><a href="#cb56-245" aria-hidden="true" tabindex="-1"></a>            display_labels<span class="op">=</span>[<span class="st">"Impasse"</span>,<span class="st">"Success"</span>],</span>
<span id="cb56-246"><a href="#cb56-246" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb56-247"><a href="#cb56-247" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax</span>
<span id="cb56-248"><a href="#cb56-248" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-249"><a href="#cb56-249" aria-hidden="true" tabindex="-1"></a>        ax.set_title(name)</span>
<span id="cb56-250"><a href="#cb56-250" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb56-251"><a href="#cb56-251" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb56-252"><a href="#cb56-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-253"><a href="#cb56-253" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) forecast‑horizon histograms</span></span>
<span id="cb56-254"><a href="#cb56-254" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span><span class="bu">len</span>(names), <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-255"><a href="#cb56-255" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(names)<span class="op">==</span><span class="dv">1</span>: axes<span class="op">=</span>[axes]</span>
<span id="cb56-256"><a href="#cb56-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-257"><a href="#cb56-257" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute global max horizon to align bins</span></span>
<span id="cb56-258"><a href="#cb56-258" aria-hidden="true" tabindex="-1"></a>    all_horizons <span class="op">=</span> []</span>
<span id="cb56-259"><a href="#cb56-259" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb56-260"><a href="#cb56-260" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb56-261"><a href="#cb56-261" aria-hidden="true" tabindex="-1"></a>        all_horizons.extend(h.values())</span>
<span id="cb56-262"><a href="#cb56-262" aria-hidden="true" tabindex="-1"></a>    max_h <span class="op">=</span> <span class="bu">int</span>(<span class="bu">max</span>(all_horizons)) <span class="cf">if</span> all_horizons <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb56-263"><a href="#cb56-263" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> np.arange(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb56-264"><a href="#cb56-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-265"><a href="#cb56-265" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, name <span class="kw">in</span> <span class="bu">zip</span>(axes, names):</span>
<span id="cb56-266"><a href="#cb56-266" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> horizon(corpora[name], selector<span class="op">=</span><span class="kw">lambda</span> c: c.meta.get(split_key)<span class="op">==</span>test_tag)</span>
<span id="cb56-267"><a href="#cb56-267" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> np.array(<span class="bu">list</span>(h.values()))</span>
<span id="cb56-268"><a href="#cb56-268" aria-hidden="true" tabindex="-1"></a>        ax.hist(vals, bins<span class="op">=</span>bins, density<span class="op">=</span><span class="va">True</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>)</span>
<span id="cb56-269"><a href="#cb56-269" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Forecast Horizon"</span>)</span>
<span id="cb56-270"><a href="#cb56-270" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"# utts after first + forecast"</span>)</span>
<span id="cb56-271"><a href="#cb56-271" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">1</span>, max_h<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb56-272"><a href="#cb56-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="kw">is</span> axes[<span class="dv">0</span>]:</span>
<span id="cb56-273"><a href="#cb56-273" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">"Percent of convos"</span>)</span>
<span id="cb56-274"><a href="#cb56-274" aria-hidden="true" tabindex="-1"></a>        m, md <span class="op">=</span> vals.mean() <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span>, np.median(vals) <span class="cf">if</span> vals.size <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb56-275"><a href="#cb56-275" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">.05</span>, <span class="fl">.85</span>, <span class="ss">f"μ=</span><span class="sc">{</span>m<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">med=</span><span class="sc">{</span>md<span class="sc">:.1f}</span><span class="ss">"</span>,</span>
<span id="cb56-276"><a href="#cb56-276" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb56-277"><a href="#cb56-277" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb56-278"><a href="#cb56-278" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="forecast-probability-trends" class="level3">
<h3 class="anchored" data-anchor-id="forecast-probability-trends">Forecast Probability Trends</h3>
<div id="cell-88" class="cell" data-cell_id="2e60798ff3884b949230b61063097855" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="1" data-execution_start="1746809438676" data-source_hash="81580ad6" data-execution_count="212">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_position_score_evolution_by_outcome(</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    corpus, split_key<span class="op">=</span><span class="st">"split"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    prob_key<span class="op">=</span><span class="st">"pred_score"</span>, name<span class="op">=</span><span class="va">None</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    pos_scores <span class="op">=</span> {<span class="dv">0</span>: defaultdict(<span class="bu">list</span>), <span class="dv">1</span>: defaultdict(<span class="bu">list</span>)}</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> convo <span class="kw">in</span> corpus.iter_conversations():</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> convo.meta.get(split_key) <span class="op">!=</span> test_tag:</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        lbl <span class="op">=</span> convo.meta.get(<span class="st">"label"</span>)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p, utt <span class="kw">in</span> <span class="bu">enumerate</span>(convo.iter_utterances(), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> utt.meta.get(prob_key)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>                pos_scores[lbl][p].append(score)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    overall_max_pos <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>(d.keys()) <span class="cf">for</span> d <span class="kw">in</span> pos_scores.values() <span class="cf">if</span> d</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> <span class="bu">any</span>(pos_scores.values()) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    fig.subplots_adjust(left<span class="op">=</span><span class="fl">0.05</span>, right<span class="op">=</span><span class="fl">0.80</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ix, lbl <span class="kw">in</span> <span class="bu">enumerate</span>((<span class="dv">0</span>, <span class="dv">1</span>), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">2</span>, ix, projection<span class="op">=</span><span class="st">'3d'</span>)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> np.arange(<span class="dv">1</span>, overall_max_pos <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> [</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>            np.mean(pos_scores[lbl].get(p, [])) <span class="cf">if</span> pos_scores[lbl].get(p)</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> X</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> X</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># force colormap and scatter scale to 0→1</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>        sc <span class="op">=</span> ax.scatter(</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>            X, Y, Z,</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span>Y, cmap<span class="op">=</span><span class="st">'viridis'</span>,</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, Z, color<span class="op">=</span><span class="st">'black'</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>        ax.plot(X, Y, zs<span class="op">=</span><span class="dv">0</span>, zdir<span class="op">=</span><span class="st">'z'</span>, color<span class="op">=</span><span class="st">'gray'</span>, ls<span class="op">=</span><span class="st">'--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> xi, yi, zi <span class="kw">in</span> <span class="bu">zip</span>(X, Y, Z):</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>            ax.plot([xi, xi], [yi, yi], [<span class="dv">0</span>, zi],</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, lw<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Utterance Position"</span>)</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Mean Predicted Probability"</span>)</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>        ax.set_zlabel(<span class="st">"Conversation Length so far"</span>)</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)                      <span class="co"># &lt;— lock the probability axis</span></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>        title_lbl <span class="op">=</span> <span class="st">"Successful"</span> <span class="cf">if</span> lbl <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"Impasse"</span></span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title_lbl<span class="sc">}</span><span class="ss"> (label=</span><span class="sc">{</span>lbl<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add colorbar to its own axes on the far right</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    cbar_ax <span class="op">=</span> fig.add_axes([<span class="fl">0.82</span>, <span class="fl">0.15</span>, <span class="fl">0.02</span>, <span class="fl">0.7</span>])</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>    cb <span class="op">=</span> fig.colorbar(sc, cax<span class="op">=</span>cbar_ax)</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>    cb.set_label(<span class="st">"Avg. Probability"</span>)</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name:</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Evolution of Model Confidence by Turn for </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="fl">0.95</span>, fontsize<span class="op">=</span><span class="dv">14</span></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_utterances_df(corpus, split_key<span class="op">=</span><span class="st">"split"</span>, test_tag<span class="op">=</span><span class="st">"test"</span>):</span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>    utts <span class="op">=</span> corpus.get_utterances_dataframe()  <span class="co"># contains columns like ['id','conversation_id','text',…]</span></span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>    convs <span class="op">=</span> corpus.get_conversations_dataframe()  <span class="co"># index is conversation_id, has 'meta.split'</span></span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    convs <span class="op">=</span> convs.reset_index().rename(</span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{ <span class="st">"id"</span>: <span class="st">"conversation_id"</span>, <span class="ss">f"meta.</span><span class="sc">{</span>split_key<span class="sc">}</span><span class="ss">"</span>: <span class="st">"split"</span> }</span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>    )[[ <span class="st">"conversation_id"</span>, <span class="st">"split"</span> ]]</span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.merge(</span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a>        utts,</span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>        convs,</span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"conversation_id"</span>,</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>    test_utts <span class="op">=</span> merged[ merged[<span class="st">"split"</span>] <span class="op">==</span> test_tag ].drop(columns<span class="op">=</span>[<span class="st">"split"</span>])</span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_utts</span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-data" class="level3">
<h3 class="anchored" data-anchor-id="load-data">Load Data</h3>
<div id="cell-90" class="cell" data-cell_id="b82bf22e2d24441283998c25fa767e39" data-deepnote_cell_type="code" data-execution_context_id="d5782876-af6f-413e-b5d8-c3f2e2d161be" data-execution_millis="27470" data-execution_start="1746806148226" data-source_hash="7b71882f" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>downsampled_res  <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/downsampled/run_20250509_102130'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>nosampling_res   <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/nosampling/run_20250509_090059'</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>weighted_res     <span class="op">=</span> Path(<span class="st">'/work/data/fine_tuning_results/nosampling_weighted/run_20250509_015048'</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">#/work/data/fine_tuning_results/nosampling/run_20250509_090059/corpus_kodis_ground_default</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_artifact(exp_dir: Path, name: <span class="bu">str</span>):</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> exp_dir <span class="op">/</span> name</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.json'</span>)).exists():</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.loads((p.with_suffix(<span class="st">'.json'</span>)).read_text())</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.csv'</span>)).exists():</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(p.with_suffix(<span class="st">'.csv'</span>))</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p.is_dir():</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Corpus(filename<span class="op">=</span> <span class="bu">str</span>(p))</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p.with_suffix(<span class="st">'.pt'</span>)).exists():</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.load(p.with_suffix(<span class="st">'.pt'</span>))</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"No artifact </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span>exp_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_all_variants(exp_dir: Path):</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># detect which naming scheme this folder uses</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_downsampled"</span>).is_dir():</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"downsampled"</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> (exp_dir <span class="op">/</span> <span class="st">"corpus_kodis_ground_weighted_loss"</span>).is_dir():</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"weighted"</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        variant <span class="op">=</span> <span class="st">"default"</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build name‐templates</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    tpl <span class="op">=</span> {</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"downsampled"</span>: {</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_downsampled"</span>,</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_downsampled_conv_df"</span>,</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_downsampled_metrics"</span>,</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_horizon_utterances"</span>,</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_downsampled",</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_downsampled"</span>,</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_downsampled_conv_df"</span>,</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_downsampled_metrics"</span>,</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_horizon_utterances"</span>,</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_downsampled",</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_last_submit_downsampled"</span>,</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_downsampled_conv_df"</span>,</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_downsampled_metrics"</span>,</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_horizon_utterances"</span>,</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_downsampled",</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weighted"</span>: {</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_weighted_loss"</span>,</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_weight_conv_df"</span>,</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_weighted_metrics"</span>,</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_weight_horizon"</span>,</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_weighted",</span></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_weighted_loss"</span>,</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"nolast_weight_conv_df"</span>,</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_weighted_metrics"</span>,</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_weight_horizon"</span>,</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_weighted",</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_weighted_loss"</span>,</span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_submit_last_weight_conv_df"</span>,</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_weighted_metrics"</span>,</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_weight_horizon"</span>,</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_submit_last_weighted",</span></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"default"</span>: {</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_corpus"</span>:   <span class="st">"corpus_kodis_ground_default"</span>,</span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_df"</span>:       <span class="st">"ground_conv_default_df"</span>,</span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_metrics"</span>:  <span class="st">"ground_default_metrics"</span>,</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ground_horizon"</span>:  <span class="st">"ground_default_horizon"</span>,</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "ground_chkpt":    "ground_default",</span></span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_corpus"</span>:  <span class="st">"corpus_kodis_no_last_default"</span>,</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_df"</span>:      <span class="st">"no_last_conv_df_default"</span>,</span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_metrics"</span>: <span class="st">"no_last_default_metrics"</span>,</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_last_horizon"</span>: <span class="st">"no_last_default_horizon"</span>,</span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_last_chkpt":   "no_last_default",</span></span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_corpus"</span>:  <span class="st">"corpus_kodis_no_submit_last_default"</span>,</span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_df"</span>:      <span class="st">"no_last_submit_conv_default_df"</span>,</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_metrics"</span>: <span class="st">"no_last_submit_default_metrics"</span>,</span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no_subm_horizon"</span>: <span class="st">"no_last_submit_default_horizon"</span>,</span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "no_subm_chkpt":   "no_last_submit_last_default",</span></span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a>    }[variant]</span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>        key: load_artifact(exp_dir, fname)</span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, fname <span class="kw">in</span> tpl.items()</span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Now load each regime:</span></span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>down <span class="op">=</span> load_all_variants(downsampled_res)</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a>no_samp <span class="op">=</span> load_all_variants(nosampling_res)</span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a>wt <span class="op">=</span> load_all_variants(weighted_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><a style="text-decoration:none;line-height:16px;display:flex;color:#5B5B62;padding:10px;justify-content:end;" href="https://deepnote.com?utm_source=created-in-deepnote-cell&amp;projectId=3310cee6-b01b-482a-ad87-e3d6d3c746dc" target="_blank"> <img alt="Created in deepnote.com" style="display:inline;max-height:16px;margin:0px;margin-right:7.5px;" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iODBweCIgaGVpZ2h0PSI4MHB4IiB2aWV3Qm94PSIwIDAgODAgODAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDU0LjEgKDc2NDkwKSAtIGh0dHBzOi8vc2tldGNoYXBwLmNvbSAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IkxhbmRpbmciIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJBcnRib2FyZCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEyMzUuMDAwMDAwLCAtNzkuMDAwMDAwKSI+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0zIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjM1LjAwMDAwMCwgNzkuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0yMCIgZmlsbD0iIzAyNjVCNCIgcG9pbnRzPSIyLjM3NjIzNzYyIDgwIDM4LjA0NzY2NjcgODAgNTcuODIxNzgyMiA3My44MDU3NTkyIDU3LjgyMTc4MjIgMzIuNzU5MjczOSAzOS4xNDAyMjc4IDMxLjY4MzE2ODMiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0zNS4wMDc3MTgsODAgQzQyLjkwNjIwMDcsNzYuNDU0OTM1OCA0Ny41NjQ5MTY3LDcxLjU0MjI2NzEgNDguOTgzODY2LDY1LjI2MTk5MzkgQzUxLjExMjI4OTksNTUuODQxNTg0MiA0MS42NzcxNzk1LDQ5LjIxMjIyODQgMjUuNjIzOTg0Niw0OS4yMTIyMjg0IEMyNS40ODQ5Mjg5LDQ5LjEyNjg0NDggMjkuODI2MTI5Niw0My4yODM4MjQ4IDM4LjY0NzU4NjksMzEuNjgzMTY4MyBMNzIuODcxMjg3MSwzMi41NTQ0MjUgTDY1LjI4MDk3Myw2Ny42NzYzNDIxIEw1MS4xMTIyODk5LDc3LjM3NjE0NCBMMzUuMDA3NzE4LDgwIFoiIGlkPSJQYXRoLTIyIiBmaWxsPSIjMDAyODY4Ij48L3BhdGg+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMCwzNy43MzA0NDA1IEwyNy4xMTQ1MzcsMC4yNTcxMTE0MzYgQzYyLjM3MTUxMjMsLTEuOTkwNzE3MDEgODAsMTAuNTAwMzkyNyA4MCwzNy43MzA0NDA1IEM4MCw2NC45NjA0ODgyIDY0Ljc3NjUwMzgsNzkuMDUwMzQxNCAzNC4zMjk1MTEzLDgwIEM0Ny4wNTUzNDg5LDc3LjU2NzA4MDggNTMuNDE4MjY3Nyw3MC4zMTM2MTAzIDUzLjQxODI2NzcsNTguMjM5NTg4NSBDNTMuNDE4MjY3Nyw0MC4xMjg1NTU3IDM2LjMwMzk1NDQsMzcuNzMwNDQwNSAyNS4yMjc0MTcsMzcuNzMwNDQwNSBDMTcuODQzMDU4NiwzNy43MzA0NDA1IDkuNDMzOTE5NjYsMzcuNzMwNDQwNSAwLDM3LjczMDQ0MDUgWiIgaWQ9IlBhdGgtMTkiIGZpbGw9IiMzNzkzRUYiPjwvcGF0aD4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+">  Created in <span style="font-weight:600;margin-left:4px;">Deepnote</span></a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>